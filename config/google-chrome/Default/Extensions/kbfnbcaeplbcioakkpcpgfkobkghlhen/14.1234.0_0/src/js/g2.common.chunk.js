(self.webpackChunk=self.webpackChunk||[]).push([[274],{14720:(e,t,i)=>{var r=i(76356),n="chrome-extension://__MSG_@@extension_id__/",a="moz-extension://__MSG_@@extension_id__/",s="safari-web-extension://__MSG_@@extension_id__/",o=self.GR_RESOURCE_ROOT||n,l=self.GR_RESOURCE_ROOT||a,d=self.GR_RESOURCE_ROOT||s;e.exports={__css:r.toString().replace(new RegExp(n,"g"),o).replace(new RegExp(a,"g"),l).replace(new RegExp(s,"g"),d),...r.locals}},13556:(e,t,i)=>{i.r(t),i.d(t,{G2FeatureImpl:()=>Gi});var r=i(90023),n=i(49231),a=i(13391),s=i(32073),o=i(68340),l=i(20161),d=i(90572),c=i(84178),h=i(24666),u=i(81446),g=i(58303),m=i(84358),p=i(40455),v=i(45013),f=i(48838),S=i(56218),w=i(85111),b=i(88657),_=i(95804),y=i(88030),C=i(30910),k=i(44071),x=i(29416),R=i(29479),B=i(82377),E=i(10140),I=i(11669);function T(e){let t=I.PA+I.gK/2;const i=e.scrollMirrorRectInViewport.left+t;return e.textStartPositionInViewport-i>3*I.l7?t=e.textStartPositionInViewport-e.scrollMirrorRectInViewport.left-I.l7:e.scrollMirrorRectInViewport.left+t+I.TM+I.gK>e.textStartPositionInViewport&&(t=I.PA/2),e.scrollMirrorRectInViewport.left+t<0&&(e.textStartPositionInViewport>=I.l7?t=-e.scrollMirrorRectInViewport.left+I.PA/2:e.textStartPositionInViewport>=I.t&&(t=-e.scrollMirrorRectInViewport.left-I.PA/2)),{top:e.vBarTextRectInMirror.top,left:t,width:e.scrollMirrorRectInViewport.width-t,height:e.vBarTextRectInMirror.height}}function P(e){let t=I.PA+I.gK/2;return t+I.TM+I.gK>e.vBarTextRectInMirror.left&&(t=I.PA),{top:e.vBarTextRectInMirror.top,left:t,width:e.scrollMirrorRectInViewport.width-t,height:e.vBarTextRectInMirror.height}}function F(e){return{kind:"sessionText",rev:Number.MIN_SAFE_INTEGER,range:e}}var M=i(954),L=i(59179),D=i(9273),A=i(41048),z=i(39363);function O(e,t){return e.pipe(M.O(null),L.U((()=>(0,r.zG)(t.getCurrentSelection(!0),z.Ls,g.ij,g.hX((0,r.ff)(A.SV.isCollapsed))))),D.skipBy(g.Eh(A.SV.eq)))}function G(e){const t=e.mirrorElement.getBoundingClientRect(),i=e.boundariesElement.getBoundingClientRect(),r=t.left-i.left;return{top:e.originalOffset.top,left:e.originalOffset.left-r}}function U(e){return{width:e.boundariesElement.getBoundingClientRect().width,height:e.originalSize.height}}var H=i(57866),q=i(59833),V=i(71497),N=i(45246);function j(e){var t,i;const r=(0,V.o)(e),n=null!==(t=(0,N.a2)(r.paddingLeft))&&void 0!==t?t:0,a=null!==(i=(0,N.a2)(r.borderLeftWidth))&&void 0!==i?i:0;return e.getBoundingClientRect().left+n+a}function W(e){return"TEXTAREA"===e.tagName||"INPUT"===e.tagName?j(e):function(e){const t=[...e.querySelectorAll("p, h1, h2, h3")].filter((e=>e.getBoundingClientRect().height>0));return(0,r.zG)(t,q.YM,g.g_((()=>j(e)),(e=>e.getBoundingClientRect().left)))}(e)}function $(e){return function(e){const{textFieldElement:t,isIFrameTextField:i,positionedAncestor:r,getSize:n,getOffset:s,adjustSizeBeforeRendering:o,adjustOffsetBeforeRendering:l}=e,d=(0,H.hI)(t,r),c=a.h.create({width:0,height:0}),h=a.h.create({top:0,left:0});let u={};return 0===d.length&&(u={getFieldSize:n,getPaddingRectSize:n,getFieldOffset:s}),{textField:(0,H.Iy)(t,d[0]||r,i,u),scrollables:d.map(((e,t,i)=>(0,H.fR)(e,i[t+1]||r,!1,void 0,t===i.length-1?n:void 0,t===i.length-1?s:void 0))),rect:a.h.combine(c,h,((e,t)=>{const i=r.getBoundingClientRect();return{top:i.top+t.top,left:i.left+t.left,width:e.width,height:e.height}})),adjustSizeBeforeRendering:e=>{const t=o(e);return c.set(t),t},adjustOffsetBeforeRendering:e=>{const t=l(e);return h.set(t),t},textStartPosition:a.h.combine(c,h,(()=>W(t)))}}({textFieldElement:e.textFieldElement,isIFrameTextField:e.integrationInfo.isInsideIFrame,positionedAncestor:e.injectionPlace,getSize:(t,i)=>{var r,n;return null!==(n=null===(r=e.getSize)||void 0===r?void 0:r.call(e,t,i))&&void 0!==n?n:i},getOffset:(t,i)=>{var r,n;return null!==(n=null===(r=e.getOffset)||void 0===r?void 0:r.call(e,t,i))&&void 0!==n?n:i},adjustSizeBeforeRendering:e=>({width:e.width+I.l7,height:e.height}),adjustOffsetBeforeRendering:e=>({top:e.top,left:e.left-I.l7})})}var Y=i(64297);function K(e){var t;switch(e.integrationInfo.kind){case"jiraProseMirror":case"redditContentEditable":case"outlook":case"salesforce":return e.textFieldElement;case"contentEditable":case"gmail":case"googleChat":case"googleDocsComments":case"iframe":case"textarea":case"twitterDraftJS":case"hubspot":case"zendesk":case"freshdesk":return e.mirrorElement;case"whatsapp":case"confluenceEditor":{const i=null===(t=e.mirrorElement.parentElement)||void 0===t?void 0:t.parentElement;return i||e.mirrorElement}default:(0,Y.L0)(e.integrationInfo)}}function Q(e){switch(e.integrationInfo.kind){case"gmail":return g.G({visibility:"visible",zIndex:1e3});case"googleChat":return g.G({zIndex:10});case"twitterDraftJS":return g.G({zIndex:1});case"hubspot":return g.G({zIndex:4});case"zendesk":return g.G({left:"-16px",zIndex:100});case"salesforce":return g.G({left:"-15px"});case"freshdesk":return g.G({left:"-9px"});case"outlook":case"contentEditable":case"googleDocsComments":case"iframe":case"textarea":case"jiraProseMirror":case"redditContentEditable":case"whatsapp":case"confluenceEditor":return g.YP;default:(0,Y.L0)(e.integrationInfo)}}class X{constructor(e){this._params=e,this._logger=(0,C.h)(X.name),this._subs=new s.w0,this._selectionRange=a.h.create(g.YP),this._vBarsInjectionPlace=function(e){const t=W(e.textFieldElement)-I.l7;return(0,V.E6)(e.textFieldElement,(e=>!!(0,V.XQ)(e)&&e.getBoundingClientRect().left<=t))}({textFieldElement:this._params.highlightsLayoutInfo.textFieldElement}),this._vBarsScrollMirrorLayout=$({textFieldElement:this._params.highlightsLayoutInfo.textFieldElement,injectionPlace:this._vBarsInjectionPlace,integrationInfo:this._params.integrationInfo,getSize:(e,t)=>U({boundariesElement:K({integrationInfo:this._params.integrationInfo,textFieldElement:this._params.highlightsLayoutInfo.textFieldElement,mirrorElement:e}),originalSize:t}),getOffset:(e,t)=>G({mirrorElement:e,boundariesElement:K({integrationInfo:this._params.integrationInfo,textFieldElement:this._params.highlightsLayoutInfo.textFieldElement,mirrorElement:e}),originalOffset:t})}),this._documentElement=(0,E.cL)(this._params.highlightsLayoutInfo.textFieldElement)&&this._params.highlightsLayoutInfo.textFieldElement.contentDocument?this._params.highlightsLayoutInfo.textFieldElement.contentDocument:this._params.highlightsLayoutInfo.textFieldElement.ownerDocument,this.info=this._params.integrationInfo,this.highlightGeometryFilter=B.qH.everything,this.highlightGeometryInvalidator=(0,B.WF)(this._params.highlightsLayoutInfo.textFieldLayout),this.selectionRange=this._selectionRange.view(),this.isEnabled=a.h.create(!0),this.textRangeFilter=r.W8,this.additionalGlobalEventSource={scroll:(0,E.cL)(this._params.highlightsLayoutInfo.textFieldElement)&&this._params.highlightsLayoutInfo.textFieldElement.contentWindow?this._params.highlightsLayoutInfo.textFieldElement.contentWindow:void 0,click:this._documentElement},this.highlightsLayoutInfo=this._params.highlightsLayoutInfo,this.vBarsLayoutInfo={injectionPlace:this._vBarsInjectionPlace,scrollMirrorContainerStyleOverrides:g.FS(Q({integrationInfo:this._params.integrationInfo})),scrollMirrorLayout:this._vBarsScrollMirrorLayout},this.selectionOrCaretPosition=this._params.selectionOrCaretPosition,this.getVBarHighlightRect=(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsPositioningFixes)?T:P,this._subs.add(O(k.R(this._documentElement,"selectionchange").pipe(x.b(100),R.h(void 0)),this._params.selectionService).subscribe(u.wW(this._selectionRange)))}getRewriteScope(e){return F(e.vBar.textRange)}dispose(){this._subs.unsubscribe()}getKeyboardEventsTarget(){return document.body}}var J=i(61179),Z=i(84308),ee=i(5588),te=i(64271),ie=i(14393),re=i(30003),ne=i(7936),ae=i(42671),se=i(73734),oe=i(14698);const le=({textRange:e,fullText:t})=>{let i=e.start;for(;i<=e.end;){if(t.charAt(i)===oe.$O||t.charAt(i)===oe.Mx)return!0;i++}for(i=e.start;i>=0;){if(t.charAt(i)===oe.Mx)return!1;if(t.charAt(i)===oe.$O)return!0;i--}return!1};var de=i(671);function ce(e){const t=e.mirrorElement.querySelector(de.yw)||e.mirrorElement.ownerDocument.documentElement.querySelector(".kix-scrollareadocumentplugin");return t||(e.telemetryService.error({message:"Failed to retrieve proper vBars scroll mirror boundaries element on Google Docs."}),e.mirrorElement)}class he{constructor(e){this._params=e,this._subs=new s.w0,this._logger=(0,C.h)(he.name),this._highlightCollectionFilterSource=new re.b(this._params.textObserver),this._selectionRange=a.h.create(g.YP),this._vBarsInjectionPlace=function(e){const t=e.textFieldElement.ownerDocument;return t.getElementById("kix-appview")||(e.telemetryService.error({message:"Failed to retrieve proper injection place for vBars in Google Docs; will inject in the root of the HTML."}),t.documentElement)}({textFieldElement:this._params.highlightsLayoutInfo.textFieldElement,telemetryService:this._params.telemetryService}),this._vBarsScrollMirrorLayout=$({textFieldElement:this._params.highlightsLayoutInfo.textFieldElement,injectionPlace:this._vBarsInjectionPlace,integrationInfo:this._params.integrationInfo,getSize:(e,t)=>U({boundariesElement:ce({mirrorElement:e,telemetryService:this._params.telemetryService}),originalSize:t}),getOffset:(e,t)=>G({mirrorElement:e,boundariesElement:ce({mirrorElement:e,telemetryService:this._params.telemetryService}),originalOffset:t})}),this.info=this._params.integrationInfo,this.highlightGeometryFilter=this._highlightCollectionFilterSource.highlightsFilterFactory(),this.highlightGeometryInvalidator=Z.a([this._params.highlightsLayoutInfo.textFieldLayout.rect.changes.pipe(M.O(this._params.highlightsLayoutInfo.textFieldLayout.rect.getCurrent())),this._params.highlightsLayoutInfo.textFieldLayout.scroll.changes.pipe(M.O(this._params.highlightsLayoutInfo.textFieldLayout.scroll.getCurrent()))]).pipe(ee.D((()=>this._params.textObserver.textMapChanged))),this.selectionRange=this._selectionRange.view(),this.isEnabled=this._params.integrationInfo.integrationMode.view((e=>e===ie.yj.write)),this.textRangeFilter=(0,J.ff)(le),this.highlightsLayoutInfo=this._params.highlightsLayoutInfo,this.vBarsLayoutInfo={injectionPlace:this._vBarsInjectionPlace,scrollMirrorContainerStyleOverrides:{zIndex:100},scrollMirrorLayout:this._vBarsScrollMirrorLayout},this.selectionOrCaretPosition=this._params.selectionOrCaretPosition,this._subs.add(O(te.T(this._params.selectionSource.data.behavior,this._params.textObserver.contentChanges.immediate).pipe(R.h(void 0)),this._params.selectionService).subscribe(u.wW(this._selectionRange))),this._subs.add(this._selectionRange.subscribe((e=>this._logger.debug("Selection range updated.",e))))}getRewriteScope(e){if(e.vBar.text.includes(ae.o2)){const t=this._params.textObserver.getCurrentTextMap().getPlainText(),i=t.slice(e.vBar.textRange.start,e.vBar.textRange.end);let r=i;for(let t=0;t<i.length;t++)if(i.charAt(t)===ae.o2){const i=this._params.textObserver.getCurrentTextMap().getFragmentAtOffset(e.vBar.textRange.start+t),n=i instanceof ne.I?i.getParsedFragment().fragment.text:ae.o2;r=r.replace(ae.o2,n)}return i!==r?(this._logger.debug('Found "smart chips" and converted them into plain text.',{originalText:i,augmentedText:r}),this._params.telemetryService.infoOncePerMessage({message:"Converted Google Docs smart chips into plain text."})):(this._logger.warn('Found "smart chips" but could not convert them into plain text.',{originalText:i,augmentedText:r}),this._params.telemetryService.warn({message:"Could not convert Google Docs smart chips into plain text."})),{kind:"otherText",text:t.slice(0,e.vBar.textRange.start)+r+t.slice(e.vBar.textRange.start+r.length),range:{start:e.vBar.textRange.start,end:e.vBar.textRange.start+r.length}}}return F(e.vBar.textRange)}dispose(){this._subs.unsubscribe()}getVBarHighlightRect(e){return P(e)}getKeyboardEventsTarget(){const e=(0,se.CI)(document);return e||(this._params.telemetryService.error({message:"Could not find the target element for text events in GDocs"}),this._logger.error("Could not find the target element for text events"),document.body)}}var ue=i(96653),ge=i(6655),me=i(42722),pe=i(20128),ve=i(88305);function fe(e){return e.patternName.startsWith("Calliope/Rewrite/QualityPush")}class Se{constructor(e){this._params=e,this._subs=new s.w0,this._inlineAlertsFilter=a.h.create(r.W8),this.inlineAlertsFilter=this._inlineAlertsFilter.view(),this.alerts=this._params.alertProcessor.alerts.state.view((e=>Object.values(e).filter(ve.Nf).filter(pe.S.isTransformJsonCapiAlert))),this.calliopeAlerts=this.alerts.view((e=>e.filter(fe))),this._subs.add(Z.a(this._params.alertClassification.visibleInlineAlertsFilter,this._params.featureFlags,((e,t)=>({filter:e,featureFlags:t}))).pipe(L.U((({filter:e,featureFlags:t})=>i=>{return e(i)&&(n=i,!(0,r.zG)(t,g.hX((e=>e.signalingSidelines)),g.pC)||!(pe.S.isCapiAlert(n)&&fe(n)));var n}))).subscribe(u.wW(this._inlineAlertsFilter)))}removeAcceptedAlert(e){this._params.alertProcessor.removeAlert(e,{_tag:me.i.alertAccepted})}ignoreAlert(e){(0,r.zG)(this._params.checkingService.get(),m.bw((t=>t.onAlertIgnored({id:e},ge.e3.Vbar)))),this._params.alertProcessor.removeAlert(e,{_tag:me.i.ignore})}getCalliopeAlertsWithinTextRange(e){return function(e,t){return e.filter((e=>e.transformJSON.highlights.some((e=>e.s>=t.start&&e.e<=t.end))))}(this.calliopeAlerts.get(),e)}dispose(){this._subs.unsubscribe()}}var we=i(68330),be=i(74822),_e=i(84714),ye=i(31603),Ce=i(12518),ke=i(18799),xe=i(32082),Re=i(6824),Be=i(36661),Ee=i(27123);const Ie=Be.n(Re.Schemable)(Ee.k7).is,Te=(e,t)=>`vbar-${"pushed_content"===e.kind?e.pushedContentVBarType:e.kind}-${t.type.kind}`,Pe=e=>e?"discountPro":"pro",Fe=(e,t,i,r)=>{const n=Te(e,t),a=Pe(i);r.csToBgActions.openSubscriptionPage({utmCampaign:`%appName%_blurredSuggestion_${n}_${a}`,utmSource:"upHook"})},Me=(e,t,i,n)=>{const a=(0,r.zG)(i,g.UI((({usedVBarsTextHashList:t})=>t.includes(e.textHash))),g.fS((()=>!1))),s=(0,r.zG)(i,g.UI((({quota:e})=>e)),g.fS((()=>-1)));return!a&&s>0?(n.debug("Updating monetization info.",{vBarTextHash:e.textHash,userId:t.user.get().id}),t.csToBgActions.markVBarUsed({vBarTextHash:e.textHash,userId:t.user.get().id}).then((()=>!0)).catch((i=>{const r="Failed to update monetization info.",a={vBarTextHash:e.textHash,userId:t.user.get().id};return n.error(r,i,a),t.telemetry.error({message:r,error:i,data:a}),!1}))):Promise.resolve(!1)};class Le{constructor(e){this._params=e,this._logger=xe.Y.create("MonetizationServiceImpl"),this.vBarsQuotaInfo=a.h.combine(this._params.csPageState.view("g2Settings"),this._params.user.view("id"),this._params.user.view("premium"),((e,t,i)=>{var r;if(i||!(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsMonetization))return g.YP;let n=[];const a=null===(r=null==e?void 0:e.monetization)||void 0===r?void 0:r[t];return(null==a?void 0:a.date)===(0,ke.u4)()&&(n=a.displayedVBarTextHashList),g.G({quota:Math.max(3-n.length,0),usedVBarsTextHashList:n})})),this.dispose=r.Q1}markVBarUsed(e){return Me(e,this._params,this.vBarsQuotaInfo.get(),this._logger).then((()=>{}))}executeUphook(e,t,i){Fe(e,t,i,this._params)}}class De{constructor(e){this._params=e,this._logger=xe.Y.create("CapiMonetizationServiceImpl"),this._subs=new we.w.Keeper,this._disposed=new be.x,this.vBarsQuotaInfo=a.h.create(g.YP),this._capiBalance=(0,r.zG)(_e.of(this._params.capiStartAckMessage.pipe(d.h(g.pC),L.U(m.MH),L.U((e=>{var t,i;return(0,r.zG)(null===(i=null===(t=e.serverConfigs)||void 0===t?void 0:t.VBARS_LOCKEDUI)||void 0===i?void 0:i.freeUnlocks,g.ij)}))),e.checkingService.pipe(d.h(g.pC),L.U(m.MH),L.U((e=>e.capiMessages)),ye.J(),d.h(Ie),L.U((e=>g.G(e.freeUnlocks))))),ye.J()),this._subs.push((0,r.zG)(Z.a([this._capiBalance,this._params.csPageState.view("g2Settings"),this._params.user.view("id"),this._params.user.view("premium")]),L.U((([e,t,i,n])=>n||!(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsMonetization)?g.YP:(0,r.zG)(e,g.UI((e=>{var r;let n=[];const a=null===(r=null==t?void 0:t.monetization)||void 0===r?void 0:r[i];return(null==a?void 0:a.date)===(0,ke.u4)()&&(n=a.displayedVBarTextHashList),{quota:e,usedVBarsTextHashList:n}})))))).subscribe((e=>this.vBarsQuotaInfo.set(e))))}markVBarUsed(e){return Me(e,this._params,this.vBarsQuotaInfo.get(),this._logger).then((e=>{if(!e)return;this.vBarsQuotaInfo.modify(g.UI((({quota:e,usedVBarsTextHashList:t})=>({quota:Math.max(e-1,0),usedVBarsTextHashList:t}))));const t={action:"vbars_lockedui:freeLookEvent"};return(0,r.zG)(this._params.checkingService.get(),g.g_((()=>Promise.reject("Checking service not available.")),(async e=>{const i=await e.sendMessage("vbars_lockedui:freeLookEvent",t,!1)();if(Ce.nM(i))throw i.left;return i.right}))).then((()=>{})).catch((e=>{this._logger.error("Could not record a free look event.",e)}))}))}executeUphook(e,t,i){Fe(e,t,i,this._params)}dispose(){this._subs.dispose(),this._disposed.next(void 0)}}const Ae={acceptCount:0,completedSteps:[],hasSeenSelectionPulsating:!1,hasSeenSignalingPulsating:!1,hasSeenIdlePulsating:!1,revertPresentedCount:0};var ze=i(86722);function Oe(e,t){var i;return(null===(i=null==e?void 0:e.onboarding)||void 0===i?void 0:i[t])||Ae}class Ge{constructor(e){this._params=e,this._isExperimentEnabled="test"===(0,v.OB)().experimentClient.getTreatment(b.p.G2VBarsOnboarding),this.shouldShowTooltip=a.h.combine(this._params.csPageState.view("g2Settings"),this._params.user.view("id"),((e,t)=>{const i=Oe(e,t),r=i.completedSteps.length>=ze._.size;return this._isExperimentEnabled&&!r&&i.acceptCount<3})),this.shouldShowPulsating=a.h.combine(this._params.csPageState.view("g2Settings"),this._params.user.view("id"),((e,t)=>{const i=Oe(e,t);return{shouldShowIdlePulsating:this._isExperimentEnabled&&!i.hasSeenIdlePulsating,shouldShowSelectionPulsating:this._isExperimentEnabled&&!i.hasSeenSelectionPulsating,shouldShowSignalingPulsating:this._isExperimentEnabled&&!i.hasSeenSignalingPulsating}})),this.currentStep=a.h.combine(this._params.csPageState.view("g2Settings"),this._params.user.view("id"),((e,t)=>{const i=Oe(e,t).completedSteps;return function(e){var t;return null!==(t=Array.from(ze._.values()).find((t=>!e.has(t))))&&void 0!==t?t:null}(new Set(i))})),this.acceptCount=a.h.combine(this._params.csPageState.view("g2Settings"),this._params.user.view("id"),((e,t)=>Oe(e,t).acceptCount))}incrementAcceptCount(){var e,t,i,r;if(!this.shouldShowTooltip.get())return;const n=this._params.user.get(),a=null!==(r=null===(i=null===(t=null===(e=this._params.csPageState.get().g2Settings)||void 0===e?void 0:e.onboarding)||void 0===t?void 0:t[n.id])||void 0===i?void 0:i.acceptCount)&&void 0!==r?r:0;this._params.csToBgActions.setOnboardingAcceptCount({userId:n.id,acceptCount:a+1}).catch((e=>this._params.telemetryService.error({message:"Failed to increment the vBar onboarding accept count.",error:e})))}incrementRevertPresentedCount(){var e,t,i;if(this.currentStep.get()!==ze.X.revert)return;const r=this._params.user.get(),n=null!==(i=null===(t=null===(e=this._params.csPageState.get().g2Settings)||void 0===e?void 0:e.onboarding)||void 0===t?void 0:t[r.id].revertPresentedCount)&&void 0!==i?i:0;this._params.csToBgActions.setOnboardingRevertPresentedCount({userId:r.id,revertPresentedCount:n+1}).catch((e=>this._params.telemetryService.error({message:"Failed to increment the vBar onboarding revert presented count.",error:e})))}onHide(e){e?this._params.trackingService.vBarOnboardingClose({vBar:e}):this._params.telemetryService.error({message:"vBar is null when onboarding tooltip onHide is called"});const t=this._params.user.get();this._params.csToBgActions.setOnboardingDismissed({userId:t.id}).catch((e=>{this._params.telemetryService.error({message:"Failed to set the onboarding as dismissed.",error:e})}))}onNextStep(e){const t=this.currentStep.get();if(!this.shouldShowTooltip.get()||null===t)return;e?this._params.trackingService.vBarOnboardingNext({vBar:e}):this._params.telemetryService.error({message:"vBar is null when onboarding tooltip onNextStep is called"});const i=this._params.user.get();this._params.csToBgActions.setOnboardingCompletedStep({userId:i.id,completedStep:t}).catch((e=>this._params.telemetryService.error({message:"Failed to increment the vBar onboarding current step.",error:e})))}notifyPulsatingSeen(e){const t=this._params.user.get();this._params.trackingService.vBarOnboardingShow({vBar:e}),this._params.csToBgActions.setOnboardingPulsatingSeen({userId:t.id,vBarType:e.kind}).catch((e=>this._params.telemetryService.error({message:"Failed to set the onboarding pulsating seen.",error:e})))}notifyPulsatingShown(e){this._params.trackingService.vBarOnboardingPulse({vBar:e})}}var Ue=i(29196);function He(e){let t=0,i=0;const r=[];for(;i<=e.length;)"\n"!==e.charAt(i)&&""!==e.charAt(i)||(t!==i&&r.push({start:t,end:i}),t=i+1),i++;return r}class qe{constructor(e){this._params=e,this._subs=new s.w0,this._logger=(0,C.h)(qe.name),this._paragraphs=a.h.create([]),this._paragraphById=new Map,this.paragraphs=this._paragraphs.view(),this._editingParagraphIndex=a.h.create(-1),this.editingParagraphIndex=this._editingParagraphIndex.view(),this._subs.add(this._params.textObserver.contentChanges.async.pipe(d.h((e=>!e.deltaChange.isEmpty)),x.b(1e3),M.O(null),L.U((()=>{const e=this._params.textObserver.getCurrentTextMap().getPlainText();return{paragraphTextRanges:He(e),fullText:e}})),L.U((({paragraphTextRanges:e,fullText:t})=>{const i=e.map(((e,i)=>function(e,t,i){return{id:`g2-paragraph-${t.start}-${t.end}`,sequentialId:e,textRange:t,text:i.slice(t.start,t.end),fullTextLength:i.length}}(i,e,t)));return i.filter((e=>this._params.integration.textRangeFilter({textRange:e.textRange,fullText:t})))}))).subscribe(u.wW(this._paragraphs))),this._subs.add(this._editingParagraphIndex.pipe(d.h((e=>-1===e)),(0,l.w)((()=>this._params.textObserver.contentChanges.async.pipe(d.h((e=>!e.deltaChange.isEmpty)),c.q(1),L.U((({changes:e})=>{const[t]=e,i=Ue.q.isIns(t)?t.pos:t.pos-t.text.length;return this._paragraphs.get().findIndex((({textRange:e})=>{if(!(e.end<i))return!0}))})))))).subscribe((e=>{this._editingParagraphIndex.set(e)}))),this._subs.add(this._paragraphs.subscribe((e=>{this._paragraphById.clear();for(const t of e)this._paragraphById.set(t.id,t)}))),this._subs.add(this._paragraphs.subscribe((e=>this._logger.debug("Paragraphs updated.",e))))}resetEditingParagraphIndex(){this._editingParagraphIndex.set(-1)}getParagraphById(e){return g.ij(this._paragraphById.get(e))}dispose(){this._subs.unsubscribe()}}var Ve=i(31491),Ne=i(72106),je=i(6791);const We=Be.n(Re.Schemable)(je.T0).is,$e=Be.n(Re.Schemable)(je.D).is,Ye=Be.n(Re.Schemable)(je.JC).is;class Ke{constructor(e){this._params=e,this._logger=xe.Y.create("PushedContentServiceImpl"),this._subs=new we.w.Keeper,this._disposed=new be.x,this.settingsState=a.h.create(g.YP),this.contentState=a.h.create({});const t=this._params.capiStartAckMessage.pipe(L.U((0,r.ls)(g.UI((e=>{var t;return null===(t=e.serverConfigs)||void 0===t?void 0:t.PUSHED_CONTENT})),g.tS(g.ij))),d.h(g.pC),L.U(m.MH));this._subs.push(te.T([t,this._params.checkingService.pipe(d.h(g.pC),L.U((e=>e.value.capiMessages)),ye.J(),d.h($e))]).pipe(ye.J()).subscribe((e=>{this.settingsState.set(g.G(e))})),this._params.checkingService.pipe(d.h(g.pC),L.U((e=>e.value.capiMessages)),ye.J(),d.h((0,Ve.Kg)(We,Ye))).subscribe(this._hanedlePushedContentMessage.bind(this)))}_hanedlePushedContentMessage(e){switch(e.action){case"pushed_content:pushedContent":this.contentState.modify((t=>({...t,[e.contentId]:{notification:e.notification,surface:e.surface}})));break;case"pushed_content:removeContent":this.contentState.modify((t=>Object.fromEntries(Object.entries(t).filter((([t])=>t!==e.contentId)))))}}_sendPushedContentMessage(e){return(0,r.zG)(this._params.checkingService.get(),Ne.Yo((()=>"Checking service not available.")),Ne.tS((t=>t.sendMessage(e.action,e,!1))))().then((()=>{})).catch((e=>{this._logger.error("Could not send Pushed Content message.",e)}))}sendDismissContentMessage(e){return this._sendPushedContentMessage({action:"pushed_content:dismissContent",contentId:e})}sendExecuteActionMessage(e,t,i){return this._sendPushedContentMessage({action:"pushed_content:executeAction",contentId:e,clientContext:t,request:i})}sendGetSettingsMessage(e){return this._sendPushedContentMessage({action:"pushed_content:getSettings",contentId:e})}sendUpdateSettingsMessage(e,t){return this._sendPushedContentMessage({action:"pushed_content:updateSettings",contentId:e,extraSettings:t.extraSettings,defaultAction:t.defaultAction,expandedTabs:t.expandedTabs})}dispose(){this._subs.dispose(),this._disposed.next(void 0)}}class Qe{constructor(){this.settingsState=a.h.create(g.YP),this.contentState=a.h.create({})}sendDismissContentMessage(){return Promise.resolve()}sendExecuteActionMessage(){return Promise.resolve()}sendGetSettingsMessage(){return Promise.resolve()}sendUpdateSettingsMessage(){return Promise.resolve()}dispose(){}}var Xe=i(72848),Je=i(36807),Ze=i(84908),et=i(62552),tt=i(98189),it=i(18519),rt=i(91089),nt=i(90707),at=i(87295),st=i(11633);const ot=st.OT(st.i0("text_actions")),lt=st.OT(st.dt({action:ot,id:st.OT(st.pk)}));function dt(e){return lt.is(e)}var ct=i(62414);const ht=Be.n(ct.l7(Re.Schemable)({sensitiveString:Re.string}))(ct.a9).is;function ut(e,t){const i=ct.Sy((e=>e.struct({kind:e.literal(t)}))),r=ct.Sy((t=>t.intersect(i(t))(e(t))));return{ResultMessage:r,isResultMessage:Be.n(ct.l7(Re.Schemable)({sensitiveString:Re.string}))(r).is}}const{isResultMessage:gt,ResultMessage:mt}=ut(ct.WV,nt.PU.Final),pt=gt,{isResultMessage:vt,ResultMessage:ft}=ut(ct.WV,nt.PU.Partial),St=vt;var wt=i(29417),bt=i(45345),_t=i(16779),yt=i(42131);function Ct(e,t){const i=(e=>{switch(e.kind){case"improve":return{kind:"default"};case"rephrase":return{kind:"rephrase"};case"shorten":return{kind:"other",actionId:{id:"rewrite:shorten"}};case"friendly":return{kind:"other",actionId:{id:"rewrite:friendly"}};case"formal":return{kind:"other",actionId:{id:"rewrite:formal"}};case"customPrompt":return{kind:"userPrompt",prompt:e.prompt};case"other":return{kind:"other",actionId:{id:e.textActionId}};default:(0,Y.L0)(e)}})(e.type);return{correlationId:e.id,kind:{...i},entrypoint:{family:"g2",name:nt.K0.VbarCard,request_tag:`${e.vBar.kind}${t?"_preloading":""}`},args:{},metadata:{}}}var kt=i(50048),xt=i(77726);const Rt=y.m9(3),Bt=y.m9(3),Et=y.m9(1),It=y.m9(10);function Tt(e){return`rewrite-requested-${e}`}function Pt(e){return`rewrite-request-sent-${e}`}function Ft(e){return"ready"===e.kind?{...e,source:{kind:"cache"}}:e}class Mt{constructor(e){this._params=e,this._subs=new s.w0,this._logger=(0,C.h)(Mt.name),this._relevantCapiMessages=this._params.checkingService.pipe(o.oA,l.w((e=>e.capiMessages)),d.h((0,Ve.Kg)(dt,pt,ht))),this._rewritePartialMessages=this._params.checkingService.pipe(o.oA,l.w((e=>e.capiMessages)),d.h(St),Ze.p(300)),this._cachedRewriteIdMap=new Map,this._cachedRewriteMap=new Map,this._ackMessageIds=new et.X(new Set),this._waitForCheckingStatusNotInProgress=async e=>{var t,i;await e.checkingStatus.pipe(x.b(300),tt.n((e=>e===wt.H.inProgress)),c.q(1),it.V(null!==(i=null===(t=this._params.dynamicConfig.view("vBars").get())||void 0===t?void 0:t.checkingStatusInProgressTimeoutMs)&&void 0!==i?i:Bt)).toPromise()},this._waitForLatestCheckingRevision=async e=>{var t,i;await e.checkingRevisionInfo.pipe(x.b(100),c.q(1),it.V(null!==(i=null===(t=this._params.dynamicConfig.view("vBars").get())||void 0===t?void 0:t.waitForLatestCheckingRevisionTimeoutMs)&&void 0!==i?i:Et)).toPromise()},this._waitForCAPITextRevisionSyncStrategy=(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsWaitForLatestCheckingRevisionBeforeGettingRewrite)?"waitForLatestCheckingRevision":"waitForCheckingStatusNotInProgress",this._waitForCAPITextRevisionSync="waitForLatestCheckingRevision"===this._waitForCAPITextRevisionSyncStrategy?this._waitForLatestCheckingRevision:this._waitForCheckingStatusNotInProgress,this._subs.add(this._relevantCapiMessages.subscribe((e=>this._handleServerMessage(e)))),this._subs.add(this._rewritePartialMessages.subscribe((e=>this._handleServerMessage(e)))),this._subs.add(this._params.checkingService.subscribe((e=>{g.pC(e)?this._logger.debug("Checking service available."):this._logger.debug("Checking service not available.")}))),this._subs.add(this._params.checkingService.pipe(l.w(g.g_((()=>rt.C),(e=>e.capiMessages)))).subscribe((e=>this._logger.debug("Received CAPI message.",e))))}_getDurationSincePerformanceMark(e,t,i,r){const n=e(t),a=`${i}-${t}`,s=function(e,t){const i=performance.getEntriesByName(e).length>0?performance.measure(t,e).duration:void 0;return performance.clearMarks(e),i}(n,a);if(void 0===s){const e={performanceMarkName:n,measureName:a};this._logger.error(r,e),this._params.telemetryService.error({message:r,data:e})}return null!=s?s:0}_getDurationSinceRewriteRequestSent(e,t){return this._getDurationSincePerformanceMark(Pt,e,t,"Failed to get duration since rewrite request sent.")}_getDurationSinceRewriteRequested(e,t){return this._getDurationSincePerformanceMark(Tt,e,t,"Failed to get duration since rewrite requested.")}_handleServerMessage(e){dt(e)?this._handleAckMessage(e):ht(e)?(this._params.telemetryService.warn({message:'Server message with result "failure" received.'}),this._handleErrorMessage(e)):pt(e)?(this._params.telemetryService.infoOncePerMessage({message:'Server message with result "success" received.'}),this._handleRewriteResultMessage(e)):St(e)?(this._params.telemetryService.infoOncePerMessage({message:'Server message with result "partial" received.'}),(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsStreaming)&&this._handleRewriteResultMessage(e)):(0,Y.vE)(e)}_handleAckMessage(e){const t=this._ackMessageIds.getValue();t.add(e.id),this._ackMessageIds.next(t)}_handleRewriteResultMessage(e){var t;const i=this._cachedRewriteMap.get(e.correlationId);if(void 0===i)this._logger.warn("Received a successful result with unknown correlation ID.",{resultSuccessMessage:e}),this._params.telemetryService.warn({message:'Server message with result "success" and unknown correlation ID received.'});else{const n={id:i.get().id,rewriteTabId:i.get().rewriteTabId,vBar:i.get().vBar,type:i.get().type,augmentedText:i.get().augmentedText};if(e.kind===nt.PU.Partial){const t={...n,kind:"loading",patternName:e.actionId.id,rewriteTextPartial:e.rewrite};i.set(t)}else{this._params.trackingService.vBarCardRewriteResultReceived({vBar:n.vBar,rewriteType:n.type,duration:this._getDurationSinceRewriteRequestSent(e.correlationId,"rewrite-result-received")});const a=(0,r.zG)(yt.FS.getDiff(null!==(t=g.WG(i.get().augmentedText))&&void 0!==t?t:i.get().vBar.text,e.rewrite),Ce.Vn((t=>this._logger.error("Failed to get diff for rewrite.",{error:t,newText:e.rewrite}))),g.Uo),s={...n,kind:"ready",title:e.explanation,rewriteText:e.rewrite,rewriteDiff:a,source:{kind:"server"},patternName:e.actionId.id,accessibilityLabel:(0,r.zG)(a,g.UI((e=>(0,kt.G)(e))))};this._logger.debug("Received a successful result; updating rewrite.",{rewriteBefore:i.get(),rewriteAfter:s}),i.set(s)}}}_handleErrorMessage(e){const t=this._cachedRewriteMap.get(e.correlationId);if(void 0===t)this._logger.warn("Received a failed result with unknown correlation ID.",{errorMessage:e}),this._params.telemetryService.warn({message:'Server message with result "failure" and unknown correlation ID received.'});else{const i={kind:"error",id:t.get().id,vBar:t.get().vBar,type:t.get().type,rewriteTabId:t.get().rewriteTabId,augmentedText:t.get().augmentedText,errorReason:e.errorType.kind,errorDetails:e.details,source:{kind:"server"}};this._logger.debug("Received a failed result; updating rewrite.",{rewriteBefore:t.get(),rewriteAfter:i}),t.set(i)}}_forceReconnect(){var e;this._ackMessageIds.next(new Set),null===(e=g.WG(this._params.checkingService.get()))||void 0===e||e.reconnect()}async _performRewriteRequest(e,t,i,n,s){const o=(0,Xe.Z)();this._cachedRewriteIdMap.set(e,o);const l=a.h.create({kind:"loading",id:o,rewriteTabId:t,vBar:i,type:n,augmentedText:g.YP});return this._cachedRewriteMap.set(l.get().id,l),await(0,r.zG)(this._params.checkingService.get(),g.g_((()=>{const e="Getting rewrite failed: Checking service not initialized.";return this._logger.error(e),this._params.telemetryService.error({message:e}),l.modify((e=>({...e,kind:"error",errorReason:"checkingServiceUnavailable",source:{kind:"server"}}))),Promise.resolve(l)}),(async e=>{var t,r,a,o;try{this._logger.debug("Flushing text change buffer before sending rewrite request."),this._params.textChangeBuffer.flush(),await this._waitForCAPITextRevisionSync(e)}catch(e){const t="Getting rewrite failed: Something went wrong while waiting for CAPI text revision to sync with local text changes.";return this._logger.error(t,{error:e,waitForCAPITextRevisionSyncStrategy:this._waitForCAPITextRevisionSyncStrategy}),this._params.telemetryService.error({message:t,error:e,data:{waitForCAPITextRevisionSyncStrategy:this._waitForCAPITextRevisionSyncStrategy}}),l.modify((e=>({...e,kind:"error",errorReason:"waitForLatestCheckingRevision"===this._waitForCAPITextRevisionSyncStrategy?"waitForLatestCheckingRevisionTimeout":"checkingStatusInProgressTimeout",source:{kind:"server"}}))),l}const d=Ct(l.get(),s),h=this._params.integration.getRewriteScope(l.get());"otherText"===h.kind&&l.modify((e=>{var t,i;return{...e,augmentedText:g.G(h.text.slice(null===(t=h.range)||void 0===t?void 0:t.start,null===(i=h.range)||void 0===i?void 0:i.end))}}));try{this._logger.debug('Sending "text_actions:invokeRewrite" message to CAPI.',{data:d,scope:h}),performance.mark(Pt(d.correlationId)),this._params.trackingService.vBarCardRewriteRequestSent({vBar:i,rewriteType:n});const s=await e.sendMessage("text_actions:invokeRewrite",d,!1,{kind:"scope",scope:h})();if(Ce.nM(s))throw s.left.message;{this._subs.add(this._ackMessageIds.pipe(tt.n((e=>!e.has(s.right))),c.q(1),it.V(null!==(r=null===(t=this._params.dynamicConfig.get().vBars)||void 0===t?void 0:t.rewriteAckTimeoutMs)&&void 0!==r?r:Rt)).subscribe({error:()=>{const e="Never received ack for rewrite; forcing reconnect.",t={vBarType:i.kind,rewriteType:l.get().type.kind};this._logger.error(e,t),this._params.telemetryService.error({message:e,data:t}),this._forceReconnect()}}));const e=null!==(o=null===(a=this._params.dynamicConfig.view("vBars").get())||void 0===a?void 0:a.rewriteLoadingTimeoutMs)&&void 0!==o?o:It;return this._subs.add(l.pipe(tt.n(xt.z7),c.q(1),it.V(e)).subscribe({error:()=>{const e="Rewrite stuck loading; transitioning to error state.",t={vBarType:i.kind,rewriteType:l.get().type.kind};this._logger.error(e,t),this._params.telemetryService.error({message:e,data:t}),l.modify((e=>({...e,kind:"error",errorReason:"rewriteLoadingTimeout",source:{kind:"server"}})))}})),this._logger.debug("Returning un-cached rewrite.",l.get()),l}}catch(e){const t='Getting rewrite failed: Sending "text_actions:invokeRewrite" message to CAPI failed.';return this._logger.error(t,{error:e}),this._params.telemetryService.error({message:t,error:e}),l.modify((e=>({...e,kind:"error",errorReason:"rewriteRequestFailure",source:{kind:"server"}}))),l}})))}async getRewrite(e){this._logger.debug("Getting rewrite.",e);const{rewriteType:t,skipCache:i,vBar:r,isPreload:n,rewriteTabId:a}=e,s=(0,_t.Wu)(r.text),o=`${t.kind}-${r.textRange.start}-${r.textRange.end}-${s}`,l=`${o}-${Date.now()}`;performance.mark(Tt(l)),this._params.trackingService.vBarCardRewriteRequested({vBar:r,rewriteTabId:"other"===t.kind?t.textActionId:a});const h=this._cachedRewriteIdMap.get(o),u=void 0!==h?this._cachedRewriteMap.get(h):void 0;let g;return"customPrompt"!==t.kind&&!i&&void 0!==u&&"error"!==u.get().kind?(u.modify(Ft),this._logger.debug("Returning cached rewrite.",u.get()),g=u):(void 0!==h&&this._cachedRewriteMap.delete(h),g=await this._performRewriteRequest(o,a,r,t,n),this._subs.add(g.pipe(d.h((0,Ve.Kg)(xt.NK,xt.Oy)),c.q(1)).subscribe((e=>{this._params.trackingService.vBarCardRewriteLoaded({vBar:r,rewrite:e,duration:this._getDurationSinceRewriteRequested(l,"rewrite-loaded"),textFieldElementSize:this._getTextFieldElementSize()})})))),g}getImproveRewriteFromCalliopeAlert(e){var t;const i=(0,Xe.Z)(),n={kind:"improve"};let a;performance.mark(Tt(i)),this._params.trackingService.vBarCardRewriteRequested({vBar:e.vBar,rewriteTabId:n.kind});const s=(0,r.zG)(e.calliopeAlert.transformJSON.alternatives,g.UI((e=>e.context[0])),g.WG),o=(0,r.zG)(e.calliopeAlert.transformJSON.alternatives,g.UI((e=>e.alternatives[0])),g.WG);if(null===s||s.s<e.vBar.textRange.start||s.e>e.vBar.textRange.end||null===o){const t='Failed to retrieve "improve" rewrite from Calliope alert.';this._logger.error(t),this._params.telemetryService.error({message:t}),a={kind:"error",id:i,rewriteTabId:"improve",vBar:e.vBar,type:n,augmentedText:g.YP,errorReason:"rewriteFromCalliopeAlertFailure",source:{kind:"alert",alertId:e.calliopeAlert.id}}}else{const l=o.ops.filter((e=>!at.JU.isOptionalContextRetain(e))),d=[{retain:s.s-e.vBar.textRange.start},...l],c=new Je.i(d),h=(0,bt.l)(c,e.vBar.text),u=(0,r.zG)(yt.FS.getDiff(e.vBar.text,h),Ce.Vn((e=>this._logger.error("Failed to get diff for rewrite.",{error:e,newText:h}))),g.Uo);a={kind:"ready",id:i,rewriteTabId:"improve",vBar:e.vBar,type:n,augmentedText:g.YP,title:null!==(t=e.calliopeAlert.extraProperties.vbar_card_title)&&void 0!==t?t:"Use our best version",rewriteText:h,rewriteDiff:u,source:{kind:"alert",alertId:e.calliopeAlert.id},patternName:e.calliopeAlert.patternName,accessibilityLabel:(0,r.zG)(u,g.UI((e=>(0,kt.G)(e))))}}return this._params.trackingService.vBarCardRewriteLoaded({vBar:e.vBar,rewrite:a,duration:this._getDurationSinceRewriteRequested(i,"calliope-alert-rewrite-loaded"),textFieldElementSize:this._getTextFieldElementSize()}),a}_getTextFieldElementSize(){const e=this._params.integration.highlightsLayoutInfo.textFieldLayout.visibleRect.getApproximate().size;return{width:Math.round(e.width),height:Math.round(e.height)}}dispose(){this._subs.unsubscribe()}}var Lt=i(48813);const Dt=Be.n(Re.Schemable)(Lt.Ct).is;var At=i(86576);const zt=(e,t)=>[e.id,t].join("-"),Ot=e=>"pushed_content"===e.kind?e.pushedContentVBarType:e.kind;class Gt{constructor(e){this._params=e,this._subs=new s.w0,this._subs.add(this._params.checkingService.pipe(o.oA,l.w((e=>e.capiMessages)),d.h(Dt),d.h((e=>e.result!==At.e.Success))).subscribe((e=>{e.result===At.e.ValidationFail?this._params.telemetryService.error({message:"vBar CAPI feedback validation failed.",error:e.errorMessage}):e.result===At.e.Error&&this._params.telemetryService.error({message:"vBar CAPI feedback processing failed.",error:e.errorMessage})})))}_getRewriteReadyLoadResult(e,t){if(t)return At.R.Uphook;const{kind:i}=e.source;switch(i){case"server":return At.R.Loaded;case"cache":return At.R.Cached;case"alert":return At.R.Prepopulated;default:(0,Y.L0)(i)}}_getRewriteErrorLoadResult(e){switch(e.errorReason){case"backendError":return At.R.FailedBackendError;case"badRequest":return At.R.FailedBadRequest;case"sensitivity":return At.R.FailedSensitivity;case"serviceLimitExceeded":return At.R.FailedServiceLimitExceeded;case"unsupportedLanguage":return At.R.FailedUnsupportedLanguage;case"updateClient":return At.R.FailedUpdateClient;case"rewriteRequestFailure":case"rewriteLoadingTimeout":case"rewriteFromCalliopeAlertFailure":case"checkingStatusInProgressTimeout":case"checkingServiceUnavailable":case"waitForLatestCheckingRevisionTimeout":case"other":return At.R.FailedOther;default:(0,Y.L0)(e.errorReason)}}_getVBarFeedbackRequestMessageData(e,t,i){const r={vBarId:t.id,actionType:e,vBarType:Ot(t),range:{start:t.textRange.start,end:t.textRange.end},...{...i,textFieldElementSize:null==i?void 0:i.textFieldElementSize}};return this._withTrackingVBarId(r,t)}_sendMessageViaCheckingService(e,t){return(0,r.zG)(this._params.checkingService.get(),g.g_((()=>Promise.reject("Checking service not available.")),(async i=>{const r=await i.sendMessage(e,t,!1)();if(Ce.nM(r))throw r.left;return r.right})))}_sendVBarFeedbackRequestMessage(e){this._sendMessageViaCheckingService("vbar_feedback:vBarFeedbackRequest",e).catch((t=>this._params.telemetryService.error({message:"Failed to send vBar CAPI feedback.",error:t,data:e})))}_getVBarCommonFeedbackRequestMessageData(e){const t={...e,vBarId:e.vBar.id,vBarType:e.vBar.kind};return this._withTrackingVBarId(t,e.vBar)}_withTrackingVBarId(e,t){return(0,r.zG)(this._params.checkingService.get(),g.tS((e=>g.ij(e.sessionUuid))),g.g_((()=>(this._params.telemetryService.error({message:"Failed to retrieve sessionUuid while sending CAPI feedback; won't add it to vBarId."}),{...e,vBarId:t.id})),(i=>({...e,vBarId:zt(t,i)}))))}vBarShown(e){const t=this._getVBarFeedbackRequestMessageData("entrypoint_show",e.vBar);this._sendVBarFeedbackRequestMessage(t)}vBarHidden(e){const t=this._getVBarFeedbackRequestMessageData("entrypoint_hide",e.vBar);this._sendVBarFeedbackRequestMessage(t)}vBarCardShown(e){const t=this._getVBarFeedbackRequestMessageData("card_show",e.vBar,{textFieldElementSize:e.textFieldElementSize});this._sendVBarFeedbackRequestMessage(t)}vBarCardClosed(e){const t=this._getVBarFeedbackRequestMessageData("card_close",e.vBar);this._sendVBarFeedbackRequestMessage(t)}vBarCardRewriteRequested(e){const t=this._getVBarFeedbackRequestMessageData("card_rewrite_loading_start",e.vBar,{..."customPrompt"===e.rewriteTabId?{userPrompt:e.userPrompt}:void 0});this._sendVBarFeedbackRequestMessage(t)}vBarCardRewriteLoaded(e){let t;t=(0,xt.NK)(e.rewrite)?e.vBar.text===e.rewrite.rewriteText?At.R.Empty:this._getRewriteReadyLoadResult(e.rewrite,!1):this._getRewriteErrorLoadResult(e.rewrite);const i=this._getVBarFeedbackRequestMessageData("card_rewrite_loaded",e.vBar,{pname:(0,xt.NK)(e.rewrite)?e.rewrite.patternName:void 0,rewrite:(0,xt.NK)(e.rewrite)?e.rewrite.rewriteText:void 0,..."customPrompt"===e.rewrite.type.kind?{userPrompt:e.rewrite.type.prompt}:void 0,loadingTimeMs:e.duration,result:t,textFieldElementSize:e.textFieldElementSize});this._sendVBarFeedbackRequestMessage(i)}vBarCardRewriteStreamingStart(e){var t;const i=this._getVBarFeedbackRequestMessageData("card_rewrite_streaming_start",e.vBar,{pname:null!==(t=e.rewrite.patternName)&&void 0!==t?t:"",..."customPrompt"===e.rewrite.type.kind?{userPrompt:e.rewrite.type.prompt}:void 0,loadingTimeMs:e.duration});this._sendVBarFeedbackRequestMessage(i)}vBarCardRewriteReadyShown(e){const t=this._getVBarFeedbackRequestMessageData("card_rewrite_show",e.vBar,{pname:e.rewrite.patternName,rewrite:e.rewrite.rewriteText,..."customPrompt"===e.rewrite.type.kind?{userPrompt:e.rewrite.type.prompt}:void 0,loadingTimeMs:e.duration,result:this._getRewriteReadyLoadResult(e.rewrite,e.isUphook),textFieldElementSize:e.textFieldElementSize});this._sendVBarFeedbackRequestMessage(t)}vBarCardRewriteApplied(e){const t=this._getVBarFeedbackRequestMessageData("card_rewrite_apply",e.vBar,{pname:e.rewrite.patternName,rewrite:e.rewrite.rewriteText,textFieldElementSize:e.textFieldElementSize,..."customPrompt"===e.rewrite.type.kind?{userPrompt:e.rewrite.type.prompt}:void 0});this._sendVBarFeedbackRequestMessage(t)}vBarCardRewriteDismissed(e){const t=this._getVBarFeedbackRequestMessageData("card_rewrite_dismiss",e.vBar,{pname:e.rewrite.patternName,textFieldElementSize:e.textFieldElementSize,rewrite:e.rewrite.rewriteText,..."customPrompt"===e.rewrite.type.kind?{userPrompt:e.rewrite.type.prompt}:void 0});this._sendVBarFeedbackRequestMessage(t)}vBarCardRewriteCopied(e){const t=this._getVBarFeedbackRequestMessageData("card_rewrite_copy",e.vBar,{pname:e.rewrite.patternName,rewrite:e.rewrite.rewriteText,textFieldElementSize:e.textFieldElementSize,..."customPrompt"===e.rewrite.type.kind?{userPrompt:e.rewrite.type.prompt}:void 0});this._sendVBarFeedbackRequestMessage(t)}vBarCardShowLessClicked(e){const t=this._getVBarFeedbackRequestMessageData("card_show_less",e.vBar);this._sendVBarFeedbackRequestMessage(t)}vBarCardRewriteReverted(e){const t=this._getVBarFeedbackRequestMessageData("card_rewrite_revert",e.vBar,{pname:e.rewrite.patternName,rewrite:e.rewrite.rewriteText,..."customPrompt"===e.rewrite.type.kind?{userPrompt:e.rewrite.type.prompt}:void 0});this._sendVBarFeedbackRequestMessage(t)}vBarOnboardingPulse(e){const t=this._getVBarFeedbackRequestMessageData("onboarding_pulse",e.vBar);this._sendVBarFeedbackRequestMessage(t)}vBarOnboardingShow(e){const t=this._getVBarFeedbackRequestMessageData("onboarding_show",e.vBar);this._sendVBarFeedbackRequestMessage(t)}vBarOnboardingNext(e){const t=this._getVBarFeedbackRequestMessageData("onboarding_next",e.vBar);this._sendVBarFeedbackRequestMessage(t)}vBarOnboardingClose(e){const t=this._getVBarFeedbackRequestMessageData("onboarding_close",e.vBar);this._sendVBarFeedbackRequestMessage(t)}vBarCardUserSubmittedFeedback(e){const t=this._getVBarCommonFeedbackRequestMessageData(e),i={kind:ge.PZ.USER_SATISFACTION_FEEDBACK,subtype:ge.e3.Vbar,userSatisfactionDescription:t.userSatisfactionDescription,userSatisfaction:t.userSatisfaction,vBarId:t.vBarId,vBarType:t.vBarType,text:t.text,g2ActionInfo:t.g2ActionInfo};this._sendMessageViaCheckingService("feedback",i).catch((e=>this._params.telemetryService.error({message:"Failed to send vBar user satisfaction CAPI feedback.",error:e,data:t})))}dispose(){this._subs.unsubscribe()}}var Ut=i(26585);class Ht{constructor(e){this._params=e,this._felog=(0,Ut.Tb)(),this._commonLabels={domain:this._params.integrationInfo.domain,integrationName:this._params.integrationInfo.integrationName}}vBarsInitialized(){this._felog.sendFemetricsRate("vBarsInitialized",this._commonLabels)}vBarCardRewriteRequestSent(e){const t={...this._commonLabels,vBarType:e.vBar.kind,rewriteType:e.rewriteType.kind};this._felog.sendFemetricsRate("vBarCardRewriteRequestSent",t)}vBarCardRewriteResultReceived(e){const t={...this._commonLabels,vBarType:e.vBar.kind,rewriteType:e.rewriteType.kind};this._felog.sendFemetricsRate("vBarCardRewriteResultReceived",t),e.duration&&this._felog.sendFemetricsTimer("vBarCardRewriteResultReceived",e.duration,"histogram",t)}vBarCardRewriteReadyShown(e){const t={...this._commonLabels,vBarType:e.vBar.kind,rewriteType:e.rewrite.type.kind,rewriteSource:e.rewrite.source.kind,isUphook:e.isUphook};this._felog.sendFemetricsRate("vBarCardRewriteReadyShown",t),e.duration&&this._felog.sendFemetricsTimer("vBarCardRewriteReadyShown",e.duration,"histogram",t)}vBarCardRewriteEmptyShown(e){const t={...this._commonLabels,vBarType:e.vBar.kind,rewriteType:e.rewrite.type.kind,rewriteSource:e.rewrite.source.kind};this._felog.sendFemetricsRate("vBarCardRewriteEmptyShown",t),e.duration&&this._felog.sendFemetricsTimer("vBarCardRewriteEmptyShown",e.duration,"histogram",t)}vBarCardRewriteErrorShown(e){const t={...this._commonLabels,vBarType:e.vBar.kind,rewriteType:e.rewrite.type.kind,rewriteSource:e.rewrite.source.kind,rewriteErrorReason:e.rewrite.errorReason};this._felog.sendFemetricsRate("vBarCardRewriteErrorShown",t),e.duration&&this._felog.sendFemetricsTimer("vBarCardRewriteErrorShown",e.duration,"histogram",t)}vBarCardRewriteUphookShown(e){const t=Te(e.vBar,e.rewrite),i=Pe(e.isEligibleForInProductDiscount);this._felog.upgradeHooks.showUpgradeHook("blurredSuggestion",t,i);const r={...this._commonLabels,vBarType:e.vBar.kind,rewriteType:e.rewrite.type.kind,rewriteSource:e.rewrite.source.kind};this._felog.sendFemetricsRate("vBarCardRewriteUphookShown",r)}vBarCardRewriteUphookClicked(e){const t=Te(e.vBar,e.rewrite),i=Pe(e.isEligibleForInProductDiscount);this._felog.upgradeHooks.clickUpgradeHook("blurredSuggestion",t,i);const r={...this._commonLabels,vBarType:e.vBar.kind,rewriteType:e.rewrite.type.kind,rewriteSource:e.rewrite.source.kind};this._felog.sendFemetricsRate("vBarCardRewriteUphookClicked",r)}vBarCardRewriteStreamingStart(e){const t={...this._commonLabels,vBarType:e.vBar.kind,rewriteType:e.rewrite.type.kind};this._felog.sendFemetricsRate("vBarCardRewriteStreamingStart",t),e.duration&&this._felog.sendFemetricsTimer("vBarCardRewriteStreamingStart",e.duration,"histogram",t)}}class qt{constructor(e){this._params=e}_sendTelemetryError(e,t){this._params.telemetryService.error({message:"Failed to track Gnar event.",error:t,data:{eventName:e}})}_sendNoSessionUuidTelemetryError(e){this._sendTelemetryError(e,"Failed to retrieve sessionUuid.")}_trackWithSessionUuid(e,t){return(0,r.zG)(this._params.checkingService.get(),g.tS((e=>g.ij(e.sessionUuid))),g.g_((()=>this._sendNoSessionUuidTelemetryError(e)),(i=>t(i).catch((t=>this._sendTelemetryError(e,t))))))}_isGoogleDocs(){return"googleDocs"===this._params.integrationInfo.kind}_getRewriteReadyShownStatus(e,t){if(t)return"uphook";const{kind:i}=e.source;switch(i){case"server":return"loaded";case"cache":return"cached";case"alert":return"prepopulated";default:(0,Y.L0)(i)}}_getRewriteErrorShownStatus(e){return`failed_${e.errorReason}`}_getVBarKind(e){return"pushed_content"===e.kind?e.pushedContentVBarType:e.kind}vBarShown(e){this._trackWithSessionUuid("vBarEntrypointShow",(t=>this._params.gnarClient.vBarEntrypointShow(this._isGoogleDocs(),t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}vBarHidden(e){this._trackWithSessionUuid("vBarEntrypointClose",(t=>this._params.gnarClient.vBarEntrypointClose(this._isGoogleDocs(),t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}vBarCardShown(e){this._trackWithSessionUuid("vBarCardShow",(t=>this._params.gnarClient.vBarCardShow(this._isGoogleDocs(),e.isUphook,t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}vBarCardClosed(e){this._trackWithSessionUuid("vBarCardClose",(t=>this._params.gnarClient.vBarCardClose(this._isGoogleDocs(),t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}vBarCardCustomPromptSubmitted(e){this._trackWithSessionUuid("vBarCardSubmitCustomPrompt",(t=>this._params.gnarClient.vBarCardSubmitCustomPrompt(this._isGoogleDocs(),t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}vBarCardRewriteSelected(e){this._trackWithSessionUuid("vBarCardPromptSubmit",(t=>this._params.gnarClient.vBarCardPromptSubmit(this._isGoogleDocs(),e.previousRewriteTabId,e.rewriteTabId,t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}vBarCardRewriteStreamingStart(e){this._trackWithSessionUuid("vBarCardRewriteStreamingStart",(t=>this._params.gnarClient.vBarCardStreamingStart(this._isGoogleDocs(),e.rewrite.rewriteTabId,t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar),e.duration)))}vBarCardRewriteEmptyShown(e){this._trackWithSessionUuid("vBarCardLoaded",(t=>this._params.gnarClient.vBarCardLoaded(this._isGoogleDocs(),e.rewrite.rewriteTabId,"empty",t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar),e.duration)))}vBarCardRewriteReadyShown(e){this._trackWithSessionUuid("vBarCardLoaded",(t=>this._params.gnarClient.vBarCardLoaded(this._isGoogleDocs(),e.rewrite.rewriteTabId,this._getRewriteReadyShownStatus(e.rewrite,e.isUphook),t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar),e.duration)))}vBarCardRewriteErrorShown(e){this._trackWithSessionUuid("vBarCardLoaded",(t=>this._params.gnarClient.vBarCardLoaded(this._isGoogleDocs(),e.rewrite.rewriteTabId,this._getRewriteErrorShownStatus(e.rewrite),t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar),e.duration)))}vBarCardRewriteApplied(e){this._trackWithSessionUuid("vBarCardRewriteApply",(t=>this._params.gnarClient.vBarCardRewriteApply(this._isGoogleDocs(),e.rewrite.rewriteTabId,t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}vBarCardRewriteDismissed(e){this._trackWithSessionUuid("vBarCardRewriteDismissed",(t=>this._params.gnarClient.vBarCardRewriteDismiss(this._isGoogleDocs(),e.rewrite.rewriteTabId,t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}vBarCardRewriteCopied(e){this._trackWithSessionUuid("vBarCardRewriteCopy",(t=>this._params.gnarClient.vBarCardRewriteCopy(this._isGoogleDocs(),e.rewrite.rewriteTabId,t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}vBarCardRewriteReverted(e){this._trackWithSessionUuid("vBarCardRewriteRevert",(t=>this._params.gnarClient.vBarCardRewriteRevert(this._isGoogleDocs(),e.rewrite.rewriteTabId,t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}vBarCardRewriteRegenerated(e){this._trackWithSessionUuid("vBarCardRewriteRegenerate",(t=>this._params.gnarClient.vBarCardRewriteRegenerate(this._isGoogleDocs(),e.rewrite.rewriteTabId,t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}vBarCardRewriteFeedbackSubmitted(e){const t=JSON.stringify({vBarId:e.vBar.id,vBarType:e.vBar.kind,prompt:e.rewrite.rewriteTabId,message:e.feedbackFormData.text,domain:e.feedbackFormData.domain,isGoogleDocs:this._isGoogleDocs()});this._params.gnarClient.feedbackSentButtonClick(t,"g2",e.feedbackFormData.score).catch((e=>this._sendTelemetryError("feedbackSentButtonClick",e)))}vBarCardRewriteUphookShown(e){const t=Te(e.vBar,e.rewrite),i=Pe(e.isEligibleForInProductDiscount);this._trackWithSessionUuid("getPremiumButtonShow",(e=>this._params.gnarClient.getPremiumButtonShow("blurredSuggestion",void 0,void 0,void 0,void 0,void 0,!1,void 0,void 0,e,"blurredSuggestion",t,i)))}vBarCardRewriteUphookClicked(e){const t=Te(e.vBar,e.rewrite),i=Pe(e.isEligibleForInProductDiscount);this._trackWithSessionUuid("getPremiumButtonClick",(e=>this._params.gnarClient.getPremiumButtonClick("blurredSuggestion",void 0,void 0,void 0,void 0,void 0,!1,void 0,void 0,e,"blurredSuggestion",t,i)))}vBarCardShowLessClicked(e){this._trackWithSessionUuid("vBarCardShowLess",(t=>this._params.gnarClient.vBarCardShowLess(e.domain,this._isGoogleDocs(),e.rewrite.type.kind,t,e.vBar.textHash,e.vBar.fullTextLength,zt(e.vBar,t),e.vBar.text.length,Ot(e.vBar))))}}class Vt{constructor(e){this._params=e,this._gnarTrackingService=new qt({gnarClient:this._params.gnarClient,checkingService:this._params.checkingService,integrationInfo:this._params.integrationInfo,telemetryService:this._params.telemetryService}),this._capiFeedbacksTrackingService=new Gt({checkingService:this._params.checkingService,telemetryService:this._params.telemetryService}),this._feMetricsTrackingService=new Ht({integrationInfo:this._params.integrationInfo})}vBarsInitialized(){this._feMetricsTrackingService.vBarsInitialized()}vBarShown(e){this._gnarTrackingService.vBarShown(e),this._capiFeedbacksTrackingService.vBarShown(e)}vBarHidden(e){this._gnarTrackingService.vBarHidden(e),this._capiFeedbacksTrackingService.vBarHidden(e)}vBarCardShown(e){this._gnarTrackingService.vBarCardShown(e),this._capiFeedbacksTrackingService.vBarCardShown(e)}vBarCardClosed(e){this._gnarTrackingService.vBarCardClosed(e),this._capiFeedbacksTrackingService.vBarCardClosed(e)}vBarCardCustomPromptSubmitted(e){this._gnarTrackingService.vBarCardCustomPromptSubmitted(e)}vBarCardRewriteSelected(e){this._gnarTrackingService.vBarCardRewriteSelected(e)}vBarCardRewriteRequested(e){this._capiFeedbacksTrackingService.vBarCardRewriteRequested(e)}vBarCardRewriteLoaded(e){this._capiFeedbacksTrackingService.vBarCardRewriteLoaded(e)}vBarCardRewriteRequestSent(e){this._feMetricsTrackingService.vBarCardRewriteRequestSent(e)}vBarCardRewriteResultReceived(e){this._feMetricsTrackingService.vBarCardRewriteResultReceived(e)}vBarCardRewriteStreamingStart(e){this._gnarTrackingService.vBarCardRewriteStreamingStart(e),this._capiFeedbacksTrackingService.vBarCardRewriteStreamingStart(e),this._feMetricsTrackingService.vBarCardRewriteStreamingStart(e)}vBarCardRewriteEmptyShown(e){this._gnarTrackingService.vBarCardRewriteEmptyShown(e),this._feMetricsTrackingService.vBarCardRewriteEmptyShown(e)}vBarCardRewriteReadyShown(e){this._gnarTrackingService.vBarCardRewriteReadyShown(e),this._capiFeedbacksTrackingService.vBarCardRewriteReadyShown(e),this._feMetricsTrackingService.vBarCardRewriteReadyShown(e)}vBarCardRewriteErrorShown(e){this._gnarTrackingService.vBarCardRewriteErrorShown(e),this._feMetricsTrackingService.vBarCardRewriteErrorShown(e)}vBarCardRewriteApplied(e){this._gnarTrackingService.vBarCardRewriteApplied(e),this._capiFeedbacksTrackingService.vBarCardRewriteApplied(e)}vBarCardRewriteDismissed(e){this._gnarTrackingService.vBarCardRewriteDismissed(e),this._capiFeedbacksTrackingService.vBarCardRewriteDismissed(e)}vBarCardRewriteCopied(e){this._gnarTrackingService.vBarCardRewriteCopied(e),this._capiFeedbacksTrackingService.vBarCardRewriteCopied(e)}vBarCardRewriteReverted(e){this._gnarTrackingService.vBarCardRewriteReverted(e),this._capiFeedbacksTrackingService.vBarCardRewriteReverted(e)}vBarCardRewriteRegenerated(e){this._gnarTrackingService.vBarCardRewriteRegenerated(e)}vBarCardRewriteFeedbackSubmitted(e){if(this._gnarTrackingService.vBarCardRewriteFeedbackSubmitted(e),e.feedbackFormData.shareUserText){const t={vBar:e.vBar,text:e.vBar.text,userSatisfaction:e.feedbackFormData.score,userSatisfactionDescription:e.feedbackFormData.text,g2ActionInfo:{actionId:e.rewrite.patternName,pname:e.rewrite.patternName,rewriteText:e.rewrite.rewriteText}};this._capiFeedbacksTrackingService.vBarCardUserSubmittedFeedback(t)}}vBarCardRewriteUphookShown(e){this._gnarTrackingService.vBarCardRewriteUphookShown(e),this._feMetricsTrackingService.vBarCardRewriteUphookShown(e)}vBarCardRewriteUphookClicked(e){this._gnarTrackingService.vBarCardRewriteUphookClicked(e),this._feMetricsTrackingService.vBarCardRewriteUphookClicked(e)}vBarCardShowLessClicked(e){this._gnarTrackingService.vBarCardShowLessClicked(e),this._capiFeedbacksTrackingService.vBarCardShowLessClicked({vBar:e.vBar})}vBarOnboardingPulse(e){this._capiFeedbacksTrackingService.vBarOnboardingPulse(e)}vBarOnboardingShow(e){this._capiFeedbacksTrackingService.vBarOnboardingShow(e)}vBarOnboardingNext(e){this._capiFeedbacksTrackingService.vBarOnboardingNext(e)}vBarOnboardingClose(e){this._capiFeedbacksTrackingService.vBarOnboardingClose(e)}dispose(){this._capiFeedbacksTrackingService.dispose()}}class Nt{primeTrustedRewrite(){return Promise.resolve()}}class jt{constructor(e){this._params=e}primeTrustedRewrite(e,t){return(0,r.zG)(this._params.checkingService.get(),g.g_((()=>Promise.resolve(this._params.telemetryService.error({message:"Checking service is not available"}))),(async i=>{const r=await i.sendMessage("trusted_rewrite:prime",function(e,t){return{rewrite:t,range:{begin:e.start,end:e.end}}}(e,t),!1,{kind:"default"})();Ce.nM(r)&&this._params.telemetryService.error({message:"Failed to prime trusted rewrite",error:r.left})})))}}const Wt=n.createContext({isGateEnabled:()=>!1});function $t({isGateEnabledFn:e,children:t}){return n.createElement(Wt.Provider,{value:{isGateEnabled:e}},t)}const Yt=n.lazy((()=>Promise.all([i.e(2734),i.e(2614),i.e(6762),i.e(9839),i.e(3810),i.e(6610),i.e(274)]).then(i.bind(i,84907)).then((({FeedbackForm:e})=>({default:e}))))),Kt=n.lazy((()=>Promise.all([i.e(2734),i.e(2614),i.e(6762),i.e(9839),i.e(3810),i.e(6610),i.e(274)]).then(i.bind(i,7096)).then((({SidelineCardWrapper:e})=>({default:e}))))),Qt=n.lazy((()=>Promise.all([i.e(2734),i.e(2614),i.e(6762),i.e(9839),i.e(3810),i.e(6610),i.e(274)]).then(i.bind(i,27250)).then((({SidelineCollection:e})=>({default:e})))));class Xt{constructor(e){this._params=e,this._feedbackFormContext=a.h.create(g.YP),this.feedbackFormContext=this._feedbackFormContext.view()}showFeedbackForm(e,t){this._feedbackFormContext.set(g.G({rewrite:e,sidelineCard:t,domain:this._params.integrationInfo.domain}))}closeFeedbackForm(){this._feedbackFormContext.set(g.YP)}submitFeedbackForm(e,t){this._params.trackingService.vBarCardRewriteFeedbackSubmitted({vBar:t.sidelineCard.sideline,rewrite:t.rewrite,feedbackFormData:e}),this._params.telemetryService.feedback({feedbackData:{score:e.score,text:e.text,domain:e.domain,vBarType:t.sidelineCard.sideline.kind,rewriteType:t.rewrite.type.kind},message:"Feedback form submitted.",hideUserInfo:!1}),this._feedbackFormContext.set(g.YP)}}var Jt,Zt=i(91106),ei=i(14554);!function(e){e.toVBarsField=function(e){return{...e.rect,left:e.rect.left+(e.textFieldPosition.left-e.vBarsScrollMirrorFieldPosition.left)}},e.toTextField=function(e){return{...e.rect,left:e.rect.left-(e.textFieldPosition.left-e.vBarsScrollMirrorFieldPosition.left)}}}(Jt||(Jt={}));class ti{constructor(e){this._params=e,this._subs=new s.w0,this._logger=(0,C.h)(ti.name),this._selectionHighlight=a.h.create(g.YP),this.selectionHighlight=this._selectionHighlight.view(),this._subs.add(this._params.integration.selectionRange.subscribe((e=>{this._logger.debug("Selection range changed, updating selection highlight geometry accordingly.",e),this._params.selectionHighlightGeometry.removeAllHighlights();const t=this._params.textObserver.getCurrentTextMap().getPlainText();(0,r.zG)(e,g.hX((e=>this._params.integration.textRangeFilter({textRange:e,fullText:t}))),m.bw((e=>{const i=B.y$.Id.create(`g2-selection-highlight-${e.start}-${e.end}`);this._params.selectionHighlightGeometry.addHighlight(i,e,{highlightId:i,text:t.slice(e.start,e.end),textRange:e,alertId:"",highlightColor:null,highlightDisplayFormat:null,highlightLiveliness:null,fullTextLength:t.length})})))}))),this._subs.add(Z.a([this._params.integration.vBarsLayoutInfo.scrollMirrorLayout.rect,this._params.integration.vBarsLayoutInfo.scrollMirrorLayout.textField.paddingRect.behavior,this._params.selectionHighlightGeometry.geometry.view((e=>Array.from(e.values()))),this._params.integration.vBarsLayoutInfo.scrollMirrorLayout.textStartPosition]).pipe(L.U((([e,t,i,n])=>(0,r.zG)(g.ij(i[0]),g.tS((i=>{return a={highlightId:i.meta.highlightId.toString(),highlightRects:i.rects,text:i.meta.text,textRange:i.meta.textRange,fullTextLength:i.meta.fullTextLength,vBarsScrollMirrorFieldRect:e,textFieldPosition:t.client,textStartPosition:n,getVBarHighlightRect:this._params.integration.getVBarHighlightRect},(0,r.zG)(a.text.trim().split(/\s+/).filter((e=>""!==e)).length,g.DT((e=>e>=2&&e<=1e3)),g.tS((()=>{const e=a.highlightRects.map((e=>Jt.toVBarsField({rect:e,textFieldPosition:a.textFieldPosition,vBarsScrollMirrorFieldPosition:a.vBarsScrollMirrorFieldRect})));return(0,r.zG)(g.ij((0,ei.jr)(e)),g.UI((t=>({id:a.highlightId,text:a.text,textRange:a.textRange,fullTextLength:a.fullTextLength,rect:a.getVBarHighlightRect({vBarTextRectInMirror:t,scrollMirrorRectInViewport:a.vBarsScrollMirrorFieldRect,textStartPositionInViewport:a.textStartPosition}),selectionRects:e}))))})));var a})))))).subscribe(u.wW(this._selectionHighlight))),this._subs.add(this._params.selectionHighlightGeometry.geometry.view((e=>Array.from(e.values()))).subscribe((e=>this._logger.debug("Selection highlight geometry udpated. Resulting highlights:",e)))),this._subs.add(this._selectionHighlight.subscribe((e=>this._logger.debug("Selection highlight udpated.",e))))}dispose(){this._subs.unsubscribe()}}var ii=i(63717),ri=i(6622);var ni=i(50750);function ai(e){var t,i;const r=(0,V.wr)(e,(e=>"hidden"===e.style.overflow));if(!r)return e;const n=e.getBoundingClientRect();let a=Math.max(0,n.top),s=Math.min(self.innerHeight,n.top+n.height),o=r;for(;o&&"hidden"===o.style.overflow;){const{height:e,top:t}=o.getBoundingClientRect();a=Math.max(t,a),s=Math.min(t+e,s),o=o.parentElement}if(n.top>s||n.bottom<a)return e;if(n.top>=a&&n.bottom<=s)return e;const l=null===(i=null===(t=document.getElementsByTagName(ue.Hq)[0])||void 0===t?void 0:t.shadowRoot)||void 0===i?void 0:i.getElementById(ue.wE);return l?(l.style.top=`${a}px`,l.style.left=`${n.left}px`,l.style.width=`${n.width}px`,l.style.height=s-a+"px",l):e}var si=i(85251),oi=i(17869);function li(e,t=300){return e.pipe(si.v((({rewrite:e,vBarCard:t})=>`${e.id}-${t.sideline.id}`)),oi.z((e=>e.pipe(x.b(t)))))}function di(e,t,i){return`${e}-${t.type.kind}-${i.sideline.id}`}function ci(e,t){return di("rewrite-loading",e,t)}const hi=[{rewrite:{type:{kind:"improve"},kind:"idle",rewriteTabId:"improve"},buttonProps:{label:"Improve",accessibilityLabel:"Improve",accessibilityDescription:"Improve your writing. Press enter when selected to apply suggestions and return to your doc. Manually review the rewrite in the suggestion contents group. Or press Tab to advance and review other options."}},{rewrite:{type:{kind:"rephrase"},kind:"idle",rewriteTabId:"rephrase"},buttonProps:{label:"Rephrase",accessibilityLabel:"Rephrase",accessibilityDescription:"Rephrase your writing. Press enter when selected to apply suggestions and return to your doc. Manually review the rewrite in the suggestion contents group. Or press Tab to advance and review other options."}},{rewrite:{type:{kind:"shorten"},kind:"idle",rewriteTabId:"shorten"},buttonProps:{label:"Shorten",accessibilityLabel:"Shorten",accessibilityDescription:"Shorten your writing. Press enter when selected to apply suggestions and return to your doc. Manually review the rewrite in the suggestion contents group. Or press Tab to advance and review other options."}},{rewrite:{type:{kind:"friendly"},kind:"idle",rewriteTabId:"friendly"},buttonProps:{label:"Friendly",accessibilityLabel:"Friendly",accessibilityDescription:"Make your writing more friendly. Press enter when selected to apply suggestions and return to your doc. Manually review the rewrite in the suggestion contents group. Or press Tab to advance and review other options."}},{rewrite:{type:{kind:"formal"},kind:"idle",rewriteTabId:"formal"},buttonProps:{label:"Formal",accessibilityLabel:"Formal",accessibilityDescription:"Make your writing more formal. Press enter when selected to apply suggestions and return to your doc. Manually review the rewrite in the suggestion contents group. Or press Tab to advance and review other options."}}],ui={rewrites:new Map(hi.map((e=>[e.rewrite.rewriteTabId,e]))),rewriteTabsOrder:hi.map((e=>e.rewrite.rewriteTabId)),selectedRewriteTabId:"improve",customPromptRewriteInfo:g.YP,expanded:!1,rewriteApplied:!1,rewriteCopied:!1};class gi{constructor(e){var t,i;this._params=e,this._subs=new s.w0,this._logger=(0,C.h)(gi.name),this._sidelineCardStateMap=new Map,this._sidelineCard=a.h.create(g.YP),this._sidelineNotification=a.h.create(g.YP),this._notifyRewriteReadyShownSubject=new be.x,this._notifyRewriteEmptyShownSubject=new be.x,this._notifyRewriteErrorShownSubject=new be.x,this._rewriteSubjectMap=new Map,this._rewriteSubscriptionMap=new Map,this.sidelineCard=a.h.combine(this._sidelineCard,this._sidelineNotification,((e,t)=>g.pC(e)?e:t)),this._subs.add((t=this._params.sidelineCollectionViewModel,Z.a([t.activeSideline,t.pinnedSideline]).pipe(x.b(0),L.U((([e,t])=>(0,r.zG)(t,g.UI((e=>({sideline:e,isPinned:!0}))),g.wp((()=>(0,r.zG)(e,g.UI((e=>({sideline:e,isPinned:!1}))))))))),L.U(g.tS((({sideline:e,isPinned:i})=>(0,r.zG)(t.getSidelineHtmlElement(e.sequentialId),g.UI((n=>({kind:"card",sideline:e,isSidelinePinned:i,referenceElement:ai(n),shouldFocus:(0,r.zG)(t.cardFocusedSidelineSequentialId.get(),g.UI((t=>t===e.sequentialId)),g.Gg(r.yR))}))))))))).subscribe(u.wW(this._sidelineCard))),this._subs.add(li(this._notifyRewriteReadyShownSubject).subscribe((({rewrite:e,vBarCard:t,isUphook:i})=>{this._logger.debug("Tracking vBarCardRewriteReadyShown().",{rewrite:e,sidelineId:t.sideline.id}),this._params.trackingService.vBarCardRewriteReadyShown({vBar:t.sideline,rewrite:e,duration:this._getRewriteLoadingDuration("rewrite-ready-shown",e,t),isUphook:Boolean(i),textFieldElementSize:this._getTextFieldElementSize()})}))),this._subs.add(li(this._notifyRewriteEmptyShownSubject).subscribe((({rewrite:e,vBarCard:t})=>{this._logger.debug("Tracking vBarCardRewriteEmptyShown().",{rewrite:e,sidelineId:t.sideline.id}),this._params.trackingService.vBarCardRewriteEmptyShown({vBar:t.sideline,rewrite:e,duration:this._getRewriteLoadingDuration("rewrite-empty-shown",e,t)})}))),this._subs.add(li(this._notifyRewriteErrorShownSubject).subscribe((({rewrite:e,vBarCard:t})=>{this._logger.debug("Tracking vBarCardRewriteErrorShown().",{rewrite:e,sidelineId:t.sideline.id}),this._params.trackingService.vBarCardRewriteErrorShown({vBar:t.sideline,rewrite:e,duration:this._getRewriteLoadingDuration("rewrite-error-shown",e,t)})}))),(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsSelectionPreload)&&this._subs.add((i=this._params.sidelineCollectionViewModel.selectionSideline,i.pipe(l.w(g.g_((()=>_e.of(g.YP)),(e=>te.T(k.R(document,"mouseup"),k.R(document,"mousemove").pipe(d.h((e=>0===e.buttons)))).pipe(c.q(1),R.h(g.G(e)))))),x.b(y.m9(.2)),o.oA)).subscribe((e=>{this._logger.debug('Preloading "improve" rewrite for selection sideline.',{sidelineId:e.id}),this._params.rewriteService.getRewrite({rewriteType:{kind:"improve"},rewriteTabId:"improve",vBar:e,isPreload:!0})})))}_getSidelineCardState(e){var t;return null!==(t=this._sidelineCardStateMap.get(e.sideline.id))&&void 0!==t?t:this._initSidelineCardState(e)}_initSidelineCardState(e){this._logger.debug("Initializing sideline card state.",{sidelineId:e.sideline.id});const t=a.h.create(ui);return this._sidelineCardStateMap.set(e.sideline.id,t),t}_setRewriteInfo(e,t){this._logger.debug("Setting rewrite info.",{sidelineId:t.sideline.id,rewrite:e});const i=this._getSidelineCardState(t);"customPrompt"===e.rewriteTabId?i.lens("customPromptRewriteInfo").set(g.G(e)):i.lens("rewrites").modify((t=>{var i;const r=null===(i=t.get(e.rewriteTabId))||void 0===i?void 0:i.buttonProps;return void 0===r?t:new Map([...t.entries(),[e.rewriteTabId,{rewrite:e,buttonProps:r}]])}))}_showAllRewriteTypes(e){this._getSidelineCardState(e).lens("expanded").set(!0)}_measureDuration(e,t){return performance.getEntriesByName(t).length>0?performance.measure(e,t).duration:void 0}_getRewriteLoadingDuration(e,t,i){const r=ci(t,i),n=di(e,t,i),a=this._measureDuration(n,r);return void 0===a&&this._params.telemetryService.error({message:"Failed to measure rewrite loading duration.",data:{measureName:n,rewriteLoadingPerformanceMarkName:r}}),null!=a?a:0}_getTextFieldElementSize(){const e=this._params.integration.highlightsLayoutInfo.textFieldLayout.visibleRect.getApproximate().size;return{width:Math.round(e.width),height:Math.round(e.height)}}getSidelineCardState(e){return this._getSidelineCardState(e)}activateSidelineCard(e,t){this._params.sidelineCollectionViewModel.notifySidelineCardActive(e.sideline.sequentialId,t)}deactivateSidelineCard(e,t){(!e.isSidelinePinned||e.isSidelinePinned&&t)&&this._params.sidelineCollectionViewModel.notifySidelineCardInactive(e.sideline.sequentialId,t)}applyRewrite(e,t){this._logger.debug("Apply rewrite.",{rewrite:e,sidelineCard:t}),this._params.trackingService.vBarCardRewriteApplied({vBar:t.sideline,rewrite:e,textFieldElementSize:this._getTextFieldElementSize()}),(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsTrustedRewrite)&&this._params.trustedRewriteService.primeTrustedRewrite(t.sideline.textRange,e.rewriteText),this._params.performReplacement({pos:e.vBar.textRange,value:e.rewriteText,oldValue:e.vBar.text},{sidelineType:t.sideline.kind}).then((t=>{const i=(Array.isArray(t)?t:[t]).filter(ii.j.isFail);if(i.length>0){let e="Replacement(s) failed.";const t=i.map((e=>e.reason)).filter(Boolean);throw t.length>0&&(e+=` Reason(s): ${t.join(", ")}.`),new Error(e)}"alert"===e.source.kind&&this._params.alertCollectionService.removeAcceptedAlert(e.source.alertId),this._params.telemetryService.info({message:"Applying rewrite succeeded."})})).catch((e=>this._params.telemetryService.error({message:"Applying rewrite failed.",error:e}))),this._getSidelineCardState(t).lens("rewriteApplied").set(!0),this._params.sidelineCollectionViewModel.notifySidelineCardInactive(t.sideline.sequentialId,!0)}async copyRewrite(e,t){this._logger.debug("Copy rewrite.",{rewrite:e,sidelineCard:t}),this._params.trackingService.vBarCardRewriteCopied({vBar:t.sideline,rewrite:e,textFieldElementSize:this._getTextFieldElementSize()});try{await(0,ri.vQ)(e.rewriteText),this._params.telemetryService.info({message:"Copying rewrite succeeded."})}catch(e){this._params.telemetryService.error({message:"Copying rewrite failed.",error:e}),this._logger.error("Failed to copy rewrite.",e)}this._getSidelineCardState(t).lens("rewriteCopied").set(!0)}dismissRewrite(e,t){this._logger.debug("Dismiss rewrite.",{rewrite:e,sidelineCard:t}),this._params.trackingService.vBarCardRewriteDismissed({vBar:t.sideline,rewrite:e,textFieldElementSize:this._getTextFieldElementSize()});let i="alert"===e.source.kind?e.source.alertId:void 0;if(!i){const e=this.getSidelineCardState(t).lens("rewrites").get().get("improve");e&&"ready"===e.rewrite.kind&&"alert"===e.rewrite.source.kind&&(i=e.rewrite.source.alertId)}i?this._params.alertCollectionService.ignoreAlert(i):this._params.telemetryService.warn({message:"Unable to find alertId associated with rewrite"}),this._params.sidelineCollectionViewModel.notifySidelineCardInactive(t.sideline.sequentialId,!0)}deactivateSidelineType(e,t,i){this._logger.debug("Show less.",{rewrite:t,sidelineCard:i,vBarType:i.sideline.kind}),this._params.trackingService.vBarCardShowLessClicked({vBar:i.sideline,rewrite:t,domain:this._params.integrationInfo.domain});const r=i.referenceElement.getBoundingClientRect(),n={getBoundingClientRect:()=>r};this.deactivateSidelineCard(i,!0),this._sidelineNotification.set(g.G({kind:"notification",text:`Youll see fewer sidebars with suggestions on ${this._params.integrationInfo.domain}.`,referenceElement:n,id:Date.now()})),this._subs.add(this._scheduleNotifcationHide()),this._params.availabilityService.deactivate(e).then((()=>{this._logger.debug("Deactivated sideline type.",{vBarType:e,refBoundingRect:n.getBoundingClientRect()})})).catch((e=>{this._logger.error("Failed to deactivate sideline type.",e),this._params.telemetryService.error({message:"Failed to deactivate sideline type",error:e})}))}_scheduleNotifcationHide(){var e;const t=[self,null===(e=this._params.integration.additionalGlobalEventSource)||void 0===e?void 0:e.scroll].filter((e=>!!e)).map((e=>k.R(e,"scroll",{capture:!0})));return te.T(u.gw(void 0,y.m9(3)),k.R(document,"click",{capture:!0}),...t).pipe(c.q(1)).subscribe((()=>{this._sidelineNotification.set(g.YP)}))}regenerateRewrite(e,t){var i;this._logger.debug("Regenerate rewrite.",{sidelineId:t.sideline.id,rewrite:e}),this._params.trackingService.vBarCardRewriteRegenerated({vBar:t.sideline,rewrite:e}),null===(i=this._rewriteSubjectMap.get(t.sideline.id))||void 0===i||i.next({rewriteType:e.type,rewriteTabId:e.rewriteTabId,sidelineCard:t,useCache:!1,isRegenerate:!0})}submitCustomPrompt(e,t){var i;this._logger.debug("Submitting custom prompt.",{sidelineId:t.sideline.id,prompt:e}),this._params.trackingService.vBarCardCustomPromptSubmitted({vBar:t.sideline}),null===(i=this._rewriteSubjectMap.get(t.sideline.id))||void 0===i||i.next({rewriteType:{kind:"customPrompt",prompt:e},rewriteTabId:"customPrompt",sidelineCard:t,useCache:!1,isRegenerate:!1})}notifySelectedRewriteTabChanged(e,t){this._logger.debug("Selected rewrite changed.",{sidelineId:t.sideline.id,rewriteTabId:e}),this._showAllRewriteTypes(t);const i=this._getSidelineCardState(t).lens("selectedRewriteTabId");if(this._params.trackingService.vBarCardRewriteSelected({vBar:t.sideline,rewriteTabId:e,previousRewriteTabId:i.get()}),i.set(e),"customPrompt"!==e){const i=this._getSidelineCardState(t);(0,r.zG)(this._getCurrentRewriteType(i),g.g_((()=>{this._logger.error("No rewrite found for selected rewrite tab.")}),(i=>{var r;return null===(r=this._rewriteSubjectMap.get(t.sideline.id))||void 0===r?void 0:r.next({rewriteType:i.type,rewriteTabId:e,sidelineCard:t,useCache:!0,isRegenerate:!1})})))}}notifyCustomPromptChanged(e,t){this._getSidelineCardState(t).lens("customPromptRewriteInfo").set(g.YP)}notifyRewriteLoadingShown(e,t){this._logger.debug("notifyRewriteLoadingShown()",{rewrite:e,sidelineId:t.sideline.id});const i=ci(e,t);performance.clearMarks(i),performance.mark(i)}notifyRewriteEmptyShown(e,t){this._notifyRewriteEmptyShownSubject.next({rewrite:e,vBarCard:t})}notifyRewriteReadyShown(e,t,i){"test"===(0,v.OB)().experimentClient.getTreatment(b.p.G2VBarsFairLockedUI)&&this._params.monetizationService.markVBarUsed(t.sideline),this._params.telemetryService.infoOncePerMessage({message:"Rendering sideline card rewrite succeeded."}),this._notifyRewriteReadyShownSubject.next({rewrite:e,vBarCard:t,isUphook:i})}notifyRewriteErrorShown(e,t){this._notifyRewriteErrorShownSubject.next({rewrite:e,vBarCard:t})}notifyRewriteStreamingStart(e,t){this._logger.debug("notifyRewriteStreamingStart()",{rewrite:e,sidelineId:t.sideline.id});const i=this._getRewriteLoadingDuration("rewrite-streaming-start",e,t);this._params.trackingService.vBarCardRewriteStreamingStart({vBar:t.sideline,duration:i,rewrite:e})}notifyRewriteReverted(e,t){this._logger.debug("notifyRewriteReverted()",{rewrite:e,sidelineId:t.sideline.id}),this._params.trackingService.vBarCardRewriteReverted({vBar:t.sideline,rewrite:e})}_getCurrentRewriteType(e){var t;const i=e.lens("selectedRewriteTabId").get();return"customPrompt"===i?e.lens("customPromptRewriteInfo").get():(0,r.zG)(null===(t=e.lens("rewrites").get().get(i))||void 0===t?void 0:t.rewrite,g.ij)}notifySidelineCardShown(e,t){var i,n;this._logger.debug("notifySidelineCardShown()",{vBarId:e.sideline.id,isUphook:t}),this._params.trackingService.vBarCardShown({vBar:e.sideline,isUphook:t,textFieldElementSize:this._getTextFieldElementSize()}),this._params.telemetryService.infoOncePerMessage({message:"Rendering sideline card succeeded."}),null===(i=this._rewriteSubscriptionMap.get(e.sideline.id))||void 0===i||i.unsubscribe();const a=null!==(n=this._rewriteSubjectMap.get(e.sideline.id))&&void 0!==n?n:new be.x;this._rewriteSubjectMap.set(e.sideline.id,a);const s=a.pipe(l.w((({rewriteType:e,rewriteTabId:t,sidelineCard:i,useCache:n,isRegenerate:a})=>function(e,t,i,n,a,s=!0){const o=n.getSidelineCalliopeAlerts(e.sideline.sequentialId);return"improve"===t.kind&&o.length>0?_e.of(a.getImproveRewriteFromCalliopeAlert({vBar:e.sideline,calliopeAlert:o[0]})):ni.D(a.getRewrite({rewriteType:t,rewriteTabId:i,vBar:e.sideline,isPreload:!1,skipCache:!s})).pipe(c.q(1),l.w(r.yR))}(i,e,t,this._params.sidelineCollectionViewModel,this._params.rewriteService,n).pipe(L.U((e=>({rewrite:e,isRegenerate:a}))))))).subscribe((({rewrite:t,isRegenerate:i})=>{this._logger.debug("Rewrite observable emitted.",{sidelineId:e.sideline.id,rewrite:t,isRegenerate:i}),"ready"===t.kind&&this._params.telemetryService.info({message:i?"Regenerating rewrite succeeded.":"Retrieving rewrite succeeded."}),this._setRewriteInfo(t,e)}));this._rewriteSubscriptionMap.set(e.sideline.id,s),this._subs.add(s);const o=this._getSidelineCardState(e);(0,r.zG)(this._getCurrentRewriteType(o),g.fS((()=>Array.from(o.lens("rewrites").get().values())[0].rewrite)),(t=>a.next({rewriteType:t.type,sidelineCard:e,useCache:!0,isRegenerate:!1,rewriteTabId:this._getSidelineCardState(e).lens("selectedRewriteTabId").get()}))),"test"!==(0,v.OB)().experimentClient.getTreatment(b.p.G2VBarsFairLockedUI)&&this._params.monetizationService.markVBarUsed(e.sideline)}notifySidelineCardClosed(e){var t;const i=this._getSidelineCardState(e),r=i.lens("rewriteApplied").get();this._logger.debug("notifySidelineCardClosed()",{sidelineId:e.sideline.id,isRewriteApplied:r}),r||this._params.trackingService.vBarCardClosed({vBar:e.sideline}),null===(t=this._rewriteSubscriptionMap.get(e.sideline.id))||void 0===t||t.unsubscribe(),i.set(ui)}notifyMoreTabClicked(e){this._showAllRewriteTypes(e)}notifyFeedbackButtonClicked(e,t){this._params.feedbackFormViewModel.showFeedbackForm(e,t)}notifyUphookButtonClicked(e,t,i){const r=i.get()&&"test"===(0,v.OB)().experimentClient.getTreatment(b.p.InProductDiscount);this._params.monetizationService.executeUphook(t.sideline,e,r),this._params.trackingService.vBarCardRewriteUphookClicked({vBar:t.sideline,rewrite:e,isEligibleForInProductDiscount:r})}notifyUphookButtonShown(e,t,i){this._params.trackingService.vBarCardRewriteUphookShown({vBar:t.sideline,rewrite:e,isEligibleForInProductDiscount:i.get()&&"test"===(0,v.OB)().experimentClient.getTreatment(b.p.InProductDiscount)})}dispose(){this._subs.unsubscribe()}}var mi=i(18117),pi=i(38538),vi=i(93440),fi=i(63532),Si=i(18595),wi=i(53186),bi=i(82881),_i=i(13642),yi=i(79749);function Ci(e,t){const i=(0,yi.MY)(e.text),r=[t,"vbar",e.textRange.start,e.textRange.end,i];"selection"===t&&r.push(performance.now());return{kind:t,id:r.join("-"),text:e.text,textHash:i,textRange:e.textRange,fullTextLength:e.fullTextLength}}var ki=i(18674);class xi{constructor(e){var t;this._params=e,this._subs=new s.w0,this._disposables=[],this._logger=(0,C.h)(xi.name),this._htmlElementBySidelineSequentialId=new Map,this._paragraphSidelines=a.h.create([]),this._paragraphSidelineBySequentialId=new Map,this._pushedContendSidelineBySequentialId=new Map,this._pinnedSidelineSequentialId=a.h.create(g.YP),this._pinnedSideline=a.h.combine(this._pinnedSidelineSequentialId,this._paragraphSidelines,(e=>(0,r.zG)(e,g.tS((e=>e===ki.ZR?this._selectionSideline.get():this._getSidelineBySequentialId(e)))))),this._activeSidelineSequentialId=a.h.create(g.YP),this._activationTimeoutRef=void 0,this._deactivationTimeout=I.zH,this._activeSideline=a.h.combine(this._pinnedSideline,this._activeSidelineSequentialId,this._paragraphSidelines,((e,t)=>(0,r.zG)(e,g.wp((()=>(0,r.zG)(t,g.tS((e=>e===ki.ZR?this._selectionSideline.get():this._getSidelineBySequentialId(e))))))))),this._emphasizedSidelineSequentialId=a.h.create(g.YP),this._emphasizedSidelineSequentialIdByParagraphHighlight=a.h.create(g.YP),this._isSubdued=a.h.create(!1),this._vbarMousePositions=a.h.create({}),this._emphasizedSideline=a.h.combine(this._pinnedSideline,this._activeSideline,this._emphasizedSidelineSequentialId,this._emphasizedSidelineSequentialIdByParagraphHighlight,this._isSubdued,this._paragraphSidelines,((e,t,i,n,a)=>(0,r.zG)(t,g.tS((t=>g.pC(e)?g.YP:g.G(t))),g.wp((()=>(0,r.zG)(i,g.wp((()=>n)),g.tS((e=>e===ki.ZR?this._selectionSideline.get():a?g.YP:this._getSidelineBySequentialId(e))))))))),this._selectionSideline=a.h.create(g.YP),this._shouldHideSidelines=a.h.create(!1),this._sidelineCardActiveNotifications=new be.x,this._deactivateSidelineSubs=new s.w0,this._notifySidelineShownSubject=new be.x,this._notifySidelinePulsedSubject=new be.x,this._selectionOrCaretPosition=a.h.create(g.YP),this.paragraphSidelines=this._paragraphSidelines.view(),this.pinnedSideline=this._pinnedSideline.view(),this.activeSideline=this._activeSideline.view(),this.emphasizedSideline=this._emphasizedSideline.view(),this.selectionSideline=this._selectionSideline.view(),this.shouldHideSidelines=this._shouldHideSidelines.view(),this.isSubdued=this._isSubdued.view(),this.vBarMousePositions=this._vbarMousePositions.view(),this.cardFocusedSidelineSequentialId=a.h.create(g.YP),this._subs.add(Z.a([this._params.availabilityService.enabled,this._params.sidelineHighlightCollectionViewModel.sidelineHighlights,this._params.alertCollectionService.calliopeAlerts]).pipe(L.U((([e,t])=>(0,r.zG)(e,g.g_((()=>[]),(e=>{const i=this._params.textObserver.getCurrentTextMap().getPlainText();return t.map((t=>{switch(t.kind){case"paragraph":return e.signalingSidelines||e.idleSidelines?(0,r.zG)(this._params.paragraphCollectionService.getParagraphById(t.paragraphId),g.g_((()=>(this._params.telemetryService.warn({message:"Creating sideline failed."}),this._logger.warn("Failed to create paragraph sideline; skipping.",{paragraphId:t.paragraphId}),g.YP)),(i=>function(e,t,i,r,n){const a=function(e,t,i,r){return i&&t.getCalliopeAlertsWithinTextRange(e.textRange).length>0?"signaling":r?"idle":void 0}(e,i,r,n);if(!a)return g.YP;const s={...Ci(e,a),sequentialId:e.sequentialId,highlightRect:t};return g.G(s)}(i,t.rect,this._params.alertCollectionService,e.signalingSidelines,e.idleSidelines))),g.WG):null;case"pushed_content":return(0,r.zG)(function(e,t,i,r){const n=r.notificationElement,a=n.range,s=e.substring(a.start,a.end),o=n.vBarType,l=(0,yi.MY)(s),d={kind:"pushed_content",id:[o,"vbar",a.start,a.end,l].join("-"),text:s,textHash:l,textRange:a,fullTextLength:e.length,pushedContentId:i,pushedContentVBarType:o,color:n.colorHex,sequentialId:i,highlightRect:t};return g.G(d)}(i,t.rect,t.pushedContentId,this._params.pushedContentService.contentState.get()[t.pushedContentId].notification),g.WG);default:(0,ve.vE)(t)}})).filter(ve.Nf)})))))).subscribe(u.wW(this._paragraphSidelines))),this._subs.add(this._paragraphSidelines.subscribe((e=>{this._paragraphSidelineBySequentialId.clear();for(const t of e)this._paragraphSidelineBySequentialId.set(t.sequentialId,t)}))),this._subs.add(this._params.sidelineHighlightCollectionViewModel.emphasizedSidelineHighlight.subscribe((e=>{(0,r.zG)(e,g.g_((()=>this._emphasizedSidelineSequentialIdByParagraphHighlight.set(g.YP)),(e=>{var t;if((0,_i.x3)()){const i=null===(t=this._paragraphSidelineBySequentialId.get(e.sequentialId))||void 0===t?void 0:t.id;if(i){const t=this._vbarMousePositions.get()[i];e.horizontalDistanceToPointer<=60?this._vbarMousePositions.modify(pi.dx(i,"HoverVBar"===t?t:"InsideSafeArea")):this._vbarMousePositions.modify((()=>({[i]:"HoverVBar"===t?t:"OutsideSafeArea"})))}}this._emphasizedSidelineSequentialIdByParagraphHighlight.set(g.G(e.sequentialId))})))}))),this._setupSelectionSideline(),this._subs.add(Z.a([this._params.legacyAssistantOpenState,this._params.assistantState]).pipe(L.U((([e,t])=>"open"===e||"opened"===t.kind))).subscribe(u.wW(this._shouldHideSidelines))),this._subs.add(this._shouldHideSidelines.pipe(d.h(Boolean)).subscribe((()=>{this._pinnedSidelineSequentialId.set(g.YP),this._activeSidelineSequentialId.set(g.YP)}))),this._subs.add(this._params.textObserver.contentChanges.immediate.subscribe((({changes:e})=>{e.length>0&&(this._pinnedSidelineSequentialId.set(g.YP),this._activeSidelineSequentialId.set(g.YP))}))),this._subs.add(this._notifySidelineShownSubject.pipe(si.v((e=>(0,ki.iu)(e)?e.sequentialId:e.id)),oi.z((e=>e.pipe(x.b(300))))).subscribe((e=>{this._logger.debug("Tracking vBarShown().",{vBar:e}),this._params.trackingService.vBarShown({vBar:e})}))),this._subs.add(this._notifySidelinePulsedSubject.pipe(x.b(300)).subscribe((e=>{this._logger.debug("Tracking vBar onboarding pulse.",{vBar:e}),this._params.onboardingService.notifyPulsatingShown(e)}))),this._subs.add(this._params.integration.selectionOrCaretPosition.subscribe(u.wW(this._selectionOrCaretPosition)));const i=[self,null===(t=this._params.integration.additionalGlobalEventSource)||void 0===t?void 0:t.scroll].filter((e=>!!e));this._subs.add((0,te.T)(...i.map((e=>(0,k.R)(e,"scroll",{capture:!0})))).pipe((0,Ze.p)(300)).subscribe((()=>{this._clearReservedSidelines()}))),this._setupDebugLogs(),this._subs.add(this._params.integration.highlightsLayoutInfo.mouseData.pipe((0,M.O)(null),(0,fi.b)((()=>{this._isSubdued.set(!1),this._params.paragraphCollectionService.resetEditingParagraphIndex()})),(0,l.w)((()=>(0,vi.H)(y.m9(3)).pipe((0,fi.b)((()=>{this._isSubdued.set(!0)})))))).subscribe()),this._setupVBarAccessibleActivation()}_setupDebugLogs(){this._subs.add(this._paragraphSidelines.subscribe((e=>this._logger.debug("Paragraph sidelines updated.",e)))),this._subs.add(this._pinnedSideline.subscribe((e=>this._logger.debug("Pinned sideline updated.",g.WG(e))))),this._subs.add(this._activeSideline.subscribe((e=>this._logger.debug("Active sideline updated.",g.WG(e))))),this._subs.add(this._emphasizedSideline.subscribe((e=>this._logger.debug("Emphasized sideline updated.",g.WG(e))))),this._subs.add(this._selectionSideline.subscribe((e=>this._logger.debug("Selection sideline updated.",g.WG(e))))),this._subs.add(this._vbarMousePositions.subscribe((e=>this._logger.debug("vBar mouse positions updated.",e))))}_setupSelectionSideline(){this._subs.add(Z.a([this._params.selectionHighlightViewModel.selectionHighlight,this._activeSideline,this._params.availabilityService.enabled.pipe(L.U((0,r.ls)(g.hX((e=>e.selectionSidelines)),g.pC)))]).pipe(d.h((([e,t,i])=>i)),d.h((([e,t])=>(0,r.zG)(mi.Yt(g.Kw)({selectionSideline:this._selectionSideline.get(),activeSideline:t}),g.g_(r.W8,(({selectionSideline:e,activeSideline:t})=>e.id!==t.id))))),L.U((([e])=>(0,r.zG)(e,g.UI((e=>function(e){return{...Ci(e,"selection"),sequentialId:ki.ZR,highlightRect:e.rect,selectionRects:e.selectionRects}}(e))))))).subscribe(u.wW(this._selectionSideline)))}_setupVBarAccessibleActivation(){if(!(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsAccessibleActivation))return;const e=new bi.J({textField:this._params.integration.getKeyboardEventsTarget(),kind:"openVBar",settings:this._params.keyboardShortcutsSetting,handler:()=>this._handleActivationShortcut()});this._disposables.push(e)}_handleActivationShortcut(){const e=this._selectionOrCaretPosition.get();if(g.Wi(e))return;const t=e.value.start===e.value.end?(0,r.zG)(this.paragraphSidelines.get().filter((t=>t.textRange.end>e.value.start&&t.textRange.start<=e.value.start)),wi.nI,g.UI(wi.YM)):this._selectionSideline.get();(0,r.zG)(t,g.UI((e=>{this.cardFocusedSidelineSequentialId.set(g.G(e.sequentialId)),this.pinSideline(e),(0,r.zG)(this.getSidelineHtmlElement(e.sequentialId),g.UI((e=>e.focus())))})))}_doesSequentialIdMatchRelevantSidelineSequentialId(e,t){return(0,r.zG)(t,g.g_(r.jv,(t=>t===e)))}_getSidelineBySequentialId(e){return e===ki.ZR?this._selectionSideline.get():g.ij(this._paragraphSidelineBySequentialId.get(e)||this._pushedContendSidelineBySequentialId.get(e))}_deactivateSideline(e,t=!1){this._logger.debug("Deactivating sideline.",{sidelineSequentialId:e,immediate:t}),this._emphasizedSidelineSequentialId.set(g.YP),this._doesSequentialIdMatchRelevantSidelineSequentialId(e,this._activeSidelineSequentialId.get())&&(this._deactivateSidelineSubs.unsubscribe(),this._deactivateSidelineSubs=this._sidelineCardActiveNotifications.pipe(d.h((t=>t===e)),c.q(1),R.h(!1),Si.L(t?0:this._deactivationTimeout,_e.of(!0))).subscribe((t=>{t?(this._logger.debug("Did not receive notification that corresponding sideline card is active, proceeding to deactivate sideline.",{sidelineSequentialId:e}),this._activeSidelineSequentialId.set(g.YP)):this._logger.debug("Received a notification that corresponding sideline card is active, won't deactivate sideline.",{sidelineSequentialId:e})})))}_unpinSideline(e){this._logger.debug("Unpinning sideline.",{sidelineSequentialId:e}),this._doesSequentialIdMatchRelevantSidelineSequentialId(e,this._pinnedSidelineSequentialId.get())?(this._pinnedSidelineSequentialId.set(g.YP),this._activeSidelineSequentialId.set(g.YP)):(this._params.telemetryService.warn({message:"Unpinning of an unpinned sideline attempted."}),this._logger.warn("Tried to unpin sideline that is not pinned, this is a no-op.",{sidelineSequentialId:e}))}_pinSideline(e){this._logger.debug("Pinning sideline.",{sidelineSequentialId:e}),this._pinnedSidelineSequentialId.set(g.G(e))}_clearReservedSidelines(){this._logger.debug("Clearing any pinned, active, or emphasized sidelines."),this._pinnedSidelineSequentialId.set(g.YP),this._activeSidelineSequentialId.set(g.YP),this._emphasizedSidelineSequentialId.set(g.YP),this._emphasizedSidelineSequentialIdByParagraphHighlight.set(g.YP),self.clearTimeout(this._activationTimeoutRef),this._activationTimeoutRef=void 0}activateSideline(e,t=!1){this._logger.debug("Activating sideline.",{sideline:e}),this._emphasizedSidelineSequentialId.set(g.G(e.sequentialId)),this._scheduleOpenVBarCard(e,t)}_scheduleOpenVBarCard(e,t){let i=(0,I.zq)(e.kind);g.pC(this._activeSideline.get())&&(i+=this._deactivationTimeout),self.clearTimeout(this._activationTimeoutRef),this._activationTimeoutRef=self.setTimeout((()=>{this._logger.debug("Opening vBar card for sideline.",{sideline:e}),t&&this._params.onboardingService.notifyPulsatingSeen(e),this._activeSidelineSequentialId.set(g.G(e.sequentialId)),this._deactivateSidelineSubs.unsubscribe()}),i)}deactivateSideline(e){self.clearTimeout(this._activationTimeoutRef),this._deactivateSideline(e.sequentialId)}pinSideline(e){this._pinSideline(e.sequentialId)}unpinSideline(e){this._unpinSideline(e.sequentialId)}getSideline(e){return this._getSidelineBySequentialId(e)}getSidelineCalliopeAlerts(e){return(0,r.zG)(this._getSidelineBySequentialId(e),g.hX(ki.jz),g.g_((()=>[]),(e=>this._params.alertCollectionService.getCalliopeAlertsWithinTextRange(e.textRange))))}getSidelineHtmlElement(e){return g.ij(this._htmlElementBySidelineSequentialId.get(e))}notifySidelineMounted(e){this._params.telemetryService.infoOncePerMessage({message:"Rendering sideline succeeded."})}notifySidelineShown(e){this._logger.debug("vBar shown (became visible)",{vBar:e}),this._notifySidelineShownSubject.next(e)}notifySidelineHidden(e){this._logger.debug("Sideline hidden (became invisible)",{sideline:e}),this._params.trackingService.vBarHidden({vBar:e})}notifySidelinePulsed(e){this._logger.debug("Sideline pulsed (onboarding)",{vBar:e}),this._notifySidelinePulsedSubject.next(e)}notifySidelineRefChanged(e,t){this._htmlElementBySidelineSequentialId.set(e.sequentialId,t)}notifySidelineCardActive(e,t){this._sidelineCardActiveNotifications.next(e),t&&this._pinSideline(e)}notifySidelineCardInactive(e,t){g.pC(this._pinnedSideline.get())?this._unpinSideline(e):g.pC(this._activeSideline.get())&&this._deactivateSideline(e,t)}setVBarMousePosition(e,t){t?this._vbarMousePositions.modify(pi.dx(e,"HoverVBar")):(0,_i.x3)()&&(0,r.zG)(this._emphasizedSideline.get(),g.hX((t=>t.id===e)),g.hX(ki.WE),g.tS((e=>(0,r.zG)(this._params.sidelineHighlightCollectionViewModel.emphasizedSidelineHighlight.get(),g.hX((t=>t.sequentialId===e.sequentialId))))),g.hX((e=>e.horizontalDistanceToPointer<=60)),g.pC)?this._vbarMousePositions.modify(pi.dx(e,"InsideSafeArea")):this._vbarMousePositions.modify(pi.EG(e))}dispose(){self.clearTimeout(this._activationTimeoutRef),this._activationTimeoutRef=void 0,this._deactivateSidelineSubs.unsubscribe(),this._subs.unsubscribe(),this._disposables.forEach((e=>e.dispose()))}}var Ri=i(79859);const Bi=({rect:e})=>e.top,Ei=({rect:e})=>e.top+e.height,Ii=e=>{if(e.length<2)return e;const t=e.sort(((e,t)=>Bi(e)-Bi(t))),i=[];let r=0,n=1,a=0;for(;r<e.length;){const e=t[r],s=t[n];void 0===s||Bi(s)>=Ei(e)?(0===a&&i.push(e),r=n,a=0):(Ei(s)<=Ei(e)||(r=n),a++),n++}return i};var Ti=i(5913),Pi=i(66016),Fi=i(95714),Mi=i(60247),Li=i(81617);function Di(e){return{kind:"paragraph",highlightId:B.y$.Id.create(`g2-paragraph-highlight-${e.textRange.start}-${e.textRange.end}`),paragraphId:e.id,paragraphSequentialId:e.sequentialId,alertId:"",highlightColor:null,highlightDisplayFormat:null,highlightLiveliness:null}}var Ai=i(25399);function zi(e,t){return{kind:"pushed_content",highlightId:B.y$.Id.create(`g2-pushed-content-highlight-${t.notification.notificationElement.range.start}-${t.notification.notificationElement.range.end}`),pushedContentId:e,alertId:"",highlightColor:null,highlightDisplayFormat:null,highlightLiveliness:null,sequentialId:e}}class Oi{constructor(e){this._params=e,this._subs=new s.w0,this._logger=(0,C.h)(Oi.name),this._sidelineHighlights=a.h.create([]),this._hoveredSidelineHighlight=a.h.create(g.YP),this.sidelineHighlights=this._sidelineHighlights.view(),this.emphasizedSidelineHighlight=this._hoveredSidelineHighlight.view();const t=this._params.pushedContentService.contentState.pipe(L.U((e=>(0,Li.X)(e).filter((([e,{notification:t}])=>"vBar"===t.notificationElement.kind)))),h.x(((e,t)=>(0,Li.vZ)(e,t))));this._subs.add(Z.a([this._params.paragraphCollectionService.paragraphs,t]).subscribe((([e,t])=>{this._params.sidelineHighlightCollectionGeometry.removeAllHighlights();for(const t of e){const e=Di(t);this._params.sidelineHighlightCollectionGeometry.addHighlight(e.highlightId,t.textRange,e)}for(const[e,i]of t){const t=zi(e,i);this._params.sidelineHighlightCollectionGeometry.addHighlight(t.highlightId,i.notification.notificationElement.range,t)}}))),this._subs.add(Z.a([this._params.integration.vBarsLayoutInfo.scrollMirrorLayout.rect,this._params.integration.vBarsLayoutInfo.scrollMirrorLayout.textField.paddingRect.behavior,this._params.sidelineHighlightCollectionGeometry.geometry.view((e=>Array.from(e.values()))),this._params.paragraphCollectionService.editingParagraphIndex,this._params.integration.vBarsLayoutInfo.scrollMirrorLayout.textStartPosition]).pipe(L.U((([e,t,i,n,a])=>{const s=i.filter(((e,t)=>n!==t)).filter((({meta:e})=>"paragraph"===e.kind)).reduce(((i,n)=>{return(0,r.zG)((s={highlightId:n.meta.highlightId.toString(),highlightRects:n.rects,paragraphId:n.meta.paragraphId,paragraphSequentialId:n.meta.paragraphSequentialId,scrollMirrorRect:e,textFieldPosition:t.client,textStartPosition:a,getVBarHighlightRect:this._params.integration.getVBarHighlightRect},(0,r.zG)(g.ij((0,ei.jr)(s.highlightRects)),g.UI((e=>Jt.toVBarsField({rect:e,textFieldPosition:s.textFieldPosition,vBarsScrollMirrorFieldPosition:s.scrollMirrorRect}))),g.UI((e=>({kind:"paragraph",id:s.highlightId,paragraphId:s.paragraphId,sequentialId:s.paragraphSequentialId,rect:s.getVBarHighlightRect({vBarTextRectInMirror:e,scrollMirrorRectInViewport:s.scrollMirrorRect,textStartPositionInViewport:s.textStartPosition})}))))),g.g_((()=>(this._params.telemetry.warn({message:"Creating highlight for paragraph failed."}),this._logger.warn("Failed to create paragraph highlight from highlight geometry. Skipping.",n),i)),(e=>i.concat(e))));var s}),[]),o=i.filter((({meta:e})=>"pushed_content"===e.kind)).reduce(((i,n)=>{return(0,r.zG)((s={highlightId:n.meta.highlightId.toString(),highlightRects:n.rects,pushedContentId:n.meta.pushedContentId,scrollMirrorRect:e,textFieldPosition:t.client,textStartPosition:a,getVBarHighlightRect:this._params.integration.getVBarHighlightRect},(0,r.zG)(g.ij((0,ei.jr)(s.highlightRects)),g.UI((e=>Jt.toVBarsField({rect:e,textFieldPosition:s.textFieldPosition,vBarsScrollMirrorFieldPosition:s.scrollMirrorRect}))),g.UI((e=>({kind:"pushed_content",id:s.highlightId,pushedContentId:s.pushedContentId,rect:s.getVBarHighlightRect({vBarTextRectInMirror:e,scrollMirrorRectInViewport:s.scrollMirrorRect,textStartPositionInViewport:s.textStartPosition}),sequentialId:s.pushedContentId}))))),g.g_((()=>(this._params.telemetry.warn({message:"Creating highlight for pushed content failed."}),this._logger.warn("Failed to create pushed content highlight from highlight geometry. Skipping.",n),i)),(e=>i.concat(e))));var s}),[]);return[...s.filter((({rect:e})=>void 0===o.find((({rect:t})=>Pi.UL.intersects(e,t))))),...o]})),L.U(Ii),fi.b((e=>this._logger.debug("Sideline highlights updated.",e)))).subscribe(u.wW(this._sidelineHighlights))),this._subs.add(te.T(this._params.integration.highlightsLayoutInfo.textFieldLayout.scroll.changes.pipe(R.h(g.YP)),this._params.integration.highlightsLayoutInfo.mouseData.pipe(Ri.U(Ti.S.hz30),D.skipBy(Mi.Z.eq),L.U((({client:e,offset:t})=>function(e,t,i,n,a,s,o){const l=(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsEmphasizingParagraph);if(!l&&null!==t&&null!==i&&(0,N._N)(t,n))return(0,r.zG)(e,(0,q.Ew)((e=>i.top>=e.rect.top&&i.top<=e.rect.top+e.rect.height)),g.UI((e=>(0,r.zG)(e,d(i,Jt.toTextField({rect:e.rect,textFieldPosition:a,vBarsScrollMirrorFieldPosition:s}))))));if(l&&null!==t){const i=Fi.p8.fromClientPoint(t,a,o);return null===Ai.o||void 0===Ai.o||Ai.o.drawRect({...t,width:8,height:8},{color:"green"},void 0,"mouse-absolute"),null===Ai.o||void 0===Ai.o||Ai.o.drawRect({...i,width:4,height:4},{color:"red"},{left:a.left-o.left,top:a.top-o.top},"mouse-relative"),null===Ai.o||void 0===Ai.o||Ai.o.drawRect({...a,width:20,height:20},{color:"blueviolet"},void 0,"text-field-rect"),null===Ai.o||void 0===Ai.o||Ai.o.drawRect({...s,width:20,height:20},{color:"teal",borderWidth:6},void 0,"scroll-mirror-rect"),(0,r.zG)(e,(0,q.f2)((e=>{const t=Jt.toTextField({rect:e.rect,textFieldPosition:a,vBarsScrollMirrorFieldPosition:s});return null===Ai.o||void 0===Ai.o||Ai.o.drawRect(t,{color:"green"},{left:a.left-o.left,top:a.top-o.top},e.id),(0,r.zG)(e,g.DT((()=>Pi.UL.contains(i,Pi.Wm.create(t)))),g.UI(d(i,t)))})))}return g.YP;function d(e,t){return i=>({...i,horizontalDistanceToPointer:Math.abs(e.left-t.left)})}}(this._sidelineHighlights.get(),e,t,this._params.integration.highlightsLayoutInfo.textFieldElement,this._params.integration.highlightsLayoutInfo.textFieldLayout.rect.getApproximate().client,Fi.Ir.create(this._params.integration.vBarsLayoutInfo.scrollMirrorLayout.rect.get()),this._params.integration.highlightsLayoutInfo.textFieldLayout.scroll.getApproximate()))))).subscribe(u.wW(this._hoveredSidelineHighlight)))}dispose(){this._subs.unsubscribe()}}class Gi{constructor(e){this._params=e,this._subs=new s.w0,this._logger=(0,C.h)(Gi.name),this._servicesAndViewModels=a.h.create(g.YP),this._integration="googleDocs"===this._params.integrationInfo.kind?new he({integrationInfo:this._params.integrationInfo,highlightsLayoutInfo:this._params.highlightsLayoutInfo,textObserver:this._params.textObserver,selectionSource:this._params.selectionSource,selectionOrCaretPosition:this._params.selectionOrCaretPosition,selectionService:this._params.selectionService,telemetryService:this._params.telemetryService}):new X({integrationInfo:this._params.integrationInfo,highlightsLayoutInfo:this._params.highlightsLayoutInfo,selectionService:this._params.selectionService,telemetryService:this._params.telemetryService,selectionOrCaretPosition:this._params.selectionOrCaretPosition,textObserver:this._params.textObserver}),this._replacementService=this._params.replacementServiceInjector.create(w.P.g2),this._trackingService=new Vt({checkingService:this._params.checkingService,gnarClient:this._params.gnarClient,integrationInfo:this._integration.info,telemetryService:this._params.telemetryService}),this._inlineAlertsFilter=a.h.create(r.W8),this.integration=this._integration,this.inlineAlertsFilter=this._inlineAlertsFilter.view(),this._logger.debug("Initializing vBars.",{kind:this._integration.info.kind,domain:this._integration.info.domain,integrationName:this._integration.info.integrationName,..."googleDocs"===this._integration.info.kind?{integrationMode:this._integration.info.integrationMode.get()}:void 0}),this._trackingService.vBarsInitialized();const t=this._params.checkingService.pipe(o.oA,l.w((e=>e.readyState)),d.h((e=>e===f.kQ.firstTextCheckCompleted)),c.q(1));this._subs.add(t.pipe(l.w((()=>this._integration.isEnabled.pipe(h.x())))).subscribe((e=>{e?(this._logger.debug("G2 integration enabled, initializing services and VMs."),this._init()):(this._logger.debug("G2 integration disabled, disposing services and VMs."),this._disposeServicesAndViewModels())}))),this._subs.add(this._servicesAndViewModels.pipe(l.w(g.g_((()=>this._params.alertClassification.visibleInlineAlertsFilter),(e=>e.alertCollectionService.inlineAlertsFilter)))).subscribe(u.wW(this._inlineAlertsFilter)))}_init(){var e,t;const i=new Mt({checkingService:this._params.checkingService,textChangeBuffer:this._params.textChangeBuffer,telemetryService:this._params.telemetryService,integration:this._integration,dynamicConfig:this._params.dynamicConfig,trackingService:this._trackingService}),r=new Ge({user:this._params.user,csPageState:this._params.csPageState,csToBgActions:this._params.csToBgActions,telemetryService:this._params.telemetryService,trackingService:this._trackingService}),n=new qe({textObserver:this._params.textObserver,integration:this._integration}),a=new Se({alertProcessor:this._params.alertProcessor,alertClassification:this._params.alertClassification,checkingService:this._params.checkingService,featureFlags:this._params.availabilityService.enabled}),s="test"===(0,v.OB)().experimentClient.getTreatment(b.p.G2VBarsPerceptionSurvey)?new Zt.JP(this._params.showSurvey,this._params.checkingService,this._params.telemetryService,null!==(t=null===(e=this._params.dynamicConfig.view("vBars").get())||void 0===e?void 0:e.perceptionSurveyDelayMs)&&void 0!==t?t:y.LK(6)):null,o=(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsCAPIMonetization)?new De({user:this._params.user,csPageState:this._params.csPageState,csToBgActions:this._params.csToBgActions,telemetry:this._params.telemetryService,checkingService:this._params.checkingService,capiStartAckMessage:this._params.capiStartAckMessage}):new Le({user:this._params.user,csPageState:this._params.csPageState,csToBgActions:this._params.csToBgActions,telemetry:this._params.telemetryService}),l=(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsPushedContent)?new Ke({checkingService:this._params.checkingService,capiStartAckMessage:this._params.capiStartAckMessage}):new Qe,d=(0,v.OB)().experimentClient.isGateEnabled(_.K.G2VBarsTrustedRewrite)?new jt({checkingService:this._params.checkingService,telemetryService:this._params.telemetryService}):new Nt,c=new S.C(this._integration.highlightsLayoutInfo.geometryProvider,this._integration.highlightsLayoutInfo.geometryLayout,(()=>this._params.textObserver.getCurrentTextMap()),this._integration.highlightGeometryFilter,this._integration.highlightGeometryInvalidator,!0,void 0,void 0,void 0,void 0),h=new Oi({paragraphCollectionService:n,sidelineHighlightCollectionGeometry:c,pushedContentService:l,integration:this._integration,telemetry:this._params.telemetryService}),u=new S.C(this._integration.highlightsLayoutInfo.geometryProvider,this._integration.highlightsLayoutInfo.geometryLayout,(()=>this._params.textObserver.getCurrentTextMap()),this._integration.highlightGeometryFilter,this._integration.highlightGeometryInvalidator,!0,void 0,void 0,void 0,void 0,(0,C.h)("SelectionHighlightGeometry")),m=new ti({selectionHighlightGeometry:u,paragraphHighlightCollectionViewModel:h,textObserver:this._params.textObserver,integration:this._integration}),p=new xi({paragraphCollectionService:n,alertCollectionService:a,pushedContentService:l,sidelineHighlightCollectionViewModel:h,textObserver:this._params.textObserver,selectionHighlightViewModel:m,legacyAssistantOpenState:this._params.legacyAssistantOpenState,assistantState:this._params.assistantState,telemetryService:this._params.telemetryService,trackingService:this._trackingService,onboardingService:r,availabilityService:this._params.availabilityService,integration:this._integration,user:this._params.user,keyboardShortcutsSetting:this._params.csPageState.view("keyboardShortcuts")}),f=new Xt({trackingService:this._trackingService,telemetryService:this._params.telemetryService,integrationInfo:this._integration.info}),w=new gi({rewriteService:i,sidelineCollectionViewModel:p,feedbackFormViewModel:f,performReplacement:(e,t)=>this._replacementService.performReplacement(e,t),telemetryService:this._params.telemetryService,integrationInfo:this._integration.info,trackingService:this._trackingService,alertCollectionService:a,monetizationService:o,trustedRewriteService:d,onboardingService:r,availabilityService:this._params.availabilityService,integration:this._integration});this._servicesAndViewModels.set(g.G({rewriteService:i,paragraphCollectionService:n,alertCollectionService:a,monetizationService:o,pushedContentService:l,onboardingService:r,paragraphHighlightCollectionGeometry:c,paragraphHighlightCollectionViewModel:h,selectionHighlightGeometry:u,selectionHighlightViewModel:m,sidelineCollectionViewModel:p,feedbackFormViewModel:f,sidelineCardViewModel:w,perceptionSurveyViewModel:s}))}_disposeServicesAndViewModels(){this._trackingService.dispose(),(0,r.zG)(this._servicesAndViewModels.get(),m.bw((e=>{var t;e.rewriteService.dispose(),e.paragraphCollectionService.dispose(),e.alertCollectionService.dispose(),e.paragraphHighlightCollectionGeometry.dispose(),e.paragraphHighlightCollectionViewModel.dispose(),e.selectionHighlightGeometry.dispose(),e.selectionHighlightViewModel.dispose(),e.sidelineCollectionViewModel.dispose(),e.sidelineCardViewModel.dispose(),e.monetizationService.dispose(),e.pushedContentService.dispose(),null===(t=e.perceptionSurveyViewModel)||void 0===t||t.dispose()}))),this._servicesAndViewModels.set(g.YP)}get vBarsUI(){const e="googleDocs"===this._params.integrationInfo.kind;return this._servicesAndViewModels.view(g.UI((({sidelineCollectionViewModel:t,monetizationService:i,onboardingService:r})=>n.createElement(n.Suspense,{fallback:n.createElement(n.Fragment,null)},n.createElement(Qt,{paragraphSidelines:t.paragraphSidelines,pinnedSideline:t.pinnedSideline,activeSideline:t.activeSideline,emphasizedSideline:t.emphasizedSideline,shouldHideSidelines:t.shouldHideSidelines,selectionSideline:t.selectionSideline,pulsatingOnboardingInfo:r.shouldShowPulsating,shouldShowSelectionHighlight:!e,vBarsQuotaInfo:i.vBarsQuotaInfo,shouldSubdueVBars:t.isSubdued,vBarMousePositions:t.vBarMousePositions,onPinSideline:e=>t.pinSideline(e),onActivateSideline:(e,i)=>t.activateSideline(e,i),onDeactivateSideline:e=>t.deactivateSideline(e),onMountSideline:e=>t.notifySidelineMounted(e),onShowSideline:e=>t.notifySidelineShown(e),onHideSideline:e=>t.notifySidelineHidden(e),onPulseSideline:e=>t.notifySidelinePulsed(e),onSidelineRefChange:(e,i)=>t.notifySidelineRefChanged(e,i),setVBarMousePosition:(e,i)=>t.setVBarMousePosition(e,i)})))))}get vBarCardUI(){return this._servicesAndViewModels.view(g.UI((({sidelineCardViewModel:e,monetizationService:t,onboardingService:i})=>n.createElement(n.Fragment,null,n.createElement(n.Suspense,{fallback:n.createElement(n.Fragment,null)},n.createElement($t,{isGateEnabledFn:(0,v.OB)().experimentClient.isGateEnabled},n.createElement(p.U8.Provider,{value:{hasSpecialOffer:this._params.hasInProductDiscountSpecialOffer}},n.createElement(Kt,{sidelineCard:e.sidelineCard,vBarsQuotaInfo:t.vBarsQuotaInfo,onboardingService:i,getSidelineCardState:t=>e.getSidelineCardState(t),onActivateSidelineCard:(t,i)=>e.activateSidelineCard(t,i),onDeactivateSidelineCard:(t,i)=>e.deactivateSidelineCard(t,i),onChangeSelectedRewriteTab:(t,i)=>e.notifySelectedRewriteTabChanged(t,i),onMountRewriteLoading:(t,i)=>e.notifyRewriteLoadingShown(t,i),onMountRewriteEmpty:(t,i)=>e.notifyRewriteEmptyShown(t,i),onMountRewriteReady:(t,i,r)=>e.notifyRewriteReadyShown(t,i,r),onMountRewriteError:(t,i)=>e.notifyRewriteErrorShown(t,i),onApplyRewrite:(t,i)=>e.applyRewrite(t,i),onCopyRewrite:(t,i)=>e.copyRewrite(t,i),onRevertRewrite:(t,i)=>e.notifyRewriteReverted(t,i),onDismissRewrite:(t,i)=>e.dismissRewrite(t,i),onRegenerateRewrite:(t,i)=>e.regenerateRewrite(t,i),onChangeCustomPrompt:(t,i)=>e.notifyCustomPromptChanged(t,i),onSubmitCustomPrompt:(t,i)=>e.submitCustomPrompt(t,i),onClickMoreTab:t=>e.notifyMoreTabClicked(t),onShow:(t,i)=>e.notifySidelineCardShown(t,i),onClose:t=>e.notifySidelineCardClosed(t),onClickFeedbackButton:(t,i)=>e.notifyFeedbackButtonClicked(t,i),onShowUphookButton:(t,i)=>e.notifyUphookButtonShown(t,i,this._params.hasInProductDiscountSpecialOffer),onClickUphookButton:(t,i)=>e.notifyUphookButtonClicked(t,i,this._params.hasInProductDiscountSpecialOffer),onStreamingStart:(t,i)=>e.notifyRewriteStreamingStart(t,i),onDeactivateSidelineType:(t,i,r)=>e.deactivateSidelineType(t,i,r),integration:this._integration})))),n.createElement("div",{id:ue.wE,style:{position:"fixed",pointerEvents:"none"}})))))}get vBarsFeedbackFormUI(){return this._servicesAndViewModels.view(g.UI((({feedbackFormViewModel:e})=>n.createElement(n.Suspense,{fallback:n.createElement(n.Fragment,null)},n.createElement(Yt,{feedbackFormContext:e.feedbackFormContext,onSubmit:(t,i)=>e.submitFeedbackForm(t,i),onClose:()=>e.closeFeedbackForm()})))))}dispose(){this._disposeServicesAndViewModels(),this._integration.dispose(),this._subs.unsubscribe()}}},77837:(e,t,i)=>{i.r(t),i.d(t,{injectUI:()=>B});var r=i(49231),n=i(47387),a=i(59179),s=i(58303),o=i(25419),l=i(29037),d=i(88637),c=i(598),h=i(45013),u=i(67271),g=i(89289),m=i(17519),p=i(95804);const v=({children:e})=>r.createElement(g.o,{style:(0,h.OB)().experimentClient.isGateEnabled(p.K.VBarsInjectionContainerDisplayContents)?{display:"contents"}:void 0},r.createElement(c.w,null,r.createElement(m.p,null,r.createElement(u.L,{chunkName:"g2"},e))));const f={zIndex:i(51318).op,position:"absolute",top:0,left:0,width:"100%",pointerEvents:"all"};var S=i(96653);var w=i(37213),b=i(84308),_=i(25399),y=i(23574);function C(e){return{boxSizing:"content-box",position:"relative",pointerEvents:"none",overflow:"hidden",border:0,borderRadius:0,padding:0,margin:0,...e}}const k=e=>e.layout.scrollables.reduce(((t,i,s,o)=>r.createElement(n.F.div,{"data-testid":`grammarly-vbars-scroll-mirror-${s}`,style:i.borderRect.behavior.pipe(a.U((t=>C(s===o.length-1?{...e.layout.adjustSizeBeforeRendering(t.size),...e.layout.adjustOffsetBeforeRendering({top:t.offset.top,left:t.offset.left}),...null===_.o||void 0===_.o?void 0:_.o.getDebugMirrorStyles()}:{top:t.offset.top,left:0,width:"100%",height:t.size.height})))),mount:(0,w.y2)({scrollTop:i.scroll.behavior.pipe(a.U((e=>e.top))),scrollLeft:i.scroll.behavior.pipe(a.U((e=>e.left)))})},t,r.createElement(n.F.div,{style:i.scrollSize.behavior.pipe(a.U((e=>({boxSizing:"content-box",left:0,width:"100%",height:e.height,pointerEvents:"none",visibility:"hidden"}))))}))),r.createElement(x,{layout:e.layout},e.children)),x=e=>{const t=(0,y.M)({scrollTop:b.a([e.layout.textField.scroll.behavior,e.layout.textField.scrollSize.behavior]).pipe(a.U((([e,t])=>e.top))),scrollLeft:b.a([e.layout.textField.scroll.behavior,e.layout.textField.scrollSize.behavior]).pipe(a.U((([e,t])=>e.left)))});return r.createElement(n.F.div,{"data-testid":"grammarly-vbars-field-mirror",style:b.a([e.layout.textField.transform.behavior,e.layout.textField.paddingRect.behavior]).pipe(a.U((([t,i])=>C({...0===e.layout.scrollables.length?{...e.layout.adjustSizeBeforeRendering(i.size),...e.layout.adjustOffsetBeforeRendering({top:i.offset.top,left:i.offset.left})}:{top:i.offset.top,left:0,width:"100%",height:i.size.height},...t})))),mount:e=>t(e)},e.children)};var R=i(4419);function B(e){const{integration:t,vBarsUI:i,vBarCardUI:c,vBarsFeedbackFormUI:u,eventPropagationHandler:g}=e,m=(e=>{const t={position:"absolute",top:0,left:0,pointerEvents:"none",maxWidth:"100vw",...e.integration.vBarsLayoutInfo.scrollMirrorContainerStyleOverrides};return d.V.get({monitorAs:R.C}).inject(l.EM.fromDocument(document,R.A),(t=>{(0,h.OB)().experimentClient.isGateEnabled(p.K.VBarsInjectionContainerDisplayContents)&&(t.style.display="contents"),e.integration.vBarsLayoutInfo.injectionPlace.appendChild(t)}),(i=>o.G7.showWhenLoaded(r.createElement(v,null,r.createElement(n.F.Fragment,null,e.vBarsUI.pipe(a.U(s.g_((()=>null),(i=>r.createElement("div",{"data-testid":"grammarly-vbars-scroll-mirror-container",style:t},r.createElement(k,{layout:e.integration.vBarsLayoutInfo.scrollMirrorLayout},r.createElement(n.F.div,{style:e.integration.vBarsLayoutInfo.scrollMirrorLayout.textField.scrollSize.behavior.pipe(a.U((e=>({width:0,height:e.height,pointerEvents:"all"}))))},i))))))))))(i)),{eventPropagationHandler:e.eventPropagationHandler})})({integration:t,vBarsUI:i,eventPropagationHandler:g}),w=(e=>d.V.get({monitorAs:S.Vt}).inject(l.EM.fromDocument(document,S.Hq),l.zs.appendChild(e.textFieldElement.ownerDocument.documentElement),(t=>o.G7.showWhenLoaded(r.createElement(v,null,r.createElement(n.F.Fragment,null,e.vBarCardUI.pipe(a.U(s.g_((()=>null),(e=>r.createElement("div",{style:f},e))))))))(t)),{eventPropagationHandler:e.eventPropagationHandler,vBarsCustomAttributes:e.domain.includes("atlassian.net")?{"data-no-focus-lock":"true"}:void 0}))({textFieldElement:t.highlightsLayoutInfo.textFieldElement,vBarCardUI:c,eventPropagationHandler:g,domain:e.domain}),b=(e=>d.V.get({monitorAs:"vBarsFeedbackForm"}).inject(l.EM.fromDocument(document,"grammarly-extension-vBars-feedback-form"),l.zs.appendChild(e.textFieldElement.ownerDocument.documentElement),o.G7.showWhenLoaded(r.createElement(v,null,r.createElement(n.F.Fragment,null,e.vBarsFeedbackFormUI.pipe(a.U(s.g_((()=>null),(e=>r.createElement("div",{style:f},e)))))))),{eventPropagationHandler:e.eventPropagationHandler}))({textFieldElement:t.highlightsLayoutInfo.textFieldElement,vBarsFeedbackFormUI:u,eventPropagationHandler:g});return{dispose(){m.dispose(),w.dispose(),b.dispose()}}}},4419:(e,t,i)=>{i.d(t,{A:()=>n,C:()=>r});const r="vBars",n="grammarly-extension-vBars"},25399:(e,t,i)=>{i.d(t,{o:()=>s});const r=()=>[void 0,void 0],[n,a]=r();const s=a},93930:(e,t,i)=>{function r(e,t){return 0===e.quota&&!e.usedVBarsTextHashList.includes(t)}i.d(t,{Q:()=>r})},86722:(e,t,i)=>{var r;i.d(t,{X:()=>r,_:()=>n}),function(e){e.accept="accept",e.rewriteOptions="rewriteOptions",e.customPrompt="customPrompt",e.revert="revert"}(r||(r={}));const n=new Set(Object.values(r))},50048:(e,t,i)=>{i.d(t,{G:()=>n});var r=i(42131);function n(e){let t="";return e.forEach((([e,i])=>{switch(e){case r.FS.Operation.RETAIN:t+=i+", ";break;case r.FS.Operation.INSERT:" "===i?t+="insert, space, ":(t+="insert, ",t+=a(i),t+=", ");break;case r.FS.Operation.DELETE:" "===i?t+="delete, space, ":(t+="delete, ",t+=a(i),t+=", ")}})),t}function a(e){return e.replace(/\n/gm," line break ").replace(//gm," paragraph ").replace(//gm," bullet point ").replace(/,/gm," comma ").replace(/\./gm," period ").replace(/\(/gm," open parenthesis ").replace(/\)/gm," closed parenthesis ").replace(/-/gm," hyphen ").replace(//gm," en dash ").replace(//gm," em dash ").replace(/:/gm," colon ").replace(/;/gm," semicolon ").replace(/!/gm," exclamation mark ").replace(/\?/gm," question mark ").replace(//gm," ellipsis ").replace(/\*/gm," asterisk ").replace(/'/gm," apostrophe ").replace(/`/gm," grave accent ").replace(/"/gm," quotation mark ").replace(/"/gm," quotation mark ").replace(/'/gm," quotation mark ").replace(/'/gm," quotation mark ")}},77726:(e,t,i)=>{var r,n,a,s;i.d(t,{NK:()=>u,Oy:()=>g,es:()=>o,z7:()=>h}),function(e){e.is=function(e){return"improve"===e.kind}}(r||(r={})),function(e){e.is=function(e){return"rephrase"===e.kind}}(n||(n={})),function(e){e.is=function(e){return"customPrompt"===e.kind}}(a||(a={})),function(e){e.is=function(e){return"other"===e.kind}}(s||(s={}));const o=r.is;n.is,a.is,s.is;var l,d,c;!function(e){e.is=function(e){return"loading"===e.kind}}(l||(l={})),function(e){e.is=function(e){return"ready"===e.kind}}(d||(d={})),function(e){e.is=function(e){return"error"===e.kind}}(c||(c={}));const h=l.is,u=d.is,g=c.is},11669:(e,t,i)=>{i.d(t,{PA:()=>o,TM:()=>a,gK:()=>s,l7:()=>l,qt:()=>u,t:()=>d,zH:()=>c,zq:()=>h});var r=i(64297),n=i(13642);const a=4,s=15,o=8,l=o+a+s,d=s,c=1e3;function h(e){return"signaling"===e||"pushed_content"===e?250:"idle"===e?700:"selection"===e?450:void(0,r.L0)(e)}function u(){return{"--idle-vbar-animation-duration":`${h("idle")}ms`,"--active-vbar-width":`${s}px`,"--idle-initial-width":((0,n.x3)()?"5":"3")+"px"}}},84907:(e,t,i)=>{i.r(t),i.d(t,{FeedbackForm:()=>c});var r=i(90023),n=i(49231),a=i(47387),s=i(58303),o=i(73285),l=i(90616);const d=({domain:e,onSubmit:t,onClose:i})=>{const[r,a]=n.useState(!0);return n.createElement(o.u_,{"data-testid":"grammarly-g2-feedback-form-modal",width:"small",title:"How do you like Grammarly?",isOpen:r,onClose:()=>{a(!1),i()}},n.createElement(o.u_.Body,null,n.createElement(l.q,{withScore:!0,hideTitle:!0,hideTextBoxTitle:!0,hideLogo:!0,hideDomainHelpText:!0,domainSharedByDefault:!0,domain:e,showPostSubmitScreen:!1,showShareTextCheckbox:!0,onSubmit:e=>{a(!1),t(e)}})))},c=({feedbackFormContext:e,onSubmit:t,onClose:i})=>n.createElement(a.F.Fragment,null,e.view((0,r.ls)(s.UI((e=>n.createElement(d,{domain:e.domain,onSubmit:i=>t(i,e),onClose:()=>i()}))),s.WG)))},7096:(e,t,i)=>{i.r(t),i.d(t,{SidelineCardWrapper:()=>bt});var r=i(90023),n=i(49231),a=i(47387),s=i(13391),o=i(59179),l=i(954),d=i(78129),c=i(58303);const h=({as:e="div",className:t,show:i,transitionDurationMs:r=250,display:a="inline-block",ariaHidden:s,children:o})=>{const[l,d]=n.useState(!1),[c,h]=n.useState(!1);n.useEffect((()=>{let e;d(!0),i||(e=self.setTimeout((()=>d(!1)),r)),h(!i);const t=self.setTimeout((()=>h(i)),0);return()=>[e,t].forEach(clearTimeout)}),[i]);const u={display:a,opacity:c?1:0,transition:`opacity ${r}ms`},g=e;return l&&o?n.createElement(g,{className:t,style:u,"data-testid":"grammarly-g2-fade-wrapper","aria-hidden":s},o):null};var u,g=i(93930);!function(e){e.isNotification=function(e){return"notification"===e.kind},e.isCard=function(e){return"card"===e.kind}}(u||(u={}));var m=i(84308),p=i(86722);const v=n.createContext({shouldShowTooltip:!1,sideline:null,currentStep:p.X.accept,acceptCount:0,rootElement:null,incrementAcceptCount:r.Q1,incrementRevertPresentedCount:r.Q1,onNextStep:r.Q1,onHide:r.Q1}),f={accept:{tooltipText:"Accept all changes to your paragraph",ctaText:"Next"},rewriteOptions:{tooltipText:"Try different ways to write it",ctaText:"Next"},customPrompt:{tooltipText:"Tell us how to change it",ctaText:"Try it"}};function S({onboardingService:e,children:t,rootElement:i,sideline:r}){const[a,s]=n.useState({shouldShowTooltip:e.shouldShowTooltip.get(),sideline:r,currentStep:e.currentStep.get(),acceptCount:e.acceptCount.get(),rootElement:i,incrementAcceptCount:()=>e.incrementAcceptCount(),incrementRevertPresentedCount:()=>e.incrementRevertPresentedCount(),onNextStep:t=>e.onNextStep(t),onHide:t=>e.onHide(t)});return n.useEffect((()=>{s((e=>({...e,rootElement:i})))}),[i]),n.useEffect((()=>{s((e=>({...e,sideline:r})))}),[r]),n.useEffect((()=>{const t=(0,m.a)([e.shouldShowTooltip,e.currentStep,e.acceptCount]).subscribe((([e,t,i])=>s((r=>({...r,shouldShowTooltip:e,currentStep:t,acceptCount:i})))));return()=>t.unsubscribe()}),[e]),n.createElement(v.Provider,{value:a},t)}function w(e){const{currentStep:t,shouldShowTooltip:i,sideline:r,rootElement:a,incrementAcceptCount:s,onNextStep:o,onHide:l}=n.useContext(v),{tooltipText:d,ctaText:c}=f[e];return{ctaText:c,rootElement:a,showTooltip:i&&t===e,tooltipText:d,incrementAcceptCount:s,onNextStep:()=>o(r),onHide:()=>l(r)}}var b=i(23560),_=i(23934),y=i(81580),C=i(71564),k=i(73511),x=i(15420);const R=({children:e,quota:t,showUphook:i})=>void 0===t?e:n.createElement("div",{className:x.monetizationWrapper},n.createElement(b.k,{gap:1,align:"center",justify:"start",className:x.monetizationTitle},n.createElement(_.J,{icon:y.O,variant:"premium",accessibilityLabel:"",className:x.premiumIcon}),n.createElement(C.x,{as:"strong",variant:"text-xsmall",className:x.monetizationProText,"aria-label":"Pro suggestion","data-testid":"grammarly-g2-sideline-card-monetization-wrapper-pro-text"},"Pro"),n.createElement(_.J,{icon:k.M,accessibilityLabel:"",size:"small",variant:"inherit",className:x.monetizationDividerDot}),n.createElement(b.k,{align:"center",gap:1,"data-testid":"grammarly-g2-sideline-card-monetization-wrapper-title"},!i&&n.createElement(C.x,{as:"strong",variant:"text-xsmall"},t),n.createElement(C.x,{as:"p",variant:"text-xsmall"},i?"Youre out of free paragraph rewrites for today":"free paragraph rewrites left today"))),e);var B=i(22299),E=i(37540),I=i(49839),T=i(96762),P=i(56131),F=i(42954),M=i(37213),L=i(37036);function D({className:e,onboardingStep:t,children:i}){if(!i||!n.isValidElement(i))throw new Error("FtuxTooltip: children must be a valid React element");const{showTooltip:r,tooltipText:a,ctaText:s,rootElement:o,onNextStep:l,onHide:d}=w(t),[c,h]=n.useState(r),u=n.useRef(null),g=()=>{h(!1),l()};return n.useEffect((()=>{h(r)}),[r]),r?n.createElement(I.u,{open:c,placement:"right"},n.createElement(I.aJ,{asChild:!0},n.createElement("span",{ref:u,onClickCapture:g,...(0,M.Sh)(e,c?L.FtuxTooltipOutline:void 0)},i)),n.createElement(I._v,{style:{maxWidth:"unset"},root:o},n.createElement(b.k,{align:"center",justify:"center",className:L.FtuxTooltipContent,"data-testid":"grammarly-g2-ftux-tooltip-content"},n.createElement(C.x,{as:"span",variant:"text-xsmall"},a),n.createElement(T.z,{variant:"ghost",size:"small",style:{marginLeft:"var(--space-2"},onClick:g},s),n.createElement(P.h,{accessibilityLabel:"Dismiss",variant:"tertiary",icon:F.V,size:"small",style:{marginLeft:"var(--space-1)"},tooltipContentProps:{children:n.createElement(C.x,{variant:"text-xsmall",as:"span"},"Dismiss")},onClick:()=>{h(!1),d()}})))):n.createElement(n.Fragment,null,i)}var A=i(24969),z=i(50680),O=i(19501),G=i(29227),U=i(29804);const H=({className:e,...t})=>n.createElement(E.z,{...(0,M.Sh)(U.sidelineCardButton,e),variant:"tertiary",size:"small",...t});var q=i(64297),V=i(3190),N=i(48368);function j({errorDetails:e,errorReason:t}){switch(t){case"sensitivity":return["Can't help with this text","Grammarly assistance is unavailable because the text may contain sensitive content. Try with different text."];case"unsupportedLanguage":return["Can't help with this text","Grammarly only works with English language text."];case"serviceLimitExceeded":return["See more suggestions tomorrow","You've reached your suggestion limit for the day. It resets tomorrow."];case"backendError":return["Something went wrong","Please wait a moment, then try again."]}return e?["Assistance unavailable",e]:["Couldn't generate ideas","Please wait a moment, then try again."]}const W=({errorDetails:e,errorReason:t,onMount:i})=>(B.P.useEffectOnDidMount((()=>i())),n.createElement(b.k,{direction:"column",align:"center",gap:.5,padding:8,"data-testid":"grammarly-g2-sideline-card-rewrite-error"},n.createElement(_.J,{icon:N.F,size:"large",variant:"warning",accessibilityLabel:"","data-testid":"grammarly-g2-sideline-card-rewrite-error-icon"}),n.createElement(C.x,{as:"p",variant:"text-medium",color:"base-default",align:"center","data-testid":"grammarly-g2-sideline-card-rewrite-error-title"},(0,V.li)(j({errorDetails:e,errorReason:t}))),n.createElement(C.x,{as:"p",variant:"text-small",color:"base-subdued",align:"center","data-testid":"grammarly-g2-sideline-card-rewrite-error-subtitle"},(0,V.Yg)(j({errorDetails:e,errorReason:t})))));var $=i(89505),Y=i(75487),K=i(91989),Q=i(84714),X=i(30069),J=i(74399);function Z(e){const t=n.useRef({value:e,prev:null}),i=t.current.value;return e!==i&&(t.current={value:e,prev:i}),t.current.prev}function ee(e){const[t,i]=n.useState(!1),[r,a]=n.useState(!1),s=()=>{requestAnimationFrame((()=>{const t=e.current;t&&(i(t.scrollTop>0),a(Math.ceil(t.scrollTop+t.clientHeight)<t.scrollHeight))}))};return n.useEffect((()=>{if(!e.current)return;const t=new ResizeObserver((t=>{requestAnimationFrame((()=>{for(const i of t)if(i.target===e.current&&i.contentRect){const t=e.current;a(Math.ceil(t.scrollTop+t.clientHeight)<t.scrollHeight)}}))}));return t.observe(e.current),()=>t.disconnect()})),n.useEffect((()=>{const t=e.current;if(t)return t.addEventListener("scroll",s),()=>{t.removeEventListener("scroll",s)}}),[e]),{showTopScrollLimit:t,showBottomScrollLimit:r}}const te=({maxHeight:e,streamedText:t,onMount:i,onStreamingStart:r})=>{const a=n.useRef(null),s=Z(t);n.useEffect((()=>{!s&&t&&r()}),[s,t]),B.P.useEffectOnDidMount((()=>i()));const{showBottomScrollLimit:l,showTopScrollLimit:d}=ee(a);return n.useEffect((()=>{a.current&&(a.current.scrollTop=a.current.scrollHeight)}),[t]),n.createElement(b.k,{"data-testid":"grammarly-g2-sideline-card-rewrite-loading-skeleton",style:{maxHeight:e}},n.createElement(Y.g,{accessibilityLabel:"Loading rewrite",label:"Loading rewrite",width:"100%"},n.createElement(b.k,{gap:4,height:"100%"},n.createElement(Y.g.Rectangle,{width:3,height:"100%"}),n.createElement(b.k,{direction:"column",width:"100%",height:"100%",gap:3},n.createElement("div",{"data-testid":"grammarly-g2-sideline-card-rewrite-loading-skeleton-content",ref:a,...(0,M.Sh)(l&&J.scrollBottomLimit,d&&J.scrollTopLimit),style:{overflow:"auto"}},n.createElement(b.k,{style:{flex:"0 0 auto",marginBottom:"5px"}},n.createElement(Y.g.Heading,{variant:"heading-small",width:"50%"})),t?n.createElement(X.z,{animationDurationMs:500},Q.of(t).pipe(o.U((()=>n.createElement(ie,{text:t}))))):n.createElement(b.k,{direction:"column",width:"100%",align:"start"},n.createElement(Y.g.Text,{variant:"text-small",width:"100%"}),n.createElement(Y.g.Text,{variant:"text-small",width:"100%"}),n.createElement(Y.g.Text,{variant:"text-small",width:"100%"}))),n.createElement(b.k,{justify:"space-between",style:{flex:"0 0 auto"}},n.createElement(b.k,null,n.createElement(Y.g.Button,{size:"small",width:60})),t?n.createElement(K.a,{accessibilityLabel:"Loading rewrite content"},n.createElement(K.a.Branded,{size:"small"})):null)))))},ie=({text:e=""})=>{const[t,i]=n.useState((()=>[e])),r=Z(e)||"";return n.useEffect((()=>{if(0===r.length)return;const t=e.slice(r.length);i((e=>[...e,t]))}),[e,r]),n.createElement("div",null,t.map(((e,t)=>n.createElement("span",{key:`${e}-${t}`,className:J.fadeInAnimation},n.createElement(C.x,{as:"span",variant:"text-small"},e)))))};var re=i(76041),ne=i(50048),ae=i(42131),se=i(40455),oe=i(45013),le=i(88657),de=i(95804),ce=i(90944),he=i(28893),ue=i(62984);const ge=({className:e})=>n.createElement(_.J,{...(0,M.Sh)(ue.sidelineCardGrammarlyLogo,e),size:"small",icon:he.p,accessibilityLabel:"Grammarly logo","data-testid":"grammarly-g2-sideline-card-grammarly-logo"});var me=i(19232),pe=i(21686),ve=i(53186),fe=i(71497),Se=i(31529),we=i(45678),be=i.n(we);const _e=n.forwardRef((({children:e,diffs:t,diffAccessibilityLabel:i,onHidePopover:r,onMount:a,onRevert:s,onShowPopover:o,groupID:l},d)=>{const c=n.useRef(null),h=n.useRef(null);if(n.useEffect((()=>{a&&c.current&&h.current&&a({diffs:t,referenceElement:c.current,diffSpanElement:h.current,groupID:l})}),[]),!s)return n.createElement("span",{"aria-hidden":!0},e);const u=()=>{c.current&&h.current&&o({diffs:t,referenceElement:c.current,diffSpanElement:h.current,groupID:l})};return n.createElement("span",{ref:(0,Se.l)([d,c]),"data-testid":"grammarly-g2-revertible-rewrite-diff",role:"button",className:we.revertibleRewriteDiffButton,"aria-label":`Undo ${i||""} this cannot be redone. Focus will be on the next undoable rewrite`,tabIndex:0,onBlur:r,onClick:()=>s(t),onFocus:u,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),s(t))},onMouseOver:u},n.createElement("span",{ref:h,"aria-hidden":!0},e))}));_e.displayName="RevertibleRewriteDiff";var ye=i(21734),Ce=i(55367);const ke=e=>{const{x:t,y:i,width:r,height:n}=e;return[{x:t,y:i},{x:t+r,y:i},{x:t+r,y:i+n},{x:t,y:i+n}]},xe=({largeArcFlag:e=0,radius:t=2,isClockwise:i=!0,end:r})=>`a ${t},${t} 0 ${e} ${i?1:0} ${r.dx},${r.dy} `,Re=(e=!0)=>xe({end:{dx:2,dy:2},isClockwise:e}),Be=(e=!0)=>xe({end:{dx:-2,dy:2},isClockwise:e}),Ee=(e=!0)=>xe({end:{dx:-2,dy:-2},isClockwise:e}),Ie=(e=!0)=>xe({end:{dx:2,dy:-2},isClockwise:e}),Te=({className:e,rects:t,referenceRect:i,...r})=>{const a=(e=>{const t=[];let i={x:0,y:0},r="";const[n,a,s]=ke(e[0]),o=n;r+=`M ${n.x+2} ${n.y} `,r+=`H ${a.x-2} `,r+=Re(),i=s,e.forEach((e=>{const[n,a,s,o]=ke(e),l=a.x>i.x;a.x!==i.x&&(r+=l?Re(!1):Be(),r+=`H ${a.x+(l?-2:2)} `,r+=l?Re():Be(!1)),r+=`V ${s.y-2} `,t.push(n,o),i=s}));const l=t[t.length-1];for(r+=Be(),r+=`H ${l.x+2} `,r+=Ee(),i=l;t.length>0;){const e=t.pop(),n=t.pop(),a=e.x>i.x;e.x!==i.x&&(r+=a?Ie():Ee(!1),r+=`H ${e.x+(a?-2:2)} `,r+=a?Ie(!1):Ee()),r+=`V ${n.y+2} `,i=n}return r+=`V ${o.y} Z`,r})(t.map((e=>({x:e.x-i.x-2,y:e.y-i.y-2,width:e.width+4,height:e.height+4})))),s={width:i.width,height:i.height};return n.createElement("svg",{...(0,M.Sh)(Ce.svg,e),style:s,"data-testid":"grammarly-g2-revertible-rewrite-outline",...r},n.createElement("path",{className:Ce.path,d:a,stroke:ye.NeutralGray100,strokeWidth:"2px"}))};var Pe=i(73352);const Fe=e=>{const{children:t,renderer:i}=e,r=t.split("\n");return n.createElement(n.Fragment,null,r.map(((e,t)=>t>0?0===e.length?n.createElement("br",{key:`${t}_br`}):[n.createElement("br",{key:`${t}_br`}),n.createElement(n.Fragment,{key:t},i(e))]:0===e.length?[]:n.createElement(n.Fragment,{key:t},i(e)))).flat())},Me={color:pe.I.Text.Addition.Default,background:"rgba(177, 240, 232, 0.5)",fontWeight:"bold"},Le={color:"#696969",backgroundColor:"rgba(156, 156, 156, 0.2)",textDecoration:"line-through"},De={color:pe.I.Text.Base.Default},Ae=({diff:e,displayDeletes:t,blur:i,onRevert:a=r.Q1,onFocusLost:s=r.Q1})=>{const[o,l]=n.useState(!1),{showOnboarding:d,onShow:u}=function(){const{currentStep:e,shouldShowTooltip:t,incrementRevertPresentedCount:i}=n.useContext(v);return{showOnboarding:t&&e===p.X.revert,onShow:()=>i()}}(),[g,m]=n.useState(d),[f,S]=n.useState(null),[w,b]=n.useState(null),[_,y]=n.useState(null),[k,x]=n.useState([]),[R,B]=n.useState(0),[E,I]=n.useState(null),{styles:T,attributes:P}=(0,me.D)(_,E,{placement:"top-start",modifiers:[{name:"offset",options:{offset:[-3,2]}}]}),F=n.useRef(null),L=n.useRef(new Map);n.useEffect((()=>(g&&(F.current=self.setTimeout((()=>{m(!1),l(!1),u()}),2500)),()=>{F.current&&self.clearTimeout(F.current)})),[g]),n.useEffect((()=>{w&&y({getBoundingClientRect:()=>w.getClientRects()[0],contextElement:w.ownerDocument.body})}),[w]);const D=(0,oe.OB)().experimentClient.isGateEnabled(de.K.G2VBarsRevertRewrite),A=({diffs:e,referenceElement:t,diffSpanElement:i,groupID:r})=>{l(!0),S((0,fe.bp)(t)),b(i),x(e),B(r)},z=()=>{m(!1),F.current&&self.clearTimeout(F.current)},O=({diffs:e,referenceElement:t,diffSpanElement:i,groupID:r})=>{m(!0),A({diffs:e,referenceElement:t,diffSpanElement:i,groupID:r})},G=()=>l(!1),U=()=>{l(!0),z()},H=({diffs:e,referenceElement:t,diffSpanElement:i,groupID:r})=>{z(),A({diffs:e,referenceElement:t,diffSpanElement:i,groupID:r})},q=()=>{a(k),l(!1),b(null),x([]),B(0),setTimeout((()=>{const e=Array.from(L.current.keys()).sort(((e,t)=>e-t)),t=e.findIndex((e=>e>R)),i=L.current.get(e[t])||L.current.values().next().value;i?i.focus():s()}),0)},V=(0,ae.jy)(e);let N=!1;return n.createElement("p",{...(0,M.Sh)(Pe.sidelineCardRewriteDiff,i&&Pe.sidelineCardRewriteDiffBlurred),"data-testid":"grammarly-g2-sideline-card-rewrite-diff"},V.map((({groupID:e,diffs:a,showDeletions:s,showRetainsAsInserts:o})=>{const l=a.some((([e])=>e===ae.FS.Operation.DELETE||e===ae.FS.Operation.INSERT)),d=D&&l&&t&&!i,h=d&&!N&&g,u=(0,r.zG)(a,ve.nI,c.UI(ne.G),c.FS);return N=N||d,n.createElement(_e,{key:e,groupID:e,diffs:a,diffAccessibilityLabel:u,onHidePopover:G,onMount:h?O:void 0,onRevert:d?q:void 0,onShowPopover:H,ref:t=>{t?L.current.set(e,t):L.current.delete(e)}},a.map(((e,i)=>{const[r,l]=e;switch(r){case ae.FS.Operation.DELETE:return t&&s?n.createElement(C.x,{as:"span",variant:"text-small",key:i,style:Le},l):null;case ae.FS.Operation.INSERT:{const e=a.length,t=" "===l&&e>1?De:Me;return n.createElement(Fe,{key:i,renderer:e=>n.createElement(C.x,{as:"span",variant:"text-small",style:t},e)},l)}case ae.FS.Operation.RETAIN:{const e=o?Me:De;return n.createElement(Fe,{key:i,renderer:t=>n.createElement(C.x,{as:"span",variant:"text-small",style:e},t)},l)}}})))})),f&&w&&n.createElement(h,{className:Pe.sidelineCardRewriteDiffPopoverWrapper,as:"span",show:o,transitionDurationMs:400,display:"block",ariaHidden:!o},n.createElement("button",{className:Pe.sidelineCardRewriteDiffRevertButton,type:"button",onMouseOver:U,onMouseLeave:G,onFocus:U,onBlur:G,onClick:q},n.createElement(C.x,{as:"span","data-testid":"grammarly-g2-revertible-rewrite-diff-undo",ref:I,className:be().revertibleRewriteDiffLabel,style:T.popper,...P.popper},"Undo change"),n.createElement(Te,{...(0,M.Sh)(g&&be().revertibleRewriteDiffOutlineOnboarding),rects:Array.from(w.getClientRects()),referenceRect:f.getBoundingClientRect()}))))};var ze=i(1128),Oe=i(19703),Ge=i(78674),Ue=i(90399),He=i(84135);const qe=({domain:e,onCopy:t,onDismiss:i,onShowLess:r})=>n.createElement("div",{className:He.moreButton,"data-testid":"grammarly-g2-sideline-card-menu"},n.createElement(ze.v,{activator:"more-horizontal",accessibilityLabel:"Card options"},n.createElement(ze.v.Item,{key:"copy",icon:Oe.c,onClick:async()=>{await(null==t?void 0:t())}},"Copy"),i&&n.createElement(ze.v.Item,{key:"dismiss",icon:Ge.o,onClick:()=>{null==i||i()}},"Dismiss"),r&&n.createElement(n.Fragment,null,n.createElement(ze.v.Separator,{role:"separator"}),n.createElement(ze.v.Item,{key:"showLess",icon:Ue.l,onClick:()=>{null==r||r()},"data-testid":"grammarly-g2-sideline-card-menu-show-less"},"Show less on ",e))));var Ve=i(45954);function Ne(e,t){return"signaling"===e&&"improve"===t.kind?Ve.sidelineCardRewriteReadyContentTitleAttention:Ve.sidelineCardRewriteReadyContentTitleDefault}const je=e=>{const t=n.useRef(null),[i,a]=n.useState(e.diffProps);n.useEffect((()=>{a(e.diffProps)}),[e.diffProps]);const s=n.useMemo((()=>{const{diff:t}=c.fS((()=>({diff:[],displayDeletes:!1})))(i);return(0,ae.Ns)(e.originalText,t)}),[i,e.originalText]);n.useEffect((()=>{e.onRewriteTextChange&&e.onRewriteTextChange(s)}),[s,e.onRewriteTextChange]),B.P.useEffectOnDidMount(e.onMount);const{showBottomScrollLimit:o,showTopScrollLimit:l}=ee(t),d=t=>{const n=[];e.onRevert(),(0,r.zG)(i,c.UI((({diff:e,displayDeletes:i})=>{e.forEach((e=>{const[i,r]=e;t.find((([e,t])=>e===i&&t===r))?i===ae.FS.Operation.DELETE?n.push([ae.FS.Operation.RETAIN,r]):i===ae.FS.Operation.RETAIN&&n.push([i,r]):n.push([i,r])})),a(0===n.length?c.YP:c.G({diff:n,displayDeletes:i,accessibilityLabel:(0,ne.G)(n)}))})))},h=void 0!==e.onClickUphookButton&&e.onClickUphookButton!==r.Q1;return n.createElement(b.k,{gap:4,align:"stretch",style:{maxHeight:e.maxHeight},accessibilityLabel:(0,r.zG)(i,c.UI((({accessibilityLabel:e})=>e)),c.FS),"data-testid":"grammarly-g2-sideline-card-rewrite-ready"},n.createElement("div",{...(0,M.Sh)(Ve.sidelineCardRewriteReadySignalBar,(u=e.sidelineType,g=e.rewriteType,"signaling"===u&&"improve"===g.kind?Ve.sidelineCardRewriteReadySignalBarAttention:Ve.sidelineCardRewriteReadySignalBarDefault)),"data-testid":"grammarly-g2-sideline-card-rewrite-ready-signal"}),n.createElement(b.k,{flex:"1",direction:"column",justify:"space-between","data-testid":"grammarly-g2-sideline-card-rewrite-ready-container",gap:2},n.createElement("div",{...(0,M.Sh)(Ve.sidelineCardRewriteReadyContent,l&&Ve.sidelineCardRewriteReadyContentWithTopScrollLimit,o&&Ve.sidelineCardRewriteReadyContentWithBottomScrollLimit),"data-testid":"grammarly-g2-sideline-card-rewrite-ready-content",ref:t},n.createElement(C.x,{...(0,M.Sh)(Ve.sidelineCardRewriteReadyContentTitle,Ne(e.sidelineType,e.rewriteType)),as:"strong",variant:"text-small"},e.title),(0,r.zG)(i,c.UI((t=>n.createElement(Ae,{key:"diff",diff:t.diff,displayDeletes:t.displayDeletes,blur:h,onRevert:d,onFocusLost:e.onFocusLost}))),c.fS((()=>n.createElement(C.x,{as:"p",variant:"text-small"},e.newText))))),h&&e.onShowUphookButton&&e.onClickUphookButton?n.createElement(We,{onShowUphookButton:e.onShowUphookButton,onClickUphookButton:e.onClickUphookButton}):n.createElement($e,{...e,onApply:()=>{e.onApply(s)}})));var u,g},We=e=>{const{hasSpecialOffer:t}=n.useContext(se.U8),i=t.get()&&"test"===(0,oe.OB)().experimentClient.getTreatment(le.p.InProductDiscount);return n.createElement(b.k,{direction:"column",gap:2},n.createElement(b.k,{align:"end",justify:"start",height:"2rem"},n.createElement(C.x,{as:"strong"},"Upgrade for unlimited paragraph rewrites.")),n.createElement(b.k,{align:"end",justify:"space-between"},n.createElement(b.k,{align:"end",gap:2},n.createElement(E.i,{ref:t=>{null!==t&&e.onShowUphookButton()},"data-testid":"grammarly-g2-sideline-card-rewrite-ready-uphook-button",variant:"premium",href:(0,ce.Um)().planComparison,onClick:t=>{t.preventDefault(),e.onClickUphookButton()},size:"small"},i?"Get 50% off Pro":"Get Pro")),n.createElement(b.k,{align:"end",justify:"end"},n.createElement(ge,null))))},$e=e=>{const[t,i]=n.useState(!1),r=n.useRef(),{incrementAcceptCount:a}=w(p.X.accept),{sidelineType:s}=e,o="improve"===e.rewriteType.kind,l="signaling"===s,d=l&&!o,c=l&&o;n.useEffect((()=>()=>clearTimeout(r.current)),[]);const h=(0,oe.OB)().experimentClient.isGateEnabled(de.K.G2VBarsDeactivation);return n.createElement(b.k,{align:"end",justify:"space-between","data-testid":"grammarly-g2-sideline-card-rewrite-ready-content-toolbar"},n.createElement(b.k,{align:"end",justify:"start",gap:2,"data-testid":"grammarly-g2-sideline-card-rewrite-ready-content-toolbar-left"},n.createElement(D,{onboardingStep:p.X.accept},n.createElement(H,{"aria-label":"Accept rewrite and return to doc",onClick:()=>{e.onApply(),a()},"data-testid":"grammarly-g2-sideline-card-rewrite-ready-content-apply-btn"},"Accept")),c&&n.createElement(E.z,{"data-testid":"grammarly-g2-sideline-card-rewrite-ready-content-dismiss-btn",variant:"tertiary","aria-label":"Dismiss recommendation and return to doc",size:"small",onClick:e.onDismiss},"Dismiss")),n.createElement(b.k,{align:"center",justify:"end",gap:2,"data-testid":"grammarly-g2-sideline-card-rewrite-ready-content-toolbar-right"},t&&n.createElement(b.k,{className:Ve.sidelineCardRewriteCopyButtonCopyConfirmation,bgColor:"background-base-default"},n.createElement(C.x,{as:"p",variant:"text-xsmall",color:"base-subdued"},"Copied")),n.createElement(E.z,{"data-testid":"grammarly-g2-sideline-feedback-btn",variant:"tertiary","aria-label":"Open feedback window to give feedback",size:"small",onClick:()=>e.onClickFeedbackButton()},"Feedback"),n.createElement(qe,{onCopy:async()=>{await e.onCopy(),i(!0),clearTimeout(r.current),r.current=setTimeout((()=>{i(!1)}),4e3)},onDismiss:d?e.onDismiss:void 0,onShowLess:"selection"!==s&&"pushed_content"!==s&&h?()=>e.onShowLess(s):void 0,domain:e.domain}),e.onRegenerate&&n.createElement(b.k,{className:Ve.sidelineCardRewriteCopyButton},n.createElement(E.z,{"data-testid":"grammarly-g2-sideline-card-regenerate-btn",variant:"tertiary","aria-label":"Regenerate",size:"small",onClick:e.onRegenerate},n.createElement(_.J,{icon:re.a,size:"small",accessibilityLabel:""}))),n.createElement(ge,null)))};var Ye=i(8510),Ke=i(77534);const Qe=({title:e,text:t,onMount:i})=>(B.P.useEffectOnDidMount((()=>i())),n.createElement(b.k,{direction:"column",height:"100%",justify:"center","data-testid":"grammarly-g2-sideline-card-rewrite-success",className:Ke.sidelineCardRewriteSuccess},n.createElement(b.k,{"data-testid":"grammarly-g2-sideline-card-rewrite-success-main",align:"center",gap:4},n.createElement(_.J,{size:"small",accessibilityLabel:"",icon:Ye.j}),n.createElement(b.k,{direction:"column","data-testid":"grammarly-g2-sideline-card-rewrite-success-main-content"},n.createElement(C.x,{className:Ke.sidelineCardRewriteSuccessMainContentTitle,as:"strong",color:"brand-default",variant:"text-small"},e),n.createElement(C.x,{as:"p",variant:"text-small",color:"base-subdued"},t))),n.createElement(ge,{className:Ke.sidelineCardRewriteSuccessGrammarlyLogo}))),Xe=e=>n.createElement(b.k,{accessibilityLabel:Je(e.kind),padding:3,direction:"column","aria-live":"error"===e.kind?"assertive":"polite","aria-busy":"loading"===e.kind,"data-testid":"grammarly-g2-sideline-card-rewrite",className:$.sidelineCardRewrite},(()=>{switch(e.kind){case"loading":return n.createElement(te,{maxHeight:e.maxHeight,streamedText:e.newText,onMount:e.onMount,onStreamingStart:e.onStreamingStart});case"ready":return n.createElement(je,{maxHeight:e.maxHeight,title:e.title,originalText:e.originalText,newText:e.newText,diffProps:e.diffProps,sidelineType:e.sidelineType,rewriteType:e.rewriteType,onApply:e.onApply,onCopy:e.onCopy,onRevert:e.onRevert,onDismiss:e.onDismiss,onMount:e.onMount,onRegenerate:e.onRegenerate,onClickFeedbackButton:e.onClickFeedbackButton,onShowUphookButton:e.onShowUphookButton,onClickUphookButton:e.onClickUphookButton,onShowLess:e.onShowLess,onFocusLost:e.onFocusLost,domain:e.domain,onRewriteTextChange:e.onRewriteTextChange});case"success":return n.createElement(Qe,{title:e.title,text:e.text,onMount:e.onMount});case"error":return n.createElement(W,{errorDetails:e.errorDetails,errorReason:e.errorReason,onMount:e.onMount});default:(0,q.L0)(e)}})());function Je(e){switch(e){case"loading":return"Loading suggestion content";case"ready":case"success":return"Suggestion content";case"error":return"An error occurred";default:(0,q.L0)(e)}}const Ze="";var et=i(70279);const tt=({maxContentHeight:e,customPromptRewriteInfo:t,suggestedCustomPrompts:i,recentCustomPrompts:r,onGoBack:a,onChange:s,onSubmit:o})=>{const[l,d]=n.useState(""),c=n.useCallback((()=>{const e=l.trim();e.length>0&&o(e)}),[l]),h=n.useCallback((e=>{0===l.length&&"Backspace"===e.key&&(e.preventDefault(),e.stopPropagation(),a())}),[l]),u=i.length+r.length;return n.createElement(b.k,{className:et.sidelineCardCustomPrompt,direction:"column","data-testid":"grammarly-g2-sideline-card-custom-prompt"},n.createElement(b.k,{className:et.sidelineCardCustomPromptInput,align:"center",gap:{column:3},padding:2},n.createElement(H,{onClick:a,"aria-label":"Back to Grammarly suggestions","data-testid":"grammarly-g2-sideline-card-custom-prompt-back-button"},Ze),n.createElement("form",{className:et.sidelineCardCustomPromptInputForm,onSubmit:e=>{e.preventDefault(),c()}},n.createElement("input",{autoFocus:!0,type:"text",className:et.sidelineCardCustomPromptInputField,"aria-label":"Enter your prompt. Matching results will display in the search results group. Press enter to activate your prompt, or tab to navigate through other matching options.",placeholder:"Enter your prompt",onChange:e=>{d(e.target.value),s(e.target.value.trim())},onKeyDown:h,"data-testid":"grammarly-g2-sideline-card-custom-prompt-input-field"}),n.createElement("input",{type:"submit",style:{display:"none"},"data-testid":"grammarly-g2-sideline-card-custom-prompt-input-form-submit"})),l.trim().length>0&&n.createElement(H,{onClick:()=>c()},"Submit")),t?n.createElement(Xe,{...t,maxHeight:e}):n.createElement(b.k,{className:et.sidelineCardCustomPromptSuggestedResults,direction:"column",gap:{row:2},padding:2},n.createElement("p",{className:et.liveAnnouncement,"aria-live":"polite","aria-atomic":"true"},0===u?"There are no suggested prompts":`${u} suggested ${(0,G._6)(u,"prompt","prompts")} found`),n.createElement(C.x,{as:"p",color:"base-subdued",variant:"text-xsmall",className:et.sidelineCardCustomPromptSuggestedResultsSubtitle},"Tell us how to change this text.",i.length>0?" Try ideas below:":""),i.map((e=>n.createElement(H,{key:e,className:et.sidelineCardCustomPromptSuggestedResultsOption,"aria-label":`Submit suggested prompt: ${e}`},n.createElement(_.J,{icon:z.p,accessibilityLabel:"",size:"small"}),e))),r.length>0&&n.createElement(C.x,{as:"p",color:"base-subdued",variant:"text-xsmall",className:et.sidelineCardCustomPromptSuggestedResultsSubtitle},"Recent"),r.map((e=>n.createElement(H,{key:e,className:et.sidelineCardCustomPromptSuggestedResultsOption,"aria-label":`Submit recent prompt: ${e}`},n.createElement(_.J,{icon:O.w,accessibilityLabel:"",size:"small"}),e)))))},it=n.forwardRef((({id:e,label:t,accessibilityDescription:i,selected:r,onClick:a},s)=>n.createElement(n.Fragment,null,n.createElement(E.z,{id:e,ref:s,"aria-label":t,"aria-describedby":`${e}-description`,"aria-pressed":r,variant:"tertiary",onClick:()=>{a(e)}},n.createElement(C.x,{as:"span",variant:"text-xsmall"},t)),n.createElement("p",{id:`${e}-description`,className:A.a11yDescription,"aria-hidden":!0},i)))),rt=({rewrites:e,rewriteTabsOrder:t,expanded:i,firstTabRef:r,firstExpandedTabRef:a,selectedRewriteTabId:s,collapsedButtonsNumber:o,onSelectedRewriteChange:l,onClickMore:d,onClickCustomPromptEntryPoint:c})=>{const h=t.map((t=>e.get(t))).filter((e=>void 0!==e)),u=h.slice(0,o),g=h.slice(o);return n.createElement(b.k,{justify:"space-between","data-testid":"grammarly-g2-sideline-card-tabslist"},n.createElement(D,{onboardingStep:p.X.rewriteOptions,className:A.sidelineCardFtuxRewrites},n.createElement(b.k,null,n.createElement("div",{role:"group","aria-label":"Rewrite actions"},n.createElement(b.k,{gap:3},u.map(((e,t)=>n.createElement(it,{key:e.tabId,id:e.tabId,label:e.buttonProps.label,ref:0===t?r:void 0,accessibilityDescription:e.buttonProps.accessibilityDescription,selected:e.tabId===s,onClick:l}))),!i&&g.length>0?n.createElement(it,{id:"more",label:"More",accessibilityDescription:"Reveal more rewrite options. The more action will go away, and focus will be on the first of the 3 new actions.",onClick:d}):g.map(((e,t)=>n.createElement(it,{key:e.tabId,id:e.tabId,label:e.buttonProps.label,ref:0===t?a:void 0,accessibilityDescription:e.buttonProps.accessibilityDescription,selected:e.tabId===s,onClick:l}))))))),n.createElement(b.k,{marginRight:3,align:"center"},n.createElement(D,{onboardingStep:p.X.customPrompt,className:A.sidelineCardFtuxCustomPromptEntryPoint},n.createElement("button",{"aria-label":"Enter your own custom rewrite. Navigate to the Grammarly prompt.",className:A.sidelineCardCustomPromptEntryPoint,onClick:c,"data-testid":"grammarly-g2-sideline-card-custom-prompt-entry-point",type:"button"},"Enter your own..."))))},nt=e=>"customPrompt"===e.selectedTabId?e.customPromptRewriteInfo:e.rewrites.get(e.selectedTabId),at=e=>{const t=nt(e),i={maxHeight:e.maxContentHeight,onFocusLost:e.onFocusLost,onRewriteTextChange:e.onRewriteTextChange};return t?n.createElement(Xe,{...t,...i}):null};const st=n.forwardRef((function({maxHeight:e=200,tabListPosition:t,sidelineCard:i,initialSelectedRewriteTabId:r,rewrites:a,rewriteTabsOrder:s,expanded:o,suggestedCustomPrompts:l,recentCustomPrompts:d,customPromptRewriteInfo:c,onChangeCustomPrompt:h,onSubmitCustomPrompt:u,onChangeSelectedRewriteTab:g,onClickMoreTab:m,onShow:p,onClose:v},f){const[S,w]=n.useState(r),[b,_]=n.useState(r),[y,C]=n.useState(""),k=n.useRef(r),x=n.useRef(null),R=n.useRef(null),E=n.useRef(null);n.useEffect((()=>{k.current!==b&&(k.current=b,g(b))}),[b]),n.useEffect((()=>{p(i),null!==E.current&&v(E.current),E.current=i}),[i.sideline.id]),n.useEffect((()=>{requestAnimationFrame((()=>{var e;i.shouldFocus&&(null===(e=x.current)||void 0===e||e.focus())}))}),[i.sideline.id]),B.P.useEffectOnWillUnmount((()=>v(i)));const I=n.createElement(rt,{rewrites:a,rewriteTabsOrder:s,expanded:o,selectedRewriteTabId:b,onClickCustomPromptEntryPoint:()=>{w(b),_("customPrompt"),h("")},onClickMore:()=>{m(),setTimeout((()=>{var e;return null===(e=R.current)||void 0===e?void 0:e.focus()}),0)},onSelectedRewriteChange:e=>{if("customPrompt"!==e){const t=e;if(t!==b)_(t);else{const e=nt({rewrites:a,selectedTabId:b});e&&"ready"===e.kind&&e.onApply(y)}}},firstTabRef:x,firstExpandedTabRef:R,collapsedButtonsNumber:2}),T=e-40-24,P=n.createElement("div",{"data-testid":"grammarly-g2-sideline-card-tabspanel"},n.createElement(at,{maxContentHeight:T,rewrites:a,selectedTabId:b,onFocusLost:()=>{var e;return null===(e=x.current)||void 0===e?void 0:e.focus()},onRewriteTextChange:e=>C(e)}));return n.createElement("div",{ref:f,className:A.sidelineCard,"data-testid":"grammarly-g2-sideline-card"},"customPrompt"===b?n.createElement(tt,{maxContentHeight:T,suggestedCustomPrompts:null!=l?l:[],recentCustomPrompts:null!=d?d:[],customPromptRewriteInfo:c,onGoBack:()=>_(S),onChange:h,onSubmit:u}):n.createElement("div",null,"top"===t?I:P,n.createElement("div",{className:A.sidelineCardHorizontalDivider}),"bottom"===t?I:P))}));var ot=i(63418),lt=i(95923);const dt=({notification:e})=>{const t=n.useRef(null);return n.useEffect((()=>{if(t.current&&e.referenceElement){const i=(0,ot.fi)(e.referenceElement,t.current,{placement:"right",strategy:"fixed"});return()=>{i.destroy()}}return()=>{}}),[e.referenceElement]),n.createElement("div",{ref:t,key:"vbarNotification",className:A.sidelineCard},n.createElement(b.k,{gap:2,padding:4},n.createElement(b.k,{flex:"auto 0"},n.createElement(_.J,{icon:lt.L,accessibilityLabel:""})),n.createElement(b.k,{flex:"auto 1"},n.createElement(C.x,{as:"span",variant:"text-medium"},e.text))))};var ct=i(44665),ht=i(24059),ut=i(27429),gt=i(11669),mt=i(6673);const pt={name:"flip",enabled:!1},vt={name:"eventListeners",enabled:!1},ft=({referenceElement:e,additionalEventSources:t=[],onMouseEnter:i,onMouseLeave:r,onFocus:a,onClickAway:s,onEscPress:o,contentWrapperHeight:l=0,children:d})=>{const[c,h]=n.useState(null),[u,g]=n.useState(void 0),m=n.useMemo((()=>({...ct.Z,options:{offset:({placement:e})=>["right-end"===e?0:gt.gK+4,gt.TM]}})),[]),p=n.useMemo((()=>({name:"maxHeight",enabled:!0,phase:"main",requiresIfExists:["offset"],fn({name:e,state:t,options:i}){if(t.modifiersData[e]._skip)return;const r=(0,ht.Z)({...t,placement:"top-start"},i),n=(0,ht.Z)({...t,placement:"bottom-start"},i),{height:a}=t.rects.popper,s=a-r.top-gt.TM-l,o=a-n.bottom-gt.TM-l,d=200+l;s<d&&o<d?(t.modifiersData[e]._skip=!0,t.placement="right-end",t.reset=!0,g(t.rects.reference.height+s)):o>=s?(t.modifiersData[e]._skip=!0,t.placement="bottom-start",t.reset=!0,g(o)):(t.modifiersData[e]._skip=!0,t.placement="top-start",t.reset=!0,g(s))},data:{_skip:!1}})),[l]),{styles:v,attributes:f,state:S}=(0,me.D)(e,c,{placement:"bottom-start",modifiers:[m,pt,p,vt]});return n.useEffect((()=>{const e="keydown",t=e=>{"Escape"===e.key&&(e.stopImmediatePropagation(),o(e))};return document.addEventListener(e,t,true),()=>{document.removeEventListener(e,t,true)}}),[o]),n.createElement(ut.d,{onClickAway:s,additionalEventSources:t},n.createElement("div",{"data-testid":"grammarly-g2-sideline-card-popper",role:"dialog","aria-label":"Grammarly suggestion. Pressing ESC will close this window and return you to your doc.",tabIndex:0,ref:h,style:v.popper,className:mt.sidelineCardPopper,onMouseEnter:i,onMouseLeave:r,onFocus:a,...f.popper},d({placement:null==S?void 0:S.placement,maxHeight:u})))};var St=i(84358),wt=i(77726);const bt=({sidelineCard:e,vBarsQuotaInfo:t,onboardingService:i,getSidelineCardState:m,onActivateSidelineCard:p,onDeactivateSidelineCard:v,onChangeSelectedRewriteTab:f,onMountRewriteLoading:w,onMountRewriteEmpty:b,onMountRewriteReady:_,onMountRewriteError:y,onApplyRewrite:C,onCopyRewrite:k,onRevertRewrite:x,onDismissRewrite:B,onDeactivateSidelineType:E,onRegenerateRewrite:I,onChangeCustomPrompt:T,onSubmitCustomPrompt:P,onClickMoreTab:F,onClickFeedbackButton:M,onShow:L,onClose:D,onShowUphookButton:A,onClickUphookButton:z,onStreamingStart:O,integration:G})=>{const[U,H]=n.useState(null),V=(e,t,i)=>function(e){const{rewrite:t,sidelineType:i,onMountRewriteLoading:n,onMountRewriteEmpty:a,onMountRewriteReady:s,onMountRewriteError:o,onApplyRewrite:l,onCopyRewrite:d,onRevertRewrite:h,onDismissRewrite:u,onRegenerateRewrite:g,onClickFeedbackButton:m,onStreamingStart:p,onShowUphookButton:v,onClickUphookButton:f,onDeactivateSidelineType:S,domain:w}=e;if("loading"===t.kind||"idle"===t.kind){const e="loading"===t.kind;return{tabId:t.rewriteTabId,kind:"loading",newText:e?t.rewriteTextPartial:void 0,onMount:()=>n(t),onStreamingStart:e?()=>p(t):r.Q1}}return"ready"===t.kind?t.vBar.text===t.rewriteText?{tabId:t.rewriteTabId,kind:"success",title:"This text is well-written",text:"To see a different version, select a rewrite option.",onMount:()=>a(t)}:{tabId:t.rewriteTabId,kind:"ready",title:t.title,originalText:t.vBar.text,newText:t.rewriteText,diffProps:(0,r.zG)(t.rewriteDiff,c.UI((e=>({diff:e,displayDeletes:"improve"===t.type.kind,accessibilityLabel:St.MH(t.accessibilityLabel)})))),sidelineType:i,rewriteType:t.type,onMount:()=>s(t),onApply:e=>l({...t,rewriteText:e}),onCopy:()=>d(t),onRevert:()=>h(t),onDismiss:()=>u(t),onShowLess:e=>S(e,t),domain:w,onRegenerate:(0,wt.es)(t.type)?r.Q1:()=>g(t),onClickFeedbackButton:()=>m(t),onShowUphookButton:v,onClickUphookButton:f}:"error"===t.kind?{tabId:t.rewriteTabId,kind:"error",errorDetails:t.errorDetails,errorReason:t.errorReason,onMount:()=>o(t)}:void(0,q.L0)(t)}({rewrite:e,sidelineType:t.sideline.kind,onMountRewriteLoading:e=>w(e,t),onMountRewriteEmpty:e=>b(e,t),onMountRewriteReady:e=>_(e,t,i),onMountRewriteError:e=>y(e,t),onApplyRewrite:e=>C(e,t),onCopyRewrite:e=>k(e,t),onRevertRewrite:e=>x(e,t),onDismissRewrite:e=>B(e,t),onRegenerateRewrite:e=>I(e,t),onClickFeedbackButton:e=>M(e,t),onStreamingStart:e=>O(e,t),onShowUphookButton:i?()=>A(e,t):r.Q1,onClickUphookButton:i?()=>z(e,t):r.Q1,onDeactivateSidelineType:(e,i)=>E(e,i,t),domain:G.info.domain});return n.createElement(a.F.Fragment,null,e.pipe(o.U(c.hX(u.isCard)),o.U(c.WG),l.O(null),d.G()).pipe(o.U((([e,o])=>{const l=null!=o?o:e,d=l?m(l):null;return n.createElement(S,{onboardingService:i,rootElement:U,sideline:l?l.sideline:null},n.createElement(h,{show:null!==o,transitionDurationMs:150},l&&d&&n.createElement(ft,{referenceElement:l.referenceElement,contentWrapperHeight:c.pC(t.get())?36:void 0,onMouseEnter:()=>p(l,!1),onMouseLeave:()=>v(l,!1),onFocus:()=>p(l,!0),onClickAway:()=>v(l,!0),onEscPress:()=>v(l,!0)},(({placement:e,maxHeight:i})=>n.createElement(a.F.Fragment,null,s.h.combine(d,t,((t,a)=>{const{rewrites:s,rewriteTabsOrder:o,customPromptRewriteInfo:d,selectedRewriteTabId:h,expanded:u}=t,{quota:m,showUphook:p}=(0,r.zG)(a,c.UI((e=>({quota:e.quota,showUphook:(0,g.Q)(e,l.sideline.textHash)}))),c.pF((()=>({showUphook:!1,quota:void 0})))),v=new Map(Array.from(s.values()).map((e=>({...V(e.rewrite,l,p),buttonProps:e.buttonProps}))).map((e=>[e.tabId,e])));return n.createElement(R,{quota:m,showUphook:p},n.createElement(st,{key:l.sideline.id,initialSelectedRewriteTabId:h,maxHeight:i,tabListPosition:"top-start"===e?"bottom":"top",sidelineCard:l,rewrites:v,rewriteTabsOrder:o,expanded:u,customPromptRewriteInfo:(0,r.zG)(d,c.UI((e=>V(e,l,p))),c.pF(r.r5)),onChangeCustomPrompt:e=>T(e,l),onSubmitCustomPrompt:e=>P(e,l),onChangeSelectedRewriteTab:e=>{f(e,l)},onClickMoreTab:()=>F(l),onShow:e=>{L(e,p)},onClose:e=>{D(e)}}))})))))),n.createElement("div",{ref:H,style:{height:0,width:0}}))}))),e.pipe(o.U(c.hX(u.isNotification)),o.U(c.UI((e=>n.createElement(dt,{key:"vBarNotification",notification:e})))),o.U(c.WG)))}},27250:(e,t,i)=>{i.r(t),i.d(t,{SidelineCollection:()=>L});var r=i(38538),n=i(90023),a=i(49231),s=i(13391),o=i(47387),l=i(58303),d=i(88305),c=i(93930),h=i(37213),u=i(13642),g=i(33149),m=i(69911),p=i(18674),v=i(22299),f=i(23934),S=i(6147),w=i(64297),b=i(22266),_=i(11669);function y(e){let t;switch(e){case"signaling":t=b.pulsingSignalingSideline;break;case"idle":t=b.pulsingIdleSideline;break;case"selection":t=b.pulsingSelectionSideline;break;case"pushed_content":t="";break;default:(0,w.L0)(e)}return(0,h.Sh)(b.pulsingSideline,t).className}function C(e,t,i,r,n){return"idle"!==t?function(e,t,i,r){return(0,h.Sh)(b.sideline,e?b.sidelineEmphasized:void 0,"selection"===t?b.sidelineWithSelectionSignal:void 0,i?b.sidelineWithSignalBar:void 0,r?y(t):void 0).className}(e,t,i,r):function(e,t,i){return(0,h.Sh)(b.sideline,e?b.sidelineIdle:void 0,e&&i?b.sidelineEmphasized:void 0,t?y("idle"):void 0).className}(e,r,n)}function k(e,t,i,r,n,a){return(0,h.Sh)(b.sidelineSignalBar,function(e,t,i){if(t)return b.sidelineSignalBarLoading;switch(e){case"signaling":return i?b.sidelineSignalBarAttentionUphook:b.sidelineSignalBarAttention;case"selection":case"idle":case"pushed_content":return;default:(0,w.L0)(e)}}(t,r,n),e?b.sidelineSignalBarEmphasized:void 0,i?void 0:b.sidelineSignalBarHidden,a?b.sidelineSignalBarSubdued:void 0).className}function x(e,t,i,r){return r?function(e,t){return(0,h.Sh)(t?b.sidelineIdle:void 0,e||t?b.sidelineIdleStaticEmphasized:void 0).className}(e,t):function(e,t,i){return(0,h.Sh)(t?b.sidelineIdle:void 0,"OutsideSafeArea"===i&&t?b.sidelineIdleOutsideSafeArea:void 0,"InsideSafeArea"===i&&t?b.sidelineIdleSafeArea:void 0,e||"HoverVBar"===i&&t?b.sidelineIdleHover:void 0,e?b.sidelineIdlePinned:void 0).className}(e,t,i)}function R(e,t){return(0,h.Sh)(b.sidelineArrow,e?b.sidelineArrowVisible:void 0,t?b.sidelineArrowBottom:void 0).className}function B(e,t,i,r){return(0,h.Sh)(b.sidelineArrow,!t||e||"HoverVBar"!==i&&!r?void 0:b.sidelineArrowVisibleIdle,e?b.sidelineArrowPinnedIdle:void 0,r?b.sidelineArrowVisibleIdleStatic:void 0).className}const E=a.forwardRef((function({emphasized:e,pinned:t,heightInPixels:i,sidelineType:r,sidelineColor:n,sidelineId:s,isLoading:l,vBarMousePosition:d,isUphook:c,onClick:h,isSubdued:u,shouldPulse:g,onMouseEnter:m,onMouseLeave:p,onFocus:f,onBlur:S,onMount:w,onShow:b,onHide:y,onPulse:k,isStaticIdleVBarWidth:x},R){const B=a.useRef(!1),E=a.useRef(s),P=("signaling"===r||"pushed_content"===r||l&&e)&&!(e&&!(i>=24)),F=P||e;return v.P.useEffectOnDidMount((()=>w())),v.P.useEffectOnWillUnmount((()=>{B.current&&y()})),((e,t,i,r)=>{a.useEffect((()=>{e.current!==t&&(e.current=t,t?i():r())}),[t,i,r])})(B,F,b,y),a.useEffect((()=>{e&&!u&&g&&k()}),[e,u,g,k]),a.useEffect((()=>{E.current!==s&&F&&b()}),[F,s]),a.createElement("div",{onMouseEnter:m,onMouseLeave:p,onFocus:e?f:void 0,onBlur:e?S:void 0,"data-testid":`grammarly-g2-sideline-${r}`},a.createElement("button",{className:C(e,r,P,g,x),style:{height:i,width:_.gK},disabled:!e,onClick:e?h:void 0,"aria-label":"See rewrite suggestions",ref:R},a.createElement(o.F.Fragment,null,d.view((i=>"idle"!==r?a.createElement(I,{emphasized:e,sidelineType:r,sidelineColor:n,showSignalBar:P,isLoading:l,isUphook:c,isSubdued:u}):a.createElement(T,{pinned:t,emphasized:e,mousePosition:i,isStaticVBarWidth:x}))))))}));function I({emphasized:e,sidelineType:t,sidelineColor:i,showSignalBar:r,isLoading:n,isUphook:s,isSubdued:o}){return a.createElement(a.Fragment,null,a.createElement("div",{className:k(e,t,r,n,s,o),style:"pushed_content"===t?{background:i}:void 0,"aria-hidden":!0}),a.createElement(f.J,{className:R(e,r),icon:S.b,accessibilityLabel:"",size:"small",variant:"selection"===t?"inverse":"default"}))}function T({pinned:e,emphasized:t,mousePosition:i,isStaticVBarWidth:r}){return a.createElement("div",{className:x(e,t,i,r),style:(0,_.qt)(),"aria-hidden":!0},a.createElement(f.J,{className:B(e,t,i,r),icon:S.b,accessibilityLabel:"",size:"small",variant:"default"}))}var P=i(38215);const F=({sideline:e,isEmphasized:t,isActive:i,isPinned:r,onPin:n,onActivate:s,onDeactivate:o,onMount:l,onShow:d,onHide:c,onPulse:v,onRefChange:f,setVBarMousePosition:S,vBarMousePosition:w,isUphook:b,showSelectionHighlight:y=!1,isSubdued:C,shouldPulse:k})=>{const x={top:e.highlightRect.top-_.TM,left:e.highlightRect.left,width:e.highlightRect.width,height:e.highlightRect.height+2*_.TM},R={top:e.highlightRect.top,left:e.highlightRect.left+_.TM},B=e.highlightRect.height,I=(0,p.iu)(e),T=i&&!I,F=y&&I,M=i||t,L=a.useMemo((()=>"idle"===e.kind&&(0,u.l0)("docs.google.com"===(0,m.ge)())),[e.kind]);return a.createElement(a.Fragment,null,a.createElement("span",{"data-testid":`grammarly-g2-sideline-paragraph-highlighter-${e.id}`,...(0,h.Sh)(P.sidelineParagraphHighlighter,T?P.sidelineParagraphHighlighterActive:void 0),style:x}),F&&a.createElement("div",{"data-testid":`grammarly-g2-sideline-selection-highlight-${e.id}`,className:P.sidelineSelectionHighlight},a.createElement(g.y$,{id:e.id,rects:e.selectionRects,displayFormat:g.jk.background,color:g.hE.Preset.create(g.al.gray),liveliness:null,disappearOnHoverDelay:null})),a.createElement("span",{"data-testid":`grammarly-g2-sideline-positioner-${e.id}`,className:P.sidelinePositioner,style:R},a.createElement(E,{isStaticIdleVBarWidth:L,isUphook:b,isSubdued:C,shouldPulse:k,emphasized:M,pinned:r,heightInPixels:B,sidelineType:e.kind,sidelineColor:"pushed_content"===e.kind?e.color:void 0,sidelineId:e.id,isLoading:!1,vBarMousePosition:w,onClick:()=>n(e),onFocus:()=>n(e),onMouseEnter:()=>{s(e,k),S(e.id,!0)},onMouseLeave:()=>{o(e),S(e.id,!1)},onMount:()=>l(e),onShow:()=>d(e),onHide:()=>c(e),onPulse:()=>v(e),ref:t=>{t&&f(e,t)}})))};function M(e,t){switch(t){case"signaling":return e.shouldShowSignalingPulsating;case"selection":return e.shouldShowSelectionPulsating;case"idle":return e.shouldShowIdlePulsating;case"pushed_content":return!1;default:(0,d.vE)(t)}}const L=({paragraphSidelines:e,pinnedSideline:t,activeSideline:i,emphasizedSideline:d,selectionSideline:h,shouldHideSidelines:u,pulsatingOnboardingInfo:g,shouldShowSelectionHighlight:m,vBarsQuotaInfo:p,shouldSubdueVBars:v,onPinSideline:f,onActivateSideline:S,onDeactivateSideline:w,onMountSideline:b,onShowSideline:_,onHideSideline:y,onPulseSideline:C,onSidelineRefChange:k,setVBarMousePosition:x,vBarMousePositions:R})=>{const B={onPin:f,onActivate:S,onDeactivate:w,onMount:b,onShow:_,onHide:y,onPulse:C,onRefChange:k,setVBarMousePosition:x},E=e=>R.view((0,n.ls)(r.P5(e),l.fS((()=>"OutsideSafeArea")))),I=s.h.combine(e,h,t,i,d,u,g,((e,t,i,r,a,s,o)=>{if(s)return[];const d=e=>(0,n.zG)(i,l.Gg((t=>t.id===e))),c=e=>(0,n.zG)(r,l.Gg((t=>t.sequentialId===e)));return(0,n.zG)(t,l.UI((e=>[{...B,sideline:e,vBarMousePosition:E(e.id),isPinned:!1,isEmphasized:!0,isActive:c(e.sequentialId),showSelectionHighlight:d(e.id)&&m,shouldPulse:M(o,"selection")}])),l.pF((()=>{let t=e;if(o.shouldShowSignalingPulsating){const i=e.find((e=>"signaling"===e.kind));t=i?[i]:e}return t.map(((e,t)=>{const i=d(e.id);return{...B,sideline:e,vBarMousePosition:E(e.id),isPinned:i,isEmphasized:(r=e.sequentialId,(0,n.zG)(a,l.Gg((e=>e.sequentialId===r)))),isActive:c(e.sequentialId),showSelectionHighlight:i&&m,shouldPulse:M(o,e.kind)&&0===t};var r}))})))}));return a.createElement(o.F.Fragment,null,I.view((e=>e.map((e=>a.createElement(o.F.Fragment,{key:e.sideline.id},s.h.combine(p,v,((t,i)=>{const r=(0,n.zG)(t,l.UI((t=>(0,c.Q)(t,e.sideline.textHash))),l.pF((()=>!1)));return a.createElement(F,{...e,isUphook:r,isSubdued:i})}))))))))}},42131:(e,t,i)=>{i.d(t,{FS:()=>x,Ns:()=>k,jy:()=>v});var r=i(60213),n=i(12518),a=i(53186),s=i(3190),o=i(90023),l=i(88305);const d=/\s/;function c(e,t){const i=e.split(d),[r,...n]=i;t(r);let a=r.length;for(const i of n){t(e[a]),a+=i.length+1,t(i)}}function h(e,t){const i=new r.diff_match_patch,[n,a,s]=function(e,t){const i=[],r=new Map,n=e=>t=>{if(""===t)return;const n=r.get(t)||String.fromCharCode(r.size);r.has(t)||(i.push(t),r.set(t,n)),e.push(n)},a=[];c(e,n(a));const s=[];return c(t,n(s)),[a.join(""),s.join(""),i]}(e,t),o=i.diff_main(n,a,!1);return i.diff_charsToLines_(o,s),i.diff_cleanupSemantic(o),o}const u=/([.!?] )/;function g(e){const t=e.split(u),i=[];for(let e=0;e<t.length;e++){const r=t[e],n=t[e+1];let a=r;u.test(r)||(u.test(n)?(a+=n[0],i.push(a),i.push(" ")):i.push(a))}return i}function m(e){const t=[];for(const i of e){const[e,r]=i;if(e===x.Operation.INSERT&&u.test(r)){const i=g(r);for(const r of i)t.push([e,r])}else t.push(i)}return t}const p=/(\p{Punctuation}|\s)+/mu,v=e=>{const t=function(e){let t=0,i=0;for(const r of e){const[e,n]=r;e===x.Operation.DELETE&&(t+=n.length),e!==x.Operation.DELETE&&e!==x.Operation.RETAIN||(i+=n.length)}return t/i}(e),i=[],r=e=>({groupID:e,diffs:[],showDeletions:t<.4});let n,a=-1,l=r(a);for(const t of e){switch((0,s.li)(t)){case x.Operation.INSERT:!n||(0,s.li)(n)!==x.Operation.DELETE&&(0,s.li)(n)!==x.Operation.INSERT?(a+=1,i.push(l),l=r(a),l.diffs.push(t)):l.diffs.push(t);break;case x.Operation.DELETE:a+=1,l.diffs.length>0&&i.push(l),l=r(a),l.diffs.push(t);break;case x.Operation.RETAIN:y((0,s.Yg)(t)).map((e=>[x.Operation.RETAIN,e])).forEach((e=>{a+=1,l.diffs.length>0&&i.push(l),l=r(a),l.diffs.push(e)}))}n=t}return l.diffs.length>0&&i.push(l),(0,o.zG)(i,f,S,w,C)};function f(e){return e.map((e=>{const t=e.diffs.every((([e])=>e===x.Operation.DELETE));return{...e,showDeletions:t||e.showDeletions}}))}function S(e){return e.map((e=>{const{diffs:t,showDeletions:i}=e;if(2!==t.length||!i)return e;const[r,n]=t,[a,s]=r,[o,l]=n,d=a===x.Operation.DELETE&&o===x.Operation.INSERT&&s.toLocaleUpperCase()===l;return{...e,showDeletions:!d&&i}}))}function w(e){return e.map((e=>{const{diffs:t,showDeletions:i}=e;if(2!==t.length||!i)return e;const[r,n]=t,[a,s]=r,[o,l]=n,d=a===x.Operation.DELETE&&o===x.Operation.INSERT&&s.length===l.length;return{...e,showDeletions:!d&&i}}))}function b(e){const{diffs:t}=e;if(1===t.length){const[e]=t,[i,r]=e;return(i===x.Operation.INSERT||i===x.Operation.DELETE)&&!p.test(r)}if(2===t.length){const[e,i]=t,[r,n]=e,[a,s]=i;return r===x.Operation.DELETE&&a===x.Operation.INSERT&&n.length===s.length&&!p.test(n)&&!p.test(s)}return!1}function _(e){const{diffs:t}=e;return function(e){const{diffs:t}=e;return 1===t.length&&(0,s.li)(t[0])===x.Operation.RETAIN}(e)&&!p.test((0,s.Yg)(t[0]))}function y(e){const t=e.split(p);if(1===t.length)return[e];const i=[],r=t[0],n=t[t.length-1];let a=0;return r&&(i.push(r),a=r.length),n?(i.push(e.substring(a,e.length-n.length)),i.push(n)):i.push(e.substring(a)),i}function C(e){const t=[];let i,r=[],n=[],a=!1,s=0;const o=()=>{s>=2&&a?t.push(...n):t.push(...r),r=[],n=[],i=void 0,s=0,a=!1};for(const l of e)void 0===i?b(l)||_(l)?(r.push(l),i={groupID:l.groupID,diffs:[...l.diffs],showRetainsAsInserts:!0,showDeletions:!1},n.push(i)):t.push(l):b(l)?(r.push(l),s++,i.diffs.push(...l.diffs)):_(l)?(r.push(l),s>0&&(a=!0),i.diffs.push(...l.diffs)):(o(),t.push(l));return o(),t}const k=(e,t)=>{const i=new r.diff_match_patch,n=i.patch_make(t),[a]=i.patch_apply(n,e);return a};var x;!function(e){let t;e.getDiff=(t,i)=>(0,o.zG)(n.Y3((()=>{if(t===i)return""===t?[]:[[e.Operation.RETAIN,t]];return m(h(t,i))}),n.KC),n.tS((0,o.ls)(a.nI,n.Yo((()=>new Error("Diff is empty")))))),function(e){e[e.DELETE=-1]="DELETE",e[e.RETAIN=0]="RETAIN",e[e.INSERT=1]="INSERT"}(t=e.Operation||(e.Operation={})),e.matchOperation=function({onInsert:e,onDelete:i,onRetain:r}){return n=>{const a=(0,s.li)(n);switch(a){case t.INSERT:return e((0,s.Yg)(n));case t.DELETE:return i((0,s.Yg)(n));case t.RETAIN:return r((0,s.Yg)(n));default:(0,l.vE)(a)}}}}(x||(x={}))},18674:(e,t,i)=>{function r(e){return"selection"===e.kind}function n(e){return"signaling"===e.kind}function a(e){return n(e)||function(e){return"idle"===e.kind}(e)}i.d(t,{WE:()=>a,ZR:()=>s,iu:()=>r,jz:()=>n});const s=-1},14393:(e,t,i)=>{if(i.d(t,{PF:()=>g,TY:()=>d,_V:()=>u,eg:()=>h,f:()=>m,yG:()=>l,yj:()=>c}),3075==i.j)var r=i(59179);if(3075==i.j)var n=i(24666);if(3075==i.j)var a=i(64297);if(3075==i.j)var s=i(5913);if(3075==i.j)var o=i(85763);var l,d,c;function h(e){return(0,o.uz)(e)?l.view:(0,o.lW)(e)?l.history:(0,o.e$)(e)?l.noEditAccess:l.edit}function u(e){return s.S.hz4.pipe((0,r.U)((()=>h(e))),(0,n.x)(((e,t)=>e===t)))}function g(e,t){return e?d.ownDoc:t?d.noEditAccessDoc:d.sharedDoc}function m(e,t,i,r){if(e!==l.edit)return c.read;switch(t){case d.ownDoc:return c.write;case d.noEditAccessDoc:return c.read;case d.sharedDoc:return function(e,t,i){const r=!t&&!i;if(e!==l.edit||r)return c.read;return c.write}(e,i,r);default:return(0,a.L0)(t)}}!function(e){e.view="view",e.noEditAccess="noEditAccess",e.history="history",e.edit="edit"}(l||(l={})),function(e){e[e.ownDoc=0]="ownDoc",e[e.sharedDoc=1]="sharedDoc",e[e.noEditAccessDoc=2]="noEditAccessDoc"}(d||(d={})),function(e){e.read="read",e.write="write"}(c||(c={}))},85763:(e,t,i)=>{if(i.d(t,{LJ:()=>v,Nd:()=>o,Ov:()=>p,TW:()=>b,Ur:()=>l,Xs:()=>_,e$:()=>S,eg:()=>w,fN:()=>h,k6:()=>g,kh:()=>c,lW:()=>f,lz:()=>u,qg:()=>s,uj:()=>a,uz:()=>m}),3075==i.j)var r=i(3601);var n=i(671);function a(e){const t=(0,r.Cq)(e.querySelector(n.XG),"text buffer iframe");return(0,r.Cq)(t.nodeType===Node.ELEMENT_NODE&&"IFRAME"===t.tagName?t.contentDocument:void 0,"text buffer iframe document")}function s(e){const t=o(e);return{width:t?t.offsetWidth-t.clientWidth:0,height:t?t.offsetHeight-t.clientHeight:0}}function o(e){return e.querySelector(n.Wp)}function l(e,t,i){return t?function(e,t){if(t&&d(t))return t;const i=e.querySelectorAll(n.Qy);for(const e of i)if(d(e))return e;return null}(e,i):e.querySelector(n.Qy)}const d=e=>e.checkVisibility?e.checkVisibility():e.parentElement&&"none"!==e.parentElement.style.display;function c(e){return e.querySelectorAll(n.gH)}function h(e){return e.querySelector(n.gH)}function u(e){return Boolean(e.querySelector(n.gH))}function g(e){let t=e.querySelector(n.os);return t||(t=document.querySelector(n.gH)),t?t.getBoundingClientRect():null}const m=e=>!!e.querySelector(n.Lq);function p(e){return e.querySelector(n.$x)}function v(e){return null==e?void 0:e.querySelector(n.y1)}function f(e){const t=e.querySelector(n.f);return!!t&&t.offsetHeight>0}function S(e){return!!e.querySelector(`${n.jW}, ${n.F8}`)}function w(){const e=document.querySelector(n.d0),t=(null==e?void 0:e.classList.contains(n.uj))?"edit":void 0,i=(null==e?void 0:e.classList.contains(n._m))?"suggesting":void 0;return t||i||"other"}function b(e){return e.querySelector(n.QR)}function _(e){return e.querySelector(n.ij)}},671:(e,t,i)=>{i.d(t,{$x:()=>s,F8:()=>p,Go:()=>n,Kt:()=>_,Lq:()=>d,QR:()=>B,Qy:()=>f,Vk:()=>y,Wp:()=>r,XG:()=>a,_m:()=>u,d0:()=>c,f:()=>l,gH:()=>v,gL:()=>C,ij:()=>R,j5:()=>b,jW:()=>m,l$:()=>g,lO:()=>x,os:()=>w,rx:()=>k,uj:()=>h,y1:()=>o,yw:()=>S});const r=".kix-appview-editor",n=".docos-input",a=".docs-texteventtarget-iframe",s=".kix-cursor",o=".kix-cursor-caret",l="#docs-revisions-sidebar",d='#docs-toolbar-mode-switcher[aria-label="Viewing mode"]',c="#docs-toolbar-mode-switcher",h="edit-mode",u="suggest-mode",g="titlebar-mode-indicator-container",m="#titlebar-mode-indicator-container .titlebar-request-access-button",p="#titlebar-mode-indicator-container .kix-titlebar-request-access-button",v="canvas.kix-canvas-tile-content:not(.docs-ui-unprintable *)",f=".kix-rotatingtilemanager:not(.docs-ui-unprintable *)",S=".kix-page-paginated",w=".kix-page-paginated.canvas-first-page",b=".docs-horizontal-ruler",_=".docs-vertical-ruler",y="#fontSizeSelect input",C=".docs-ruler-background",k=".docs-ruler-background-inner",x=".docs-ruler-indent-first-line",R=".modal-dialog.docs-dialog .fatal-error-message",B='#docs-titlebar-share-client-button div[role="button"]'},14698:(e,t,i)=>{i.d(t,{$O:()=>r,Mx:()=>n,RO:()=>a,vW:()=>s});const r=String.fromCharCode(16),n=String.fromCharCode(17),a=String.fromCharCode(18),s=String.fromCharCode(28)},30003:(e,t,i)=>{i.d(t,{b:()=>o});var r=i(32073),n=i(13391),a=i(16582),s=i(82377);class o{constructor(e){this._textObserver=e,this._mapChangedAtom=n.h.create([0,[]]),this._sub=new r.w0,this.highlightsFilterFactory=()=>n.h.combine((0,a.u)(),this._mapChangedAtom,((e,t)=>{const i=this._textObserver.getCurrentTextMap();return{filter:t=>e.filter(t)&&(null!==i.getFragmentAtOffset(t.start)||null!==i.getFragmentAtOffset(t.end)||null!==i.getFragmentAtOffset(t.end-1)),type:s.qH.ChangeType.preserve}})),this._sub.add(this._textObserver.textMapChanged.subscribe((e=>{this._mapChangedAtom.modify((([t,i])=>[t+1,e]))})))}dispose(){this._sub.unsubscribe()}}},65806:(e,t,i)=>{function r(e){return e}function n(e){return e}i.d(t,{Gk:()=>n,Ly:()=>r,Xo:()=>a,bn:()=>u,pl:()=>l});class a{constructor(e){const t=function(e){const{fullText:t,nonTextEntities:i,textSelectionRanges:r,deleteSuggestionRanges:n}=e,a=new Set;let l=t;for(const e of i.inline_image.startsAt)l=l.slice(0,e)+o+l.slice(e+1);for(const e of i.horizontal_rule.startsAt)a.add(e),l=l.slice(0,e)+" "+l.slice(e+1);""===t[0]&&a.add(0);t.replace(s,((e,t)=>(a.add(t),"")));for(const e of function*(e){const t=String.fromCodePoint(60419),i=String.fromCodePoint(60418);for(const r of h(e,t,i))yield r}(t))a.add(e);for(const e of function*(e){for(const t of h(e,d,c))e[t]!==d&&(yield t)}(t))a.add(e);const u=null==r?void 0:r.map((e=>({start:e.start,end:e.end+1})));if(n)for(const{start:e,end:t}of n)for(let i=e;i<t;i++)a.add(i);const g=l.indexOf("",1),m=g>0?l.slice(0,g):l,p=m.length-1;"\n"===m[p]&&a.add(p);return{checkableText:m.split("").filter(((e,t)=>!a.has(t))).join(""),cleanedFullText:l,removedIndices:a,cleanedTextSelectionRanges:u}}(e);this._text=t.checkableText,this._fullText=e.fullText,this._linkInfoList=e.linkInfoList,this._cleanedFullText=t.cleanedFullText,this._ignoredIndices=t.removedIndices,this._textSelectionRanges=t.cleanedTextSelectionRanges}get checkableText(){return this._text}get fullText(){return this._fullText}get cleanedFullText(){return this._cleanedFullText}get linkInfoList(){return this._linkInfoList}get textSelectionRanges(){return this._textSelectionRanges}indexIsIgnored(e){return!!this._ignoredIndices.has(e)}getFullTextIndex(e){let t=-1,i=-1;for(;i<e;)t++,this._ignoredIndices.has(t)||i++;return t}getCheckableTextIndex(e){let t=0,i=0;for(;t<e;)this._ignoredIndices.has(t)||i++,t++;return i}}const s=new RegExp(`${String.fromCodePoint(61439)}|${String.fromCodePoint(61438)}`,"g"),o=String.fromCharCode(160),l=26,d=String.fromCodePoint(l),c=String.fromCodePoint(30);function*h(e,t,i){let r=0;for(;;){const n=e.indexOf(t,r);if(n<r)return;const a=e.indexOf(i,n);for(let e=n;e<=a;e++)yield e;r=a+1}}function u(e){return!!(null==e?void 0:e.includes(d))&&!(null==e?void 0:e.includes(`${d}${c}`))}},66476:(e,t,i)=>{i.d(t,{U3:()=>r,dk:()=>a,x:()=>n});const r=["rgba(17,85,204,1)","#1155cc"],n=1,a=-1},65006:(e,t,i)=>{i.d(t,{M:()=>r});class r{constructor(e,t){this._page=e,this._parsedFragment=t,this.startOffset=t.textRange.start,this.endOffset=t.textRange.end}getPage(){return this._page}}},7936:(e,t,i)=>{i.d(t,{I:()=>s});var r=i(66476),n=i(93001),a=i(65006);class s extends a.M{constructor(e,t,i){super(e,t),this._page=e,this._renderGeometry=i}getFragmentInnerRect(e,t){return this._renderGeometry.getTextFragmentDimensions(this._parsedFragment.fragment,e,t)}getLeftBorder(){return this.getFragmentInnerRect(0,0)}getRightBorder(){return this.getFragmentInnerRect(this.endOffset-this.startOffset,this.endOffset-this.startOffset)}getStyle(){const{style:e="none",color:t="none",underlineColor:i="none",strikeThroughColor:a="none",text:s}=this._parsedFragment.fragment,o=r.U3.includes(t)&&r.U3.includes(i),l=(0,n.cX)(s);return{style:e,isLink:o,isSmartChips:this._parsedFragment.fragment.special,canBeFootnote:l,color:t,underlineColor:i,strikeThroughColor:a}}getParsedFragment(){return this._parsedFragment}}},93001:(e,t,i)=>{i.d(t,{cX:()=>v,ds:()=>l,kn:()=>d,lO:()=>m,nn:()=>p,qH:()=>o,tZ:()=>f});var r=i(42671);const n=/[ \n\r\t\v]/,a=/[^\S\f\n]/,s=[..." \r\t\v\f"];function o(e){return 1===e.length&&n.test(e)}function l(e){return 1===e.length&&a.test(e)}function d(e){return s.includes(e)}const c=/^(\d{1,4}\.)*\d{1,4}$/,h=/^([a-zA-Z])\1{0,3}$/,u=/^m{0,4}(cm|cd|d?c{0,3})(xc|xl|l?x{0,3})(ix|iv|v?i{0,3})$/,g=/^M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3})$/;function m(e){if(0===e.length)return!1;if(1===e.length)return!0;let t;if(e.startsWith("(")&&e.endsWith(")"))t=e.substring(1,e.length-1);else{if(!e.endsWith(".")&&!e.endsWith(")"))return!1;t=e.substring(0,e.length-1)}return t.endsWith(".")&&(t=t.substring(0,t.length-1)),c.test(t)||h.test(t)||u.test(t)||g.test(t)}function p(e){return r.v1.test(e)}function v(e){return r.ZS.test(e)}function f(e){return r.Dn.includes(e)}},42671:(e,t,i)=>{if(i.d(t,{Dn:()=>s,Ox:()=>c,ZS:()=>d,o2:()=>a,q4:()=>h,ui:()=>o,v1:()=>l}),3075==i.j)var r=i(14698);var n=i(65806);const a=String.fromCodePoint(59657),s=[59653,59654,59657,60417,60416,59656,n.pl].map((e=>String.fromCodePoint(e))).join(""),o=String.fromCodePoint(59649),l=/^\d+$/,d=/^\d+$/;function c(e){return e.toUpperCase()===e&&e.toLowerCase()!==e}function h(e){return e.includes(r.$O)}},30069:(e,t,i)=>{i.d(t,{z:()=>g});var r=i(90023),n=i(49231),a=i(22299),s=i(47387),o=i(59179),l=i(84308),d=i(29479),c=i(64271),h=i(18827),u=i(58303);const g=({children:e,animationDurationMs:t,...i})=>{const{onMount:g,rect:m}=a.P.useRectWatcher(),p=m.pipe(o.U((0,r.ls)(u.UI((e=>e.height)),u.fS((()=>0))))),v=l.a([e,m]).pipe(d.h("hidden")),f=c.T(v,v.pipe(h.g(t),d.h("visible")));return n.createElement(s.F.div,{...i,style:{height:p,overflow:f,transitionProperty:"height",transitionDuration:`${t}ms`}},n.createElement(s.F.div,{mount:g},e))}},15173:(e,t,i)=>{i.d(t,{J:()=>c});var r=i(90023),n=i(49231),a=i(22299),s=i(37213),o=i(68340),l=i(63532),d=i(22223);const c=({onChange:e,labelId:t,className:i,checkboxClassName:c,labelClassName:h,checked:u,children:g,disabled:m,useDS:p,dataGrammarlyPart:v="ui-kit-checkbox",tabIndex:f=0,onMount:S=r.Q1})=>{const[w,b]=n.useState(null!=u&&u);n.useEffect((()=>{b(Boolean(u))}),[u]);const _=t=>{t.preventDefault(),t.stopPropagation(),b(!w),null==e||e(!w)},{ref:y,onMount:C}=a.P.useElWatcher();return n.useEffect((()=>{const e=y.pipe(o.oA,l.b(S)).subscribe();return()=>e.unsubscribe()}),[]),n.createElement("div",{"data-grammarly-part":v,...(0,s.Sh)(d.checkboxContainer,i)},n.createElement("div",{...(0,s.Sh)(d.checkbox,c,w?d.checkboxChecked:null,p?d.checkboxDS:null),role:"checkbox","aria-checked":w,tabIndex:f,"aria-labelledby":t,onKeyDown:e=>{" "===e.key&&_(e)},onClick:m?r.Q1:_,ref:C},w?n.createElement("div",{className:d.checkboxCheckmark}):null),n.createElement("label",{id:t,onClick:_,className:h},g))}},45649:(e,t,i)=>{i.d(t,{z:()=>u});var r=i(49231),n=i(64151);const a=({children:e,style:t,dataGrammarlyPart:i="ui-kit-iframe",...a})=>{const[s,o]=r.useState(null),l=r.useCallback((e=>{var t,i;let r=null;"contentDocument"in e.target&&(r=null!==(i=null===(t=e.target.contentDocument)||void 0===t?void 0:t.body)&&void 0!==i?i:null),o(r),r&&(r.style.margin="0",r.style.height="100vh",r.style.overflowY="hidden")}),[]);return r.createElement("iframe",{...a,style:{border:"none",...t},onLoad:l,srcDoc:"<html><body></body></html>","data-grammarly-part":i},s&&(0,n.createPortal)(e,s))};var s=i(40722),o=i(95804),l=i(75558),d=i(14720),c=i.n(d);const h=({placeholder:e,ariaLabel:t,onChange:i})=>{const[n,a]=r.useState("");return r.useEffect((()=>{i(n)}),[n]),r.createElement(r.Fragment,null,r.createElement(s.b,null,c().__css),r.createElement("div",{role:"textbox",className:c().textBox,contentEditable:!0,onInput:e=>{a(e.target.innerText)},"data-placeholder":e,"aria-placeholder":e,"aria-label":t}))},u=({placeholder:e,onChange:t,ariaLabel:i,iframeTitle:n,className:s})=>(0,l.OB)().experimentClient.isGateEnabled(o.K.CentralizeStopEventPropagation)?r.createElement("div",{className:s,style:{width:"100%",height:"128px",maxHeight:"inherit"}},r.createElement(h,{onChange:t,ariaLabel:i,placeholder:e})):r.createElement(a,{dataGrammarlyPart:"ui-kit-textbox",className:s,style:{width:"100%",height:"100%"},title:n},r.createElement(h,{onChange:t,ariaLabel:i,placeholder:e}))},90616:(e,t,i)=>{i.d(t,{q:()=>k});var r=i(49231),n=i(37213),a=i(45649),s=i(37540),o=i(15173),l=i(57766);const d=e=>e.domain?r.createElement(r.Fragment,null,e.withHelpText&&r.createElement("div",{className:l.feedbackFormShareDomainTitle},"Help improve Grammarly by sharing the domain youre on:"),r.createElement(o.J,{checked:e.checked,labelId:"feedback-form-share-domain-checkbox",onChange:e.onChange,className:l.feedbackFormShareDomainCheckbox},"Include the domain ",r.createElement("b",null,e.domain)," with my feedback")):null;var c=i(92975);const h=e=>e.isEnabled?r.createElement(c.T,{type:"mini",size:26,className:l.feedbackFormLogoLine}):null,u=e=>{var t;if(!e.isEnabled)return null;const i=null!==(t=e.title)&&void 0!==t?t:r.createElement("span",null,"How do you like ",r.createElement("br",null)," Grammarly?");return r.createElement("h3",{...(0,n.Sh)(l.feedbackFormTitle,e.isCompact&&l.compact)},i)},g=e=>r.createElement(r.Fragment,null,r.createElement(o.J,{checked:e.checked,labelId:"feedback-form-share-user-text-checkbox",onChange:e.onChange,className:l.feedbackFormShareUserTextCheckbox},r.createElement("p",null,"Share my text with Grammarly")),r.createElement("p",{className:l.fedbackFormShareUserTextCheckboxLabel},"The text you checked with Grammarly will also be shared to improve the quality of our suggestions. Your feedback and text will not be associated with your account and will be deleted within 100 days. We will not use your feedback to train any models."));var m=i(17230);const p=({options:e,onChange:t=(()=>null),ariaLabel:i,className:a})=>{const s=[],[o,l]=r.useState(null);r.useEffect((()=>{var i;null!==o&&(null===(i=s[o])||void 0===i||i.focus()),t(null!==o?e[o].value:null)}),[o]);const d=null!==o?e[o]:null;return r.createElement("div",{"data-grammarly-part":"ui-kit-radio-group",className:a},r.createElement("div",{className:m.radioGroup,role:"radiogroup","aria-label":i,onKeyDown:t=>{if(" "!==t.key||d){if("ArrowRight"===t.key||"ArrowDown"===t.key){t.preventDefault(),t.stopPropagation();l(((o||0)+1)%e.length)}else if("ArrowLeft"===t.key||"ArrowUp"===t.key){t.preventDefault(),t.stopPropagation();const i=(o||0)-1;l(i<0?e.length-1:i)}}else t.preventDefault(),t.stopPropagation(),l(0)}},e.map(((e,t)=>{const i=(null==d?void 0:d.value)===e.value,a=0===t;return r.createElement("div",{key:e.value,...(0,n.Sh)(m.radioGroupOption,i?m.radioGroupOptionSelected:null),role:"radio",tabIndex:i||a&&!d?0:-1,"aria-checked":i,onClick:e=>{e.preventDefault(),e.stopPropagation(),l(t)},ref:e=>s.push(e)},e.render())}))))};var v,f=i(88305),S=i(73303);!function(e){e.bad="bad",e.ok="ok",e.good="good"}(v||(v={}));const w=e=>{const t=[v.bad,v.ok,v.good];return e.isEnabled?r.createElement(r.Fragment,null,r.createElement(p,{ariaLabel:"Feedback Score",options:t.map((e=>({value:e,render:()=>r.createElement("div",{className:S.feedbackFormOption},r.createElement("div",{...(0,n.Sh)(S.feedbackFormOptionIcon,b(e))}),r.createElement("div",null,function(e){switch(e){case v.bad:return"I dislike it";case v.ok:return"Its OK";case v.good:return"I like it";default:(0,f.vE)(e)}}(e)))}))),onChange:e.onChange,...(0,n.Sh)(l.feedbackFormScore,e.compactDisplay&&l.compact)}),!e.hideTextBoxTitle&&r.createElement("div",{className:l.feedbackFormTextBoxTitle},"Anything we can improve?")):null};function b(e){switch(e){case v.bad:return S.feedbackFormOptionIconDisheartening;case v.ok:return S.feedbackFormOptionIconNeutral;case v.good:return S.feedbackFormOptionIconSmiling;default:(0,f.vE)(e)}}const _=e=>{var t,i,o;const[c,m]=r.useState(null),[p,v]=r.useState(""),[f,S]=r.useState(null!==(t=e.domainSharedByDefault)&&void 0!==t&&t),[b,_]=r.useState(!1);return r.createElement("form",{"data-grammarly-part":"surveys-feedback-form-fields",...(0,n.Sh)(l.feedbackFormContainer,"center"===e.align&&l.feedbackFormContainerAlignCenter,e.fixSubmitButtonOverflowBottomPadding&&l.feedbackFormContainerBottomPadding)},r.createElement("div",{className:l.feedbackFormFields},r.createElement(h,{isEnabled:!e.hideLogo}),r.createElement(u,{isEnabled:!e.hideTitle,title:e.title,isCompact:null!==(i=e.compactDisplay)&&void 0!==i&&i}),r.createElement(w,{isEnabled:e.withScore,compactDisplay:e.compactDisplay,hideTextBoxTitle:e.hideTextBoxTitle,onChange:m}),r.createElement(a.z,{onChange:v,placeholder:null!==(o=e.placeholderText)&&void 0!==o?o:"Your thoughts here",ariaLabel:"Feedback Text",iframeTitle:"Feedback text field",...(0,n.Sh)(l.feedbackFormTextBox,e.compactDisplay&&l.compact)}),r.createElement(d,{domain:e.domain,checked:e.domainSharedByDefault,withHelpText:!e.hideDomainHelpText,onChange:S}),e.showShareTextCheckbox&&r.createElement(g,{checked:b,onChange:_})),r.createElement(s.z,{type:"submit",onClick:t=>{t.preventDefault();const i=f?e.domain:void 0;e.withScore&&c?e.onSubmit({score:c,text:p,domain:i,shareUserText:b}):!e.withScore&&p&&e.onSubmit({text:p,domain:i,shareUserText:b})},disabled:e.withScore?!c:!p,width:"full","data-grammarly-part":"surveys-feedback-form-submit-button"},"Submit"))},y=e=>r.createElement("div",{"data-grammarly-part":"surveys-feedback-form-thank-you",...(0,n.Sh)(l.feedbackFormContainer,l.feedbackFormContainerAlignCenter,e.fixSubmitButtonOverflowBottomPadding&&l.feedbackFormContainerBottomPadding)},r.createElement("div",{className:l.feedbackFormSuccessMessageTextContainer},r.createElement("div",{className:l.feedbackFormSuccessMessageIcon}),r.createElement("div",{className:l.feedbackFormSuccessMessageTitle},"Thank you!"),r.createElement("div",{className:l.feedbackFormSuccessMessageSubtitle},"Your feedback helps us improve.")),r.createElement(s.z,{onClick:e.onClose,width:"full"},"Done"));var C=i(26954);const k=({hideLogo:e=!1,align:t="center",fixSubmitButtonOverflowBottomPadding:i=!1,showPostSubmitScreen:n=!0,...a})=>{const[s,o]=r.useState(!1),l=s&&n;return r.createElement("div",{style:a.style,"data-grammarly-part":"surveys-feedback-form",role:"region","aria-label":"Provide feedback","aria-live":"polite"},l?r.createElement(y,{fixSubmitButtonOverflowBottomPadding:i,onClose:a.onClose}):r.createElement(_,{...a,hideLogo:e,align:t,fixSubmitButtonOverflowBottomPadding:i,onSubmit:e=>{a.withScore?((0,C.n8)(e),a.onSubmit(e)):((0,C.TY)(e),a.onSubmit(e)),o(!0)}}))}},26954:(e,t,i)=>{function r(e){return"score"in e}function n(e){if(!r(e))throw new Error("Received unexpected feedback form data without score")}function a(e){if(r(e))throw new Error("Received unexpected feedback form data with score")}i.d(t,{TY:()=>a,dK:()=>r,n8:()=>n})},79749:(e,t,i)=>{i.d(t,{JB:()=>a,MY:()=>n,z6:()=>r});class r extends Map{constructor(e){super(),this.maxSize=e}set(e,t){if(this.has(e))this.delete(e);else if(this.size>=this.maxSize){const e=this.keys().next(void 0).value;this.delete(e)}return super.set(e,t),this}get(e){const t=super.get(e);return void 0!==t&&(this.delete(e),this.set(e,t)),t}}function n(e){let t=2166136261;for(let i=0;i<e.length;i++)t^=e.charCodeAt(i),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return(t>>>0).toString(16)}function a(e){try{return n(JSON.stringify(e))}catch(e){return console.error("Error occurred while hashing object:",e),""}}},6622:(e,t,i)=>{i.d(t,{Sz:()=>a,vQ:()=>n});var r=i(12518);async function n(e,t=self){if(function(e=self){var t,i;return!!(null===(i=null===(t=e.navigator)||void 0===t?void 0:t.clipboard)||void 0===i?void 0:i.writeText)}(t))return t.navigator.clipboard.writeText(e);throw new Error("Clipboard API not supported")}function a(e,t=self){return n(e,t).then((()=>r.F2(void 0))).catch((e=>r.t$(e instanceof Error?e:new Error(String(e)))))}},16779:(e,t,i)=>{function r(e,t=0){return(t<<5)-t+(0|e)|0}function n(e,t=0){let i=t;for(const t of e)i=r(t.charCodeAt(0),i);return i}i.d(t,{Wu:()=>n,k3:()=>r})},76356:(e,t,i)=>{var r=i(42663),n=i(2963)(r);n.push([e.id,"._z3YOv-textBox{font-family:Inter,sans-serif;font-style:normal;font-weight:normal;color:#0e101a;font-size:14px;line-height:21px;-webkit-font-feature-settings:'ss03' on;font-feature-settings:'ss03' on;background:#f9faff;border:1px solid #e7e9f5;-webkit-box-sizing:border-box;box-sizing:border-box;border-radius:4px;padding:10px 8px;overflow-y:auto;cursor:text;width:100%;height:100%;}._z3YOv-textBox:empty:before{-webkit-font-feature-settings:'ss03' on;font-feature-settings:'ss03' on;font-family:Inter,sans-serif;font-style:normal;font-weight:normal;color:#6d758d;font-size:14px;line-height:21px;content:attr(data-placeholder)}",""]),n.locals={textBox:"_z3YOv-textBox"},e.exports=n},15420:e=>{e.exports={monetizationWrapper:"XLKBt",premiumIcon:"Mrvu1",monetizationTitle:"vLnAx",monetizationDividerDot:"_owGm"}},37036:e=>{e.exports={FtuxTooltipOutline:"vAmKA",FtuxTooltipContent:"_KM0Q"}},22266:e=>{e.exports={sideline:"G2vdT",sidelineEmphasized:"tw3gA",sidelineWithSelectionSignal:"ikZS7",pulsingSideline:"SHHbX",pulsingSignalingSideline:"YQDXi",sidelineSignalBarAttention:"xQocX","pulse-signaling":"mdD96",sidelineSignalBarAttentionUphook:"mjKDg","pulse-signaling-uphook":"su9q0",pulsingIdleSideline:"w6AcK","pulse-idle":"caBIF",pulsingSelectionSideline:"ETZAk","pulse-selection":"HP0j5",sidelineWithSignalBar:"gtUhG",sidelineSignalBar:"Pdlcn",sidelineSignalBarLoading:"ZhtAx",pulse:"PEPt4",sidelineSignalBarEmphasized:"_mi1U",sidelineSignalBarHidden:"BNKg6",sidelineSignalBarSubdued:"n9hN9",sidelineIdle:"ODKEt",sidelineIdleOutsideSafeArea:"w4UDM",sidelineIdleSafeArea:"VPslK",sidelineIdleHover:"vZ2y1",expandingIdleSideline:"Ld2yt",sidelineIdlePinned:"LBn82",sidelineIdleStaticEmphasized:"dQCFf",sidelineArrow:"Ihuz1",sidelineArrowVisible:"gtlTF",sidelineArrowVisibleIdle:"t5crG",sidelineArrowPinnedIdle:"kYVyH",sidelineArrowVisibleIdleStatic:"MUK0S",sidelineArrowBottom:"PPzfY"}},38215:e=>{e.exports={sidelineParagraphHighlighter:"xCgoK",sidelineParagraphHighlighterActive:"Jjjhn",sidelinePositioner:"UPQQM",sidelineSelectionHighlight:"ra9fc"}},24969:e=>{e.exports={sidelineCard:"KetZV",sidelineCardHorizontalDivider:"d96oB",sidelineCardCustomPromptEntryPoint:"USGAc",sidelineCardFtuxRewrites:"MsQEb",sidelineCardFtuxCustomPromptEntryPoint:"AHauo",a11yDescription:"ZxLNa"}},29804:e=>{e.exports={sidelineCardButton:"qFbmx"}},70279:e=>{e.exports={sidelineCardCustomPrompt:"LfX1e",sidelineCardCustomPromptInput:"RoTP_",sidelineCardCustomPromptInputForm:"B0peX",sidelineCardCustomPromptInputField:"SLnHC",sidelineCardCustomPromptSuggestedResults:"o_ldN",sidelineCardCustomPromptSuggestedResultsSubtitle:"eezEJ",sidelineCardCustomPromptSuggestedResultsOption:"FmvTD",liveAnnouncement:"_BxQw"}},62984:e=>{e.exports={sidelineCardGrammarlyLogo:"e99eq"}},6673:e=>{e.exports={sidelineCardPopper:"m2vlI"}},45678:e=>{e.exports={revertibleRewriteDiff:"t8Lqn",revertibleRewriteDiffLabel:"sJCmZ",revertibleRewriteDiffButton:"XEa8T",revertibleRewriteDiffOutlineOnboarding:"ZDo7f",alternateStroke:"p2gID"}},55367:e=>{e.exports={svg:"n2czM",path:"jGWBV"}},89505:e=>{e.exports={sidelineCardRewrite:"SbBwe"}},73352:e=>{e.exports={sidelineCardRewriteDiff:"HQ1NZ",sidelineCardRewriteDiffBlurred:"etBs4",sidelineCardRewriteDiffRevertButton:"ss_Es",sidelineCardRewriteDiffPopoverWrapper:"b8bPK"}},74399:e=>{e.exports={scrollTopLimit:"PA1jn",scrollBottomLimit:"vhiR2",fadeInAnimation:"o53qS","left-to-right-fade-in":"OpP5u"}},84135:e=>{e.exports={moreButton:"rosQY"}},45954:e=>{e.exports={sidelineCardRewriteReadySignalBar:"zv_Ws",sidelineCardRewriteReadySignalBarAttention:"oimfv",sidelineCardRewriteReadySignalBarDefault:"GGpaV",sidelineCardRewriteReadyContent:"ANoVu",sidelineCardRewriteReadyContentWithTopScrollLimit:"M7jcz",sidelineCardRewriteReadyContentWithBottomScrollLimit:"SDH6l",sidelineCardRewriteReadyContentTitle:"JruGr",sidelineCardRewriteReadyContentTitleAttention:"ncGgB",sidelineCardRewriteReadyContentTitleDefault:"FKJEV",sidelineCardRewriteRegenerateButton:"As2d2",sidelineCardRewriteCopyButtonCopyConfirmation:"oM9oh",fadeInOut:"uUL1Y"}},77534:e=>{e.exports={sidelineCardRewriteSuccess:"qCfRi",sidelineCardRewriteSuccessMainContentTitle:"KYYEg",sidelineCardRewriteSuccessGrammarlyLogo:"PWfBY"}},22223:e=>{e.exports={checkboxContainer:"Te37e",checkbox:"mFHkX",checkboxDS:"DdH2q",checkboxChecked:"JhHnz",checkboxCheckmark:"zShXt",spin:"tww6q"}},17230:e=>{e.exports={radioGroup:"KAzfW",radioGroupOption:"WkjDU",radioGroupOptionSelected:"onilo"}},57766:e=>{e.exports={feedbackFormContainer:"kjElf",feedbackFormContainerBottomPadding:"bXqDs",feedbackFormContainerAlignCenter:"hkEx2",feedbackFormFields:"Ua5wJ",feedbackFormTitle:"GnQ_a",feedbackFormTextBoxTitle:"kWEW0",feedbackFormLogoLine:"osGQI",compact:"b7yYp",feedbackFormScore:"ZOSRK",feedbackFormTextBox:"l8New",feedbackFormShareDomainTitle:"Qbnj_",feedbackFormShareDomainCheckbox:"VBCx1",feedbackFormShareUserTextCheckbox:"abP8L",fedbackFormShareUserTextCheckboxLabel:"hxgnL",feedbackFormSuccessMessageTextContainer:"ARBzt",feedbackFormSuccessMessageIcon:"kJIzg",feedbackFormSuccessMessageTitle:"iXQnf",feedbackFormSuccessMessageSubtitle:"Ydufo",spin:"Vv6WG"}},73303:e=>{e.exports={feedbackFormOption:"sp8vS",feedbackFormOptionIcon:"eH6DL",feedbackFormOptionIconDisheartening:"DhaWh",feedbackFormOptionIconNeutral:"BS_8d",feedbackFormOptionIconSmiling:"dUZNd",spin:"uouSO"}}}]);